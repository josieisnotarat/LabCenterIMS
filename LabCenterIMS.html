<!-- ----------------------------------------------------------------------------
  Name: Lab Center IMS Team
  Class: Web Dev / HTML
  Abstract: Administrative interface for Lab Center inventory and service flows.
----------------------------------------------------------------------------- -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lab Center IMS — Desktop UI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* -----------------------------------------------------------------------------
         Name: Lab Center IMS Team
         Class: Web Dev / CSS
         Abstract: Styling tokens, layout, and components for Lab Center IMS UI.
      ----------------------------------------------------------------------------- */
      :root {
        --bg: #ffffff;
        --surface: #f7f8f8;
        --ink: #0b0f0e;
        --muted: #6b7280;
        --line: #e5e7eb;

        /* Brand accents (updated) */
        --brand: #448c37; /* accent green */
        --brand-weak: #e6f3e3; /* soft bg for brand states */

        /* Status palette (consistent everywhere) */
        --ok-bg: var(--brand-weak);
        --ok-fg: var(--brand);
        --overdue-bg: #fee2e2;
        --overdue-fg: #b91c1c;
        --repair-bg: #fef3c7;
        --repair-fg: #92400e;
        --diagnosing-bg: #fff6e6;
        --diagnosing-fg: #b45309;
        --returned-bg: #ecfdf5;
        --returned-fg: #065f46;
        --ready-bg: #ecfdf5;
        --ready-fg: #065f46;
        --quarantine-bg: #ede9fe;
        --quarantine-fg: #5b21b6;
        --completed-bg: #e6f3e3;
        --completed-fg: #166534;
        --cancelled-bg: #f3f4f6;
        --cancelled-fg: #374151;

        --radius: 12px;
        --shadow: 0 1px 2px rgba(0, 0, 0, 0.06), 0 8px 24px rgba(0, 0, 0, 0.06);

        /* Modal vars */
        --modal-backdrop: rgba(0, 0, 0, 0.36);
        --focus: #2563eb;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        min-width: 1200px;
      }
      body {
        margin: 0;
        background: var(--surface);
        color: var(--ink);
        font-family: Inter, system-ui, Arial, sans-serif;
        display: grid;
        grid-template-rows: auto 1fr;
        overflow: hidden;
      }

      body:not(.authenticated) > :not(#login-screen):not(script) {
        display: none;
      }

      #login-screen {
        position: fixed;
        inset: 0;
        background: var(--surface);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 24px;
        overflow: auto;
      }

      body.authenticated #login-screen {
        display: none;
      }

      .login-panel {
        width: min(420px, 100%);
        background: var(--bg);
        border-radius: var(--radius);
        border: 1px solid var(--line);
        box-shadow: var(--shadow);
        padding: 32px;
        display: grid;
        gap: 18px;
      }

      .login-header h1 {
        margin: 0 0 6px;
        font-size: 22px;
      }

      .login-header p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
        line-height: 1.5;
      }

      .login-field {
        display: grid;
        gap: 6px;
      }

      .login-field label {
        font-weight: 600;
        font-size: 14px;
      }

      .login-field input {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--line);
        font-size: 15px;
      }

      .login-field input:focus-visible {
        outline: 2px solid var(--focus);
        outline-offset: 2px;
      }

      .login-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }

      .login-error {
        color: var(--overdue-fg);
        font-size: 14px;
        min-height: 18px;
      }

      .btn-ghost {
        background: transparent;
        border-color: transparent;
        color: var(--muted);
      }

      .btn-ghost:hover {
        background: rgba(17, 24, 39, 0.04);
      }

      .user-chip {
        background: var(--surface);
        border: 1px solid var(--line);
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 13px;
        color: var(--muted);
      }

      /* Header (fixed) */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        padding: 14px 18px;
        background: var(--bg);
        border-bottom: 1px solid var(--line);
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .title {
        font-weight: 700;
      }
      .hdr-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo {
        height: 24px;
        width: auto;
        display: block;
      }

      /* App shell */
      .shell {
        display: grid;
        grid-template-columns: 260px minmax(0, 1fr);
        height: 100%;
        min-height: 0;
        width: 100%;
        overflow: hidden;
      }
      aside {
        background: var(--bg);
        border-right: 1px solid var(--line);
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        height: 100%;
        overflow: hidden;
        position: sticky;
        top: 56px;
        align-self: start;
      }
      main {
        min-width: 0;
        padding: 18px;
        height: 100%;
        overflow: auto;
      }

      /* Sidebar */
      .nav-title {
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.12em;
        margin: 10px 0 6px;
      }
      nav {
        display: grid;
        gap: 8px;
      }
      .nav-link {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        color: #111827;
        text-decoration: none;
        border: 1px solid transparent;
        user-select: none;
        transition:
          background 0.15s ease,
          border-color 0.15s ease,
          transform 0.02s ease;
      }
      .nav-link:hover {
        background: var(--surface);
        border-color: var(--line);
      }
      .nav-link:focus-visible {
        outline: 2px solid var(--focus);
        outline-offset: 2px;
      }
      .nav-link:active {
        transform: translateY(1px);
      }
      .nav-sep {
        height: 1px;
        background: var(--line);
        margin: 10px 0;
      }
      .push-bottom {
        margin-top: auto;
      }

      /* Active link */
      body:has(#home.screen:target) .nav-link[href="#home"],
      body:not(:has(.screen:target)) .nav-link[href="#home"] {
        background: var(--surface);
        border-color: var(--line);
      }
      body:has(#borrowing.screen:target) .nav-link[href="#borrowing"] {
        background: var(--surface);
        border-color: var(--line);
      }
      body:has(#service.screen:target) .nav-link[href="#service"] {
        background: var(--surface);
        border-color: var(--line);
      }
      body:has(#admin-action-log.screen:target)
        .nav-link[href="#admin-action-log"],
      body:has(#admin-customers.screen:target)
        .nav-link[href="#admin-customers"],
      body:has(#admin-users.screen:target) .nav-link[href="#admin-users"],
      body:has(#admin-inventory.screen:target)
        .nav-link[href="#admin-inventory"] {
        background: var(--surface);
        border-color: var(--line);
      }

      /* Screens (router) */
      .screen {
        display: none;
      }
      .screen:target {
        display: block;
      }
      #home.screen {
        display: block;
      }
      body:has(.screen:target:not(#home)) #home {
        display: none;
      }

      body:not(.is-admin) .admin-only {
        display: none !important;
      }


      .wrapper {
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Cards / grid */
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
      }
      .card {
        background: var(--bg);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .card h2 {
        font-size: 16px;
        margin: 0;
        padding: 12px 14px;
        border-bottom: 1px solid var(--line);
      }
      .card .body {
        padding: 14px;
      }

      /* stat chips */
      .stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }
      .stat {
        background: var(--bg);
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 12px;
      }
      .stat .label {
        font-size: 12px;
        color: var(--muted);
      }
      .stat .value {
        font-weight: 700;
        font-size: 20px;
      }

      /* universal pills */
      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        border: 1px solid transparent;
        white-space: nowrap;
        user-select: none;
      }
      .pill.ok {
        background: var(--ok-bg);
        color: var(--ok-fg);
        border-color: rgba(68, 140, 55, 0.25);
      }
      .pill.overdue {
        background: var(--overdue-bg);
        color: var(--overdue-fg);
        border-color: #fecaca;
      }
      .pill.repair {
        background: var(--repair-bg);
        color: var(--repair-fg);
        border-color: #fde68a;
      }
      .pill.diagnosing {
        background: var(--diagnosing-bg);
        color: var(--diagnosing-fg);
        border-color: #fcd9a9;
      }
      .pill.returned {
        background: var(--returned-bg);
        color: var(--returned-fg);
        border-color: #a7f3d0;
      }
      .pill.ready {
        background: var(--ready-bg);
        color: var(--ready-fg);
        border-color: #a7f3d0;
      }
      .pill.quarantine {
        background: var(--quarantine-bg);
        color: var(--quarantine-fg);
        border-color: rgba(91, 33, 182, 0.25);
      }
      .pill.completed {
        background: var(--completed-bg);
        color: var(--completed-fg);
        border-color: rgba(68, 140, 55, 0.25);
      }
      .pill.cancelled {
        background: var(--cancelled-bg);
        color: var(--cancelled-fg);
        border-color: rgba(55, 65, 81, 0.18);
      }

      /* table */
      .table {
        overflow: hidden;
        border-radius: var(--radius);
        border: 1px solid var(--line);
        background: var(--bg);
      }
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 14px;
      }
      thead th {
        background: var(--surface);
        text-align: left;
        padding: 10px 12px;
        color: var(--muted);
        border-bottom: 1px solid var(--line);
      }
      tbody td {
        padding: 12px;
        border-bottom: 1px solid var(--line);
        vertical-align: top;
      }
      tr.clickable {
        cursor: pointer;
      }
      tr.clickable:hover {
        background: rgba(17, 24, 39, 0.04);
      }

      /* consistent row emphasis */
      tr.is-overdue {
        background: #fff7f7;
      }
      tr.is-awaiting {
        background: #fffbeb;
      }
      tr.is-ready {
        background: #f0fdf4;
      }

      /* form bits */
      .toolbar {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 12px;
      }
      .search {
        display: flex;
        align-items: center;
        gap: 10px;
        background: var(--bg);
        border: 1px solid var(--line);
        padding: 8px 10px;
        border-radius: 10px;
        flex: 1 1 320px;
      }
      .search input {
        border: 0;
        outline: 0;
        background: transparent;
        width: 100%;
      }
      .btn {
        border: 1px solid var(--line);
        background: var(--bg);
        padding: 8px 10px;
        border-radius: 10px;
        font-weight: 600;
        text-decoration: none;
        color: var(--ink);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        user-select: none;
        transition:
          transform 0.02s ease,
          background 0.15s ease,
          border-color 0.15s ease,
          opacity 0.15s ease;
        cursor: pointer;
      }
      .btn:hover {
        background: var(--surface);
      }
      .btn:focus-visible {
        outline: 2px solid var(--focus);
        outline-offset: 2px;
      }
      .btn:active {
        transform: translateY(1px);
      }
      .btn[aria-busy="true"] {
        opacity: 0.7;
        pointer-events: none;
      }
      .btn.primary {
        background: var(--brand);
        color: #fff;
        border-color: transparent;
      }
      .btn.primary:hover {
        filter: brightness(0.96);
      }
      .btn.danger {
        background: var(--overdue-bg);
        color: var(--overdue-fg);
        border-color: rgba(185, 28, 28, 0.35);
      }
      .btn.danger:hover {
        filter: brightness(0.98);
      }
      .spinner {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        border: 2px solid #fff;
        border-top-color: transparent;
        display: none;
      }
      .btn[aria-busy="true"] .spinner {
        display: inline-block;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .filters {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .chip {
        border: 1px solid var(--line);
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        background: var(--bg);
        cursor: pointer;
        user-select: none;
      }
      .note-log {
        border: 1px solid var(--line);
        border-radius: 10px;
        background: var(--surface);
        padding: 10px 12px;
        max-height: 220px;
        overflow: auto;
        display: grid;
        gap: 10px;
        font-size: 13px;
      }
      .note-entry {
        display: grid;
        gap: 4px;
        background: var(--bg);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 8px 10px;
      }
      .note-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        color: var(--muted);
      }
      .note-text {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
      }
      .note-empty {
        margin: 0;
        color: var(--muted);
        font-style: italic;
      }
      .chip.active {
        background: var(--brand-weak);
        border-color: rgba(68, 140, 55, 0.35);
        font-weight: 700;
      }
      .profile-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 16px;
      }
      .profile-label {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .profile-value {
        font-weight: 600;
        min-height: 1.4em;
      }
      .alias-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 6px 0 14px;
      }
      .alias-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--surface);
        border: 1px solid var(--line);
        font-size: 13px;
      }
      .alias-chip button {
        border: 0;
        background: transparent;
        color: var(--muted);
        cursor: pointer;
        font-size: 16px;
        line-height: 1;
        padding: 0;
      }
      .alias-chip button:hover {
        color: var(--overdue-fg);
      }
      .alias-chip button:focus-visible {
        outline: 2px solid var(--focus);
        outline-offset: 2px;
        border-radius: 4px;
      }
      .alias-empty {
        margin: 0;
        color: var(--muted);
        font-style: italic;
      }
      .alias-add-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .alias-add-row input {
        flex: 1;
      }

      /* ====== Modals ====== */
      dialog {
        width: 720px;
        max-width: 90vw;
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 0;
        box-shadow: var(--shadow);
        background: var(--bg);
      }
      dialog::backdrop {
        background: var(--modal-backdrop);
      }
      .modal-hd {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px;
        border-bottom: 1px solid var(--line);
      }
      .modal-bd {
        padding: 14px;
      }
      .modal-ft {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        padding: 14px;
        border-top: 1px solid var(--line);
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .form-grid .full {
        grid-column: 1/-1;
      }
      label {
        font-size: 12px;
        color: var(--muted);
        display: block;
        margin-bottom: 6px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: #fff;
        font: inherit;
      }
      input:invalid,
      select:invalid,
      textarea:invalid {
        border-color: #fca5a5;
      }
      textarea {
        min-height: 96px;
        resize: vertical;
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
      }
      .lookup {
        position: relative;
      }
      .lookup-menu {
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + 4px);
        background: var(--bg);
        border: 1px solid var(--line);
        border-radius: 10px;
        box-shadow: var(--shadow);
        padding: 4px 0;
        margin: 0;
        list-style: none;
        max-height: 220px;
        overflow: auto;
        display: none;
        z-index: 40;
      }
      .lookup-menu.show {
        display: block;
      }
      .lookup-item {
        padding: 8px 12px;
        cursor: pointer;
      }
      .lookup-item:hover,
      .lookup-item.active {
        background: var(--surface);
      }
      .lookup-item strong {
        display: block;
        font-weight: 600;
      }
      .lookup-item .sub {
        font-size: 12px;
        color: var(--muted);
      }
      .lookup-empty {
        padding: 8px 12px;
        color: var(--muted);
      }
      .due-preview {
        font-size: 12px;
        color: var(--muted);
        min-height: 18px;
      }
      .due-config {
        display: none;
      }
      .due-config.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="login-screen">
      <form class="login-panel" id="login-form" autocomplete="off">
        <div class="login-header">
          <h1>Sign in to Lab Center IMS</h1>
          <p>
            Enter your lab username and password to continue. Unless it has been
            changed, the default password is <strong>password123</strong>.
          </p>
        </div>
        <div class="login-field">
          <label for="login-username">Username</label>
          <input
            id="login-username"
            name="username"
            type="text"
            autocomplete="username"
            required
          />
        </div>
        <div class="login-field">
          <label for="login-password">Password</label>
          <input
            id="login-password"
            name="password"
            type="password"
            autocomplete="current-password"
            required
          />
        </div>
        <div class="login-error" id="login-error" role="alert"></div>
        <div class="login-actions">
          <button type="submit" class="btn primary" id="login-submit">
            Sign in
          </button>
          <button type="button" class="btn btn-ghost" id="login-reset">
            Reset
          </button>
        </div>
      </form>
    </div>
    <header>
      <div class="brand">
        <img class="logo" src="action_mark_green.avif" alt="Lab Center Logo" />
        <div class="title">Cincinnati State Lab Center — IMS</div>
      </div>
      <div class="hdr-right">
        <div class="user-chip" id="current-user-display" aria-live="polite"></div>
        <button class="btn btn-ghost" id="btn-logout" type="button">
          Sign out
        </button>
        <button class="btn" data-open="dlg-help">
          <span>Quick Help</span>
        </button>
      </div>
    </header>

    <div class="shell">
      <!-- Sidebar -->
      <aside>
        <div class="nav-title">Main</div>
        <nav>
          <a class="nav-link" href="#home">Home</a>
          <a class="nav-link" href="#borrowing">Borrowing</a>
          <a class="nav-link" href="#service">Service Log</a>
        </nav>
        <div class="nav-sep" aria-hidden="true"></div>
        <div class="push-bottom admin-only" id="admin-sidebar">
          <div class="nav-title">Admin</div>
          <nav>
            <a class="nav-link" href="#admin-action-log">Action Log</a>
            <a class="nav-link" href="#admin-customers">Customer Management</a>
            <a class="nav-link" href="#admin-users">User Management</a>
            <a class="nav-link" href="#admin-inventory">Inventory Management</a>
          </nav>
        </div>
      </aside>

      <!-- Content -->
      <main>
        <div class="wrapper">
          <!-- HOME -->
          <section id="home" class="screen" aria-labelledby="home-title">
            <div class="card" style="margin-bottom: 14px">
              <h2 id="home-title">
                Quick Stats
                <span class="pill ok" style="margin-left: 6px">Live</span>
              </h2>
              <div class="body">
                <div class="stats" aria-live="polite">
                  <div class="stat">
                    <div class="label">Checked Out Now</div>
                    <div class="value" data-stat="outNow">27</div>
                  </div>
                  <div class="stat">
                    <div class="label">Due Today</div>
                    <div class="value" data-stat="dueToday">6</div>
                  </div>
                  <div class="stat">
                    <div class="label">In Repairs</div>
                    <div class="value" data-stat="repairs">4</div>
                  </div>
                  <div class="stat">
                    <div class="label">Overdue</div>
                    <div class="value" data-stat="overdue">2</div>
                  </div>
                </div>
                <div
                  style="
                    margin-top: 12px;
                    display: flex;
                    gap: 8px;
                    flex-wrap: wrap;
                  "
                >
                  <a class="btn" id="btn-view-overdue" href="#borrowing"
                    >View Overdue</a
                  >
                  <a class="btn" href="#borrowing">New Loan</a>
                  <a class="btn" href="#service">Log New Repair</a>
                </div>
              </div>
            </div>

            <div class="grid">
              <section class="card" aria-labelledby="out-title">
                <h2 id="out-title">Currently Checked Out</h2>
                <div class="body table">
                  <table>
                    <thead>
                      <tr>
                        <th scope="col">Item</th>
                        <th scope="col">Customer</th>
                        <th scope="col">ID</th>
                        <th scope="col">Room</th>
                        <th scope="col">Due</th>
                        <th scope="col">Due in</th>
                        <th scope="col">Status</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-home-out"></tbody>
                  </table>
                </div>
              </section>

              <section class="card" aria-labelledby="repair-title">
                <h2 id="repair-title">Items Checked In for Repair</h2>
                <div class="body table">
                  <table>
                    <thead>
                      <tr>
                        <th scope="col">Item</th>
                        <th scope="col">Issue</th>
                        <th scope="col">Logged By</th>
                        <th scope="col">Date</th>
                        <th scope="col">Status</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-home-repairs"></tbody>
                  </table>
                </div>
              </section>
            </div>
          </section>

          <!-- BORROWING -->
          <section id="borrowing" class="screen" aria-labelledby="borrow-title">
            <div class="card" style="margin-bottom: 14px">
              <h2 id="borrow-title">Borrowing</h2>
              <div class="body">
                <div class="toolbar">
                  <div style="display: flex; gap: 8px; flex-wrap: wrap">
                    <button
                      class="btn primary"
                      data-open="dlg-new-customer"
                      data-action="borrow"
                    >
                      <span>New Customer</span
                      ><span class="spinner" aria-hidden="true"></span>
                    </button>
                    <button class="btn" data-open="dlg-returning-borrow">
                      <span>Returning Customer</span
                      ><span class="spinner" aria-hidden="true"></span>
                    </button>
                  </div>
                  <div class="search" role="search">
                    <input
                      id="search-borrow"
                      type="text"
                      placeholder="Search Customer, item, ID…"
                      aria-label="Search"
                    />
                  </div>
                </div>
                <div class="filters" id="filters-borrow">
                  <span class="chip active" data-filter="all">Status: All</span>
                  <span class="chip" data-filter="Overdue">Overdue</span>
                  <span class="chip" data-filter="On Time">On Time</span>
                  <span class="chip" data-filter="Returned">Returned</span>
                </div>
              </div>
            </div>

            <div class="card">
              <h2
                style="
                  border-bottom: 1px solid var(--line);
                  padding: 12px 14px;
                  margin: 0;
                "
              >
                Recent Borrowed Items
              </h2>
              <div class="body table">
                <table>
                  <thead>
                    <tr>
                      <th scope="col">Trace #</th>
                      <th scope="col">Item</th>
                      <th scope="col">Customer</th>
                      <th scope="col">ID</th>
                      <th scope="col">Out</th>
                      <th scope="col">Due</th>
                      <th scope="col">Due in</th>
                      <th scope="col">Status</th>
                    </tr>
                  </thead>
                  <tbody id="tbl-borrow"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- SERVICE LOG -->
          <section id="service" class="screen" aria-labelledby="service-title">
            <div class="card" style="margin-bottom: 14px">
              <h2 id="service-title">Service Log</h2>
              <div class="body">
                <div class="toolbar">
                  <div style="display: flex; gap: 8px; flex-wrap: wrap">
                    <button
                      class="btn primary"
                      data-open="dlg-new-customer"
                      data-action="service"
                    >
                      <span>New Customer</span
                      ><span class="spinner" aria-hidden="true"></span>
                    </button>
                    <button class="btn" data-open="dlg-returning-service">
                      <span>Returning Customer</span
                      ><span class="spinner" aria-hidden="true"></span>
                    </button>
                  </div>
                  <div class="search" role="search">
                    <input
                      id="search-service"
                      type="text"
                      placeholder="Search item, ticket, customer…"
                      aria-label="Search"
                    />
                  </div>
                </div>
                <div class="filters" id="filters-service">
                  <span class="chip active" data-filter="all">Status: All</span>
                  <span class="chip" data-filter="Diagnosing">Diagnosing</span>
                  <span class="chip" data-filter="Awaiting Parts"
                    >Awaiting Parts</span
                  >
                  <span class="chip" data-filter="Ready for Pickup"
                    >Ready for Pickup</span
                  >
                </div>
              </div>
            </div>

            <div class="card">
              <h2
                style="
                  border-bottom: 1px solid var(--line);
                  padding: 12px 14px;
                  margin: 0;
                "
              >
                Recent Service Tickets
              </h2>
              <div class="body table">
                <table>
                  <thead>
                    <tr>
                      <th scope="col">Ticket</th>
                      <th scope="col">Item</th>
                      <th scope="col">Issue</th>
                      <th scope="col">Logged</th>
                      <th scope="col">Assigned</th>
                      <th scope="col">Status</th>
                    </tr>
                  </thead>
                  <tbody id="tbl-service"></tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- ADMIN: ACTION LOG -->
          <section
            id="admin-action-log"
            class="screen admin-only"
            aria-labelledby="admin-action-title"
          >
            <div class="card">
              <h2 id="admin-action-title">Action Log</h2>
              <div class="body">
                <div
                  class="toolbar"
                  style="
                    display: flex;
                    justify-content: space-between;
                    gap: 12px;
                    flex-wrap: wrap;
                    align-items: center;
                  "
                >
                  <div style="display: flex; gap: 8px; flex-wrap: wrap">
                    <button class="btn" type="button" id="btn-clear-log">
                      <span>Clear Log</span>
                    </button>
                    <button
                      class="btn danger"
                      type="button"
                      id="btn-clear-database"
                    >
                      <span>Clear Database</span>
                    </button>
                  </div>
                  <div class="search" role="search" style="max-width: 320px">
                    <input
                      id="search-action-log"
                      type="text"
                      placeholder="Search by user, action, or detail…"
                      aria-label="Search action log"
                    />
                  </div>
                </div>
              </div>
              <div class="body table">
                <table>
                  <thead>
                    <tr>
                      <th scope="col">User</th>
                      <th scope="col">Trace #</th>
                      <th scope="col">Action</th>
                      <th scope="col">Date/Time</th>
                      <th scope="col">Details</th>
                    </tr>
                  </thead>
                  <tbody id="tbl-admin-log">
                    <tr>
                      <td
                        colspan="5"
                        style="
                          text-align: center;
                          color: var(--muted);
                          padding: 18px 12px;
                        "
                      >
                        Loading recent activity…
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- ADMIN: CUSTOMER MANAGEMENT -->
          <section
            id="admin-customers"
            class="screen admin-only"
            aria-labelledby="admin-customers-title"
          >
            <div class="card">
              <h2 id="admin-customers-title">Customer Management</h2>
              <div class="body">
                <div
                  class="toolbar"
                  style="
                    justify-content: space-between;
                    align-items: center;
                    gap: 12px;
                    flex-wrap: wrap;
                  "
                >
                  <div class="search" role="search" style="flex: 1 1 260px">
                    <input
                      id="search-profiles"
                      type="text"
                      placeholder="Search name, alias, or ID…"
                      aria-label="Search customer profiles"
                    />
                  </div>
                  <p class="hint" style="margin: 0; max-width: 420px">
                    Select a profile to review details, manage aliases, or
                    perform maintenance tasks.
                  </p>
                </div>
              </div>
              <div class="body table">
                <table>
                  <thead>
                    <tr>
                      <th scope="col">Name</th>
                      <th scope="col">School ID</th>
                      <th scope="col">Aliases</th>
                      <th scope="col">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="tbl-customer-profiles">
                    <tr>
                      <td
                        colspan="4"
                        style="
                          text-align: center;
                          color: var(--muted);
                          padding: 18px 12px;
                        "
                      >
                        Loading customer profiles…
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- ADMIN: USER MANAGEMENT -->
          <section
            id="admin-users"
            class="screen admin-only"
            aria-labelledby="admin-users-title"
          >
            <div class="card">
              <h2 id="admin-users-title">User Management</h2>
              <div class="body">
                <div
                  class="toolbar"
                  style="
                    justify-content: space-between;
                    gap: 12px;
                    flex-wrap: wrap;
                    align-items: center;
                  "
                >
                  <div style="display: flex; gap: 8px; flex-wrap: wrap">
                    <button class="btn" data-open="dlg-create-user">
                      <span>Create User</span>
                    </button>
                  </div>
                  <div class="search" role="search" style="flex: 1 1 240px">
                    <input
                      id="search-admin-users"
                      type="text"
                      placeholder="Search users…"
                      aria-label="Search user profiles"
                    />
                  </div>
                </div>
              </div>
              <div class="body table">
                <table>
                  <thead>
                    <tr>
                      <th scope="col">Username</th>
                      <th scope="col">Display Name</th>
                      <th scope="col">Role</th>
                      <th scope="col">Created</th>
                      <th scope="col">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="tbl-admin-users">
                    <tr>
                      <td
                        colspan="5"
                        style="
                          text-align: center;
                          color: var(--muted);
                          padding: 18px 12px;
                        "
                      >
                        Enable backend to load user profiles.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- ADMIN: INVENTORY MANAGEMENT -->
          <section
            id="admin-inventory"
            class="screen admin-only"
            aria-labelledby="admin-inventory-title"
          >
            <div class="card">
              <h2 id="admin-inventory-title">Inventory Management</h2>
              <div class="body">
                <div
                  class="toolbar"
                  style="
                    justify-content: space-between;
                    gap: 12px;
                    flex-wrap: wrap;
                    align-items: center;
                  "
                >
                  <div style="display: flex; gap: 8px; flex-wrap: wrap">
                    <button class="btn" data-open="dlg-create-item">
                      <span>Add Inventory Item</span>
                    </button>
                  </div>
                  <div class="search" role="search" style="flex: 1 1 240px">
                    <input
                      id="search-admin-inventory"
                      type="text"
                      placeholder="Search inventory…"
                      aria-label="Search inventory items"
                    />
                  </div>
                </div>
              </div>
              <div class="body table">
                <table>
                  <thead>
                    <tr>
                      <th scope="col">Item Name</th>
                      <th scope="col">Department</th>
                      <th scope="col">Due Policy</th>
                      <th scope="col">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="tbl-admin-inventory">
                    <tr>
                      <td
                        colspan="4"
                        style="
                          text-align: center;
                          color: var(--muted);
                          padding: 18px 12px;
                        "
                      >
                        Enable backend to load inventory items.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

        </div>
      </main>
    </div>


    <dialog id="dlg-help">
      <form method="dialog">
        <div class="modal-hd">
          <strong>Quick Help</strong>
          <button class="btn" value="close">Close</button>
        </div>
        <div class="modal-bd">
          <p class="hint">
            Lab Center IMS keeps track of people, gear, and repair work flowing
            through the Cincinnati State Lab Center. The dashboard loads with
            live stats so you can see what is out, what is coming back, and what
            needs attention right away.
          </p>
          <h3>Getting around</h3>
          <ul class="hint">
            <li>
              Use the sidebar on the left to switch between the Home overview,
              Borrowing, Service Log, and Admin areas.
            </li>
            <li>
              Search boxes and filter toggles at the top of most tables let you
              narrow results quickly; table rows open detail drawers for richer
              context.
            </li>
            <li>
              Global actions like adding customers or recording returns are
              available as bright green buttons directly above each table.
            </li>
          </ul>
          <h3>Borrowing workflow</h3>
          <ul class="hint">
            <li>
              <strong>New Checkout</strong> gathers customer info, device
              selection, and due-date rules in one flow. Flag items as accessories
              or high value to trigger the right paperwork.
            </li>
            <li>
              <strong>Returns</strong> reconcile items, log condition notes, and
              schedule follow-up maintenance when needed.
            </li>
            <li>
              Borrowing tabs split <em>New</em> versus <em>Returning</em> visitors
              so required fields adjust automatically.
            </li>
          </ul>
          <h3>Service & repairs</h3>
          <ul class="hint">
            <li>
              Track devices from <em>Diagnosing</em> → <em>Awaiting Parts</em> →
              <em>Ready for Pickup</em>; status chips update the dashboard and
              overdue counters instantly.
            </li>
            <li>
              Attach technician notes, parts used, and cost estimates inside each
              ticket drawer to keep the customer record complete.
            </li>
          </ul>
          <h3>Admin tools</h3>
          <ul class="hint">
            <li>
              The Action Log records every significant event with timestamps for
              audit trails.
            </li>
            <li>
              Customer and User Management tables let you invite new accounts,
              set roles such as <em>Admin</em> or <em>Co-Op</em>, and reset
              passwords.
            </li>
            <li>
              Inventory Management keeps loaner hardware up to date. Track serial
              numbers, due-date policies, and maintenance flags from one place.
            </li>
          </ul>
          <h3>Need to know</h3>
          <ul class="hint">
            <li>
              Data is stored once you connect the backend; in demo mode the UI
              shows how workflows behave but does not persist changes.
            </li>
            <li>
              Keyboard shortcut: press <kbd>?</kbd> anywhere to reopen this help
              window.
            </li>
            <li>
              Problems or ideas? Use the Action Log &rarr; "Record Note" button
              so the rest of the team sees it.
            </li>
          </ul>
        </div>
        <div class="modal-ft">
          <button class="btn primary" value="close">Got it</button>
        </div>
      </form>
    </dialog>

    <!-- New Customer (Borrow or Service) -->
    <dialog id="dlg-new-customer">
      <form method="dialog" id="form-new-customer" novalidate>
        <div class="modal-hd">
          <strong>New Customer</strong>
          <button class="btn" value="close">Close</button>
        </div>
        <div class="modal-bd">
          <div class="form-grid">
            <div>
              <label>First Name</label>
              <input id="nc-first" required />
            </div>
            <div>
              <label>Last Name</label>
              <input id="nc-last" required />
            </div>
            <div>
              <label>School/Faculty ID (optional)</label>
              <input
                id="nc-schoolid"
                pattern="\\d{5,8}"
                placeholder="e.g., 12345"
                inputmode="numeric"
              />
              <div class="hint">5–8 digits, numbers only.</div>
            </div>
            <div>
              <label>Phone</label>
              <input
                id="nc-phone"
                placeholder="5555555555"
                pattern="\\d{10}"
                inputmode="numeric"
              />
              <div class="hint">10 digits, no formatting.</div>
            </div>
            <div>
              <label>Room</label>
              <input id="nc-room" placeholder="ATLC 102" />
            </div>
            <div>
              <label>Instructor</label>
              <input id="nc-instructor" placeholder="e.g., Prof. Smith" />
            </div>
            

            <!-- Borrow specifics -->
            <div class="full" data-bind="borrow">
              <label>Item</label>
              <select id="nc-item">
                <option value="">Select an item…</option>
              </select>
            </div>
            <div
              class="full due-preview"
              data-bind="borrow"
              id="nc-due-preview"
              aria-live="polite"
            >
              Due date will be assigned automatically from the item's policy.
            </div>
            <div data-bind="borrow">
              <label>Checkout Notes</label>
              <input
                id="nc-notes"
                placeholder="Condition notes / instructions"
              />
            </div>

            <!-- Service specifics -->
            <div class="full" data-bind="service" style="display: none">
              <label>Item Being Serviced</label>
              <select id="ns-item">
                <option value="">Select an item…</option>
              </select>
            </div>
            <div class="full" data-bind="service" style="display: none">
              <label>Issue Description</label>
              <textarea
                id="ns-issue"
                placeholder="Describe the problem…"
              ></textarea>
            </div>
          </div>
        </div>
        <div class="modal-ft">
          <button class="btn" value="close">Cancel</button>
          <button class="btn primary" id="nc-save">
            <span>Save & Continue</span
            ><span class="spinner" aria-hidden="true"></span>
          </button>
        </div>
      </form>
    </dialog>

    <!-- Returning Customer (Borrowing) -->
    <dialog id="dlg-returning-borrow">
      <form method="dialog" id="form-returning-borrow" novalidate>
        <div class="modal-hd">
          <strong>Returning Customer — Borrow</strong>
          <button class="btn" value="close">Close</button>
        </div>
        <div class="modal-bd">
          <div class="form-grid">
            <input type="hidden" id="rb-borrower-id" />
            <div>
              <label>School/Faculty ID</label>
              <input
                id="rb-id"
                placeholder="or leave blank & use name lookup"
                pattern="\\d{5,8}"
                inputmode="numeric"
              />
            </div>
            <div>
              <label>Name Lookup</label>
              <div class="lookup">
                <input
                  id="rb-name"
                  placeholder="Jane Doe"
                  autocomplete="off"
                  aria-expanded="false"
                  aria-haspopup="listbox"
                />
                <ul
                  class="lookup-menu"
                  id="rb-name-menu"
                  role="listbox"
                  aria-label="Matching borrowers"
                ></ul>
              </div>
            </div>
            <div class="full">
              <label>Item</label>
              <select id="rb-item" required>
                <option value="">Select an item…</option>
              </select>
            </div>
            <div
              class="full due-preview"
              id="rb-due-preview"
              aria-live="polite"
            >
              Due date will be assigned automatically from the item's policy.
            </div>
            <div>
              <label>Checkout Notes</label>
              <input id="rb-notes" placeholder="optional" />
            </div>
          </div>
          <div class="hint">Provide either ID or Name (one is required).</div>
        </div>
        <div class="modal-ft">
          <button class="btn" value="close">Cancel</button>
          <button class="btn primary" id="rb-save">
            <span>Checkout</span
            ><span class="spinner" aria-hidden="true"></span>
          </button>
        </div>
      </form>
    </dialog>

    <!-- Returning Customer (Service) -->
    <dialog id="dlg-returning-service">
      <form method="dialog" id="form-returning-service" novalidate>
        <div class="modal-hd">
          <strong>Returning Customer — Service</strong>
          <button class="btn" value="close">Close</button>
        </div>
        <div class="modal-bd">
          <div class="form-grid">
            <input type="hidden" id="rs-borrower-id" />
            <div>
              <label>School/Faculty ID</label>
              <input
                id="rs-id"
                placeholder="or name lookup"
                pattern="\\d{5,8}"
                inputmode="numeric"
              />
            </div>
            <div>
              <label>Name Lookup</label>
              <div class="lookup">
                <input
                  id="rs-name"
                  placeholder="Alex Smith"
                  autocomplete="off"
                  aria-expanded="false"
                  aria-haspopup="listbox"
                />
                <ul
                  class="lookup-menu"
                  id="rs-name-menu"
                  role="listbox"
                  aria-label="Matching borrowers"
                ></ul>
              </div>
            </div>
            <div class="full">
              <label>Item Being Serviced</label>
              <select id="rs-item" required>
                <option value="">Select an item…</option>
              </select>
            </div>
            <div class="full">
              <label>Issue</label>
              <textarea
                id="rs-issue"
                required
                placeholder="Describe the problem…"
              ></textarea>
            </div>
          </div>
          <div class="hint">Provide either ID or Name (one is required).</div>
        </div>
        <div class="modal-ft">
          <button class="btn" value="close">Cancel</button>
          <button class="btn primary" id="rs-save">
            <span>Create Ticket</span
            ><span class="spinner" aria-hidden="true"></span>
          </button>
        </div>
      </form>
    </dialog>

    <!-- Detail viewer (Loan or Ticket) -->
    <dialog id="dlg-detail">
      <form method="dialog" id="form-detail" novalidate>
        <div class="modal-hd">
          <strong id="det-title">Details</strong>
          <button class="btn" value="close">Close</button>
        </div>
        <div class="modal-bd">
          <div class="form-grid">
            <div><label>Type</label><input id="det-type" readonly /></div>
            <div><label>ID</label><input id="det-id" readonly /></div>
            <div class="full">
              <label>Primary</label><input id="det-primary" readonly />
            </div>
            <div class="full">
              <label>Status</label>
              <select id="det-status">
                <option>On Time</option>
                <option>Overdue</option>
                <option>Returned</option>
                <option>Diagnosing</option>
                <option>Awaiting Parts</option>
                <option>Ready for Pickup</option>
                <option>Completed</option>
                <option>Cancelled</option>
              </select>
            </div>
            <div class="full">
              <label>Add Note</label>
              <textarea
                id="det-note"
                placeholder="This appends to the log…"
              ></textarea>
            </div>
            <div class="full">
              <label>Note History</label>
              <div
                id="det-note-log"
                class="note-log"
                role="log"
                aria-live="polite"
              ></div>
            </div>
          </div>
        </div>
        <div class="modal-ft">
          <button class="btn" value="close">Cancel</button>
          <button class="btn primary" id="det-save">
            <span>Save Changes</span
            ><span class="spinner" aria-hidden="true"></span>
          </button>
        </div>
      </form>
    </dialog>

    <!-- Admin: Create Item -->
    <dialog id="dlg-create-item">
      <form method="dialog" id="form-create-item" novalidate>
        <div class="modal-hd">
          <strong>Add Inventory Item</strong>
          <button class="btn" value="close">Close</button>
        </div>
        <div class="modal-bd">
          <div class="form-grid">
            <div class="full">
              <label>Item Name</label>
              <input id="ci-name" required placeholder="e.g., Trainer #34" />
            </div>
            <div>
              <label>Department</label>
              <input
                id="ci-dept"
                placeholder="e.g., Electrical Engineering Tech"
              />
            </div>
            <div>
              <label>Ownership</label>
              <select id="ci-owned">
                <option value="school" selected>School-owned</option>
                <option value="external">External / donated</option>
              </select>
            </div>
            <div class="full">
              <label>Description</label>
              <textarea id="ci-description" placeholder="optional"></textarea>
            </div>
            <div class="full">
              <label>Due Policy</label>
              <select id="ci-due-policy">
                <option value="NEXT_DAY_6PM" selected>
                  Next day at 6:00 PM
                </option>
                <option value="OFFSET">Custom offset</option>
                <option value="SEMESTER">Semester / fixed date</option>
              </select>
            </div>
            <div class="due-config" data-policy="OFFSET">
              <label>Offset (days)</label>
              <input id="ci-offset-days" type="number" min="0" value="1" />
            </div>
            <div class="due-config" data-policy="OFFSET">
              <label>Offset (hours)</label>
              <input id="ci-offset-hours" type="number" min="0" value="0" />
            </div>
            <div class="due-config" data-policy="OFFSET">
              <label>Due Time (local)</label>
              <input id="ci-offset-time" type="time" value="18:00" />
            </div>
            <div class="due-config full" data-policy="SEMESTER">
              <label>Fixed Due (local)</label>
              <input id="ci-fixed-due" type="datetime-local" />
              <div class="hint">
                Set the semester end date/time for this item.
              </div>
            </div>
          </div>
        </div>
        <div class="modal-ft">
          <button class="btn" value="close">Cancel</button>
          <button class="btn primary" id="ci-save">
            <span>Save Item</span
            ><span class="spinner" aria-hidden="true"></span>
          </button>
        </div>
      </form>
    </dialog>

    <!-- Admin: Manage Item -->
    <dialog id="dlg-manage-item">
      <form method="dialog" id="form-manage-item" novalidate>
        <div class="modal-hd">
          <strong>Manage Inventory Item</strong>
          <button class="btn" value="close">Close</button>
        </div>
        <div class="modal-bd">
          <input type="hidden" id="mi-id" />
          <div class="form-grid">
            <div class="full">
              <label>Item Name</label>
              <input id="mi-name" required />
            </div>
            <div>
              <label>Department</label>
              <input id="mi-dept" placeholder="e.g., Electrical Engineering Tech" />
            </div>
            <div>
              <label>Ownership</label>
              <select id="mi-owned">
                <option value="school">School-owned</option>
                <option value="external">External / donated</option>
              </select>
            </div>
            <div class="full">
              <label>Description</label>
              <textarea id="mi-description" placeholder="optional"></textarea>
            </div>
            <div class="full">
              <label>Due Policy</label>
              <select id="mi-due-policy">
                <option value="NEXT_DAY_6PM">Next day at 6:00 PM</option>
                <option value="OFFSET">Custom offset</option>
                <option value="SEMESTER">Semester / fixed date</option>
              </select>
            </div>
            <div class="due-config" data-policy="OFFSET">
              <label>Offset (days)</label>
              <input id="mi-offset-days" type="number" min="0" />
            </div>
            <div class="due-config" data-policy="OFFSET">
              <label>Offset (hours)</label>
              <input id="mi-offset-hours" type="number" min="0" />
            </div>
            <div class="due-config" data-policy="OFFSET">
              <label>Due Time (local)</label>
              <input id="mi-offset-time" type="time" />
            </div>
            <div class="due-config full" data-policy="SEMESTER">
              <label>Fixed Due (local)</label>
              <input id="mi-fixed-due" type="datetime-local" />
              <div class="hint">Set the semester end date/time for this item.</div>
            </div>
          </div>
        </div>
        <div class="modal-ft" style="display: flex; gap: 12px; justify-content: space-between; flex-wrap: wrap">
          <button class="btn danger" type="button" id="mi-delete">
            <span>Delete Item</span><span class="spinner" aria-hidden="true"></span>
          </button>
          <div style="display: flex; gap: 8px">
            <button class="btn" value="close">Cancel</button>
            <button class="btn primary" id="mi-save">
              <span>Save Changes</span><span class="spinner" aria-hidden="true"></span>
            </button>
          </div>
        </div>
      </form>
    </dialog>

    <!-- Admin: Create User -->
    <dialog id="dlg-create-user">
      <form method="dialog" id="form-create-user" novalidate>
        <div class="modal-hd">
          <strong>Create User</strong>
          <button class="btn" value="close">Close</button>
        </div>
        <div class="modal-bd">
          <div class="form-grid">
            <div>
              <label>Username</label><input id="cu-username" required />
            </div>
            <div>
              <label>Display Name</label><input id="cu-display" required />
            </div>
            <div class="full">
              <label>Role</label>
              <select id="cu-role" required>
                <option value="">Select…</option>
                <option value="admin">Admin</option>
                <option value="co-op">Co-Op</option>
              </select>
            </div>
            <div class="full">
              <label for="cu-password">Password</label>
              <input
                id="cu-password"
                type="password"
                required
                minlength="8"
                maxlength="255"
                autocomplete="new-password"
                placeholder="Set an initial password for this user"
              />
              <p class="hint">Passwords must be at least 8 characters.</p>
            </div>
          </div>
          <div class="hint">
            Roles are limited to Admin and Co-Op to match staffing duties.
          </div>
        </div>
        <div class="modal-ft">
          <button class="btn" value="close">Cancel</button>
          <button class="btn primary" id="cu-save">
            <span>Create</span><span class="spinner" aria-hidden="true"></span>
          </button>
        </div>
      </form>
    </dialog>

    <!-- Admin: Edit User -->
    <dialog id="dlg-edit-user">
      <form method="dialog" id="form-edit-user" novalidate>
        <div class="modal-hd">
          <strong>Edit User</strong>
          <button class="btn" value="close">Close</button>
        </div>
        <div class="modal-bd">
          <input type="hidden" id="eu-username-hidden" />
          <div class="form-grid">
            <div>
              <label>Username</label>
              <input id="eu-username" readonly />
            </div>
            <div>
              <label>Display Name</label>
              <input id="eu-display" required />
            </div>
            <div class="full">
              <label>Role</label>
              <select id="eu-role" required>
                <option value="admin">Admin</option>
                <option value="co-op">Co-Op</option>
              </select>
            </div>
            <div class="full">
              <label for="eu-password">New Password</label>
              <input
                id="eu-password"
                type="password"
                maxlength="255"
                autocomplete="new-password"
                placeholder="Leave blank to keep current password"
              />
              <p class="hint">
                Leave blank to keep the current password. New passwords must be at
                least 8 characters.
              </p>
            </div>
          </div>
        </div>
        <div class="modal-ft">
          <button class="btn" value="close">Cancel</button>
          <button class="btn primary" id="eu-save">
            <span>Save Changes</span><span class="spinner" aria-hidden="true"></span>
          </button>
        </div>
      </form>
    </dialog>

    <!-- Admin: Manage Customer Profile -->
    <dialog id="dlg-manage-customer">
      <form method="dialog" id="form-manage-customer" novalidate>
        <div class="modal-hd">
          <strong>Manage Customer Profile</strong>
          <button class="btn" value="close">Close</button>
        </div>
        <div class="modal-bd">
          <input type="hidden" id="cust-profile-id" />
          <div class="profile-grid">
            <div>
              <div class="profile-label">Name</div>
              <div class="profile-value" id="cust-name">—</div>
            </div>
            <div>
              <div class="profile-label">School/Faculty ID</div>
              <div class="profile-value" id="cust-school">—</div>
            </div>
            <div>
              <div class="profile-label">Phone</div>
              <div class="profile-value" id="cust-phone">—</div>
            </div>
            <div>
              <div class="profile-label">Room</div>
              <div class="profile-value" id="cust-room">—</div>
            </div>
            <div>
              <div class="profile-label">Instructor</div>
              <div class="profile-value" id="cust-instructor">—</div>
            </div>
            <div>
              <div class="profile-label">Department</div>
              <div class="profile-value" id="cust-department">—</div>
            </div>
            <div>
              <div class="profile-label">Created</div>
              <div class="profile-value" id="cust-created">—</div>
            </div>
          </div>
          <div>
            <label>Aliases</label>
            <div id="cust-alias-list" class="alias-list" role="list">
              <p class="alias-empty">No aliases yet.</p>
            </div>
          </div>
          <div class="form-grid">
            <div class="full">
              <label for="cust-alias-input">Add Alias</label>
              <div class="alias-add-row">
                <input id="cust-alias-input" placeholder="e.g., Josie" />
                <button id="cust-alias-add" type="button" class="btn primary">
                  <span>Add Alias</span
                  ><span class="spinner" aria-hidden="true"></span>
                </button>
              </div>
              <p class="hint">
                Aliases help staff find the right customer when someone goes by
                multiple names.
              </p>
            </div>
          </div>
        </div>
        <div class="modal-ft">
          <button class="btn" value="close">Done</button>
        </div>
      </form>
    </dialog>

    <script>
      // -----------------------------------------------------------------------------
      // Name: Lab Center IMS Team
      // Class: Web Dev / JS
      // Abstract: Client interactions for Lab Center IMS interface.
      // -----------------------------------------------------------------------------
      document.addEventListener("DOMContentLoaded", async () => {
        "use strict";

        // ====== CONFIG ======
        const USE_BACKEND = true; // flip to true when your API is running
        const API_BASE = "/api";
        const SESSION_STORAGE_KEY = "labcenter.sessionToken";
        const SESSION_MESSAGE_KEY = "labcenter.authMessage";
        const SESSION_IDLE_LIMIT_MS = 15 * 60 * 1000;

        let m_strSessionToken = null;
        let m_objCurrentUser = null;
        let m_idIdleTimer = null;
        let m_boolHasBootstrapped = false;
        let m_boolAuthReloadPending = false;
        let m_arrAdminTables = [];
        let m_objAdminActiveTablePayload = null;
        let m_strQueuedAuthMessage = window.sessionStorage.getItem(
          SESSION_MESSAGE_KEY,
        );
        if (m_strQueuedAuthMessage) {
          window.sessionStorage.removeItem(SESSION_MESSAGE_KEY);
        }

        const elLoginForm = document.getElementById("login-form");
        const elLoginUsername = document.getElementById("login-username");
        const elLoginPassword = document.getElementById("login-password");
        const elLoginError = document.getElementById("login-error");
        const elLoginSubmit = document.getElementById("login-submit");
        const elLoginReset = document.getElementById("login-reset");
        const elLogoutButton = document.getElementById("btn-logout");
        const elUserDisplay = document.getElementById("current-user-display");

        // ====== UTIL ======
        const fnSelectElement = (sel, root = document) =>
          root.querySelector(sel);
        const fnSelectAllElements = (sel, root = document) =>
          Array.from(root.querySelectorAll(sel));
        const fnSetBusyState = (btn, busy = true) =>
          btn.setAttribute("aria-busy", busy ? "true" : "false");

        function fnUpdateUserDisplay() {
          if (!elUserDisplay) return;
          if (!m_objCurrentUser) {
            elUserDisplay.textContent = "";
            elUserDisplay.title = "";
            return;
          }
          const name =
            m_objCurrentUser.displayName ||
            m_objCurrentUser.username ||
            "Signed in";
          elUserDisplay.textContent = name;
          elUserDisplay.title = m_objCurrentUser.roleLabel
            ? `${name} — ${m_objCurrentUser.roleLabel}`
            : name;
        }

        const ADMIN_HASHES = new Set([
          "#admin-action-log",
          "#admin-customers",
          "#admin-users",
          "#admin-inventory",
        ]);

        function fnNormalizeRole(value) {
          return String(value || "")
            .trim()
            .toLowerCase()
            .replace(/[\s_]+/g, "-");
        }

        function fnIsAdminUser() {
          return fnNormalizeRole(m_objCurrentUser?.role) === "admin";
        }

        function fnApplyAdminUiAccess() {
          const isAdmin = fnIsAdminUser();
          document.body.classList.toggle("is-admin", isAdmin);
          if (!isAdmin && ADMIN_HASHES.has(window.location.hash)) {
            window.location.hash = "#home";
          }
        }

        function fnClearIdleTimer() {
          if (m_idIdleTimer) {
            window.clearTimeout(m_idIdleTimer);
            m_idIdleTimer = null;
          }
        }

        function fnResetIdleTimer() {
          if (!m_strSessionToken) return;
          fnClearIdleTimer();
          m_idIdleTimer = window.setTimeout(() => {
            fnLogout({ idle: true });
          }, SESSION_IDLE_LIMIT_MS);
        }

        function fnApplySession(token, user, { persist = true } = {}) {
          m_strSessionToken = token || null;
          m_objCurrentUser = user || null;
          if (persist) {
            if (m_strSessionToken) {
              window.localStorage.setItem(
                SESSION_STORAGE_KEY,
                m_strSessionToken,
              );
            } else {
              window.localStorage.removeItem(SESSION_STORAGE_KEY);
            }
          }
          fnUpdateUserDisplay();
          fnApplyAdminUiAccess();
        }

        function fnClearSession() {
          fnApplySession(null, null);
          fnClearIdleTimer();
          document.body.classList.remove("authenticated");
        }

        function fnShowLogin(message) {
          fnClearSession();
          if (elLoginError) {
            elLoginError.textContent =
              message || m_strQueuedAuthMessage || "";
          }
          m_strQueuedAuthMessage = "";
          window.requestAnimationFrame(() => {
            elLoginUsername?.focus();
          });
        }

        async function fnRawRequest(path, opts = {}) {
          if (window.api?.request) {
            const payload = {
              method: opts.method || "GET",
              path,
              headers: opts.headers || {},
              body: opts.body || null,
            };
            if (opts.queryString) {
              payload.headers["x-query"] = opts.queryString;
            }
            const response = await window.api.request(payload);
            const body = response?.body ?? null;
            return {
              ok: response?.status >= 200 && response?.status < 300,
              status: response?.status ?? 500,
              json: async () => body,
              text: async () =>
                typeof body === "string" ? body : JSON.stringify(body || {}),
            };
          }
          const url = opts.queryString ? `${path}${opts.queryString}` : path;
          return fetch(url, opts);
        }

        async function fnRestoreSession() {
          const stored = window.localStorage.getItem(SESSION_STORAGE_KEY);
          if (!stored) {
            return false;
          }
          m_strSessionToken = stored;
          try {
            const res = await fnRawRequest(`${API_BASE}/session`, {
              method: "GET",
              headers: { Authorization: `Bearer ${stored}` },
            });
            if (!res.ok) throw new Error("Not authenticated");
            const payload = await res.json();
            if (!payload?.user) throw new Error("Invalid session");
            fnApplySession(stored, payload.user, { persist: false });
            return true;
          } catch (err) {
            window.localStorage.removeItem(SESSION_STORAGE_KEY);
            fnApplySession(null, null, { persist: false });
            return false;
          }
        }

        async function fnHandleUnauthorized() {
          if (m_boolAuthReloadPending) return;
          m_boolAuthReloadPending = true;
          window.localStorage.removeItem(SESSION_STORAGE_KEY);
          window.sessionStorage.setItem(
            SESSION_MESSAGE_KEY,
            "Your session has expired. Please sign in again.",
          );
          window.location.reload();
        }

        async function fnLogout({ idle = false } = {}) {
          if (!m_strSessionToken) {
            fnShowLogin();
            return;
          }
          try {
            await fnRawRequest(`${API_BASE}/logout`, {
              method: "POST",
              headers: { Authorization: `Bearer ${m_strSessionToken}` },
            });
          } catch (err) {
            // ignore network issues on logout
          } finally {
            window.localStorage.removeItem(SESSION_STORAGE_KEY);
            if (idle) {
              window.sessionStorage.setItem(
                SESSION_MESSAGE_KEY,
                "Signed out after 15 minutes of inactivity.",
              );
            }
            window.location.reload();
          }
        }

        if (elLoginForm) {
          elLoginForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const username = elLoginUsername?.value.trim().toLowerCase();
            const password = elLoginPassword?.value.trim();
            if (!username || !password) {
              if (elLoginError) {
                elLoginError.textContent =
                  "Username and password are required.";
              }
              return;
            }
            try {
              if (elLoginError) elLoginError.textContent = "";
              if (elLoginSubmit) fnSetBusyState(elLoginSubmit, true);
              const res = await fnRawRequest(`${API_BASE}/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username, password }),
              });
              let payload = null;
              try {
                payload = await res.json();
              } catch (err) {
                payload = null;
              }
              if (!res.ok || !payload?.token) {
                throw new Error(
                  payload?.error || "Invalid username or password.",
                );
              }
              fnApplySession(payload.token, payload.user || null);
              document.body.classList.add("authenticated");
              if (elLoginPassword) elLoginPassword.value = "";
              fnResetIdleTimer();
              await fnAfterAuthenticated({ initial: !m_boolHasBootstrapped });
            } catch (err) {
              console.error("Login failed", err);
              fnApplySession(null, null, { persist: false });
              document.body.classList.remove("authenticated");
              if (elLoginError) {
                elLoginError.textContent =
                  err?.message || "Unable to sign in. Please try again.";
              }
            } finally {
              if (elLoginSubmit) fnSetBusyState(elLoginSubmit, false);
            }
          });
        }

        if (elLoginReset) {
          elLoginReset.addEventListener("click", () => {
            elLoginForm?.reset();
            if (elLoginError) elLoginError.textContent = "";
            window.localStorage.removeItem(SESSION_STORAGE_KEY);
            elLoginUsername?.focus();
          });
        }

        if (elLogoutButton) {
          elLogoutButton.addEventListener("click", () => {
            fnLogout();
          });
        }

        ["pointerdown", "keydown", "touchstart"].forEach((evt) => {
          document.addEventListener(
            evt,
            () => {
              if (m_strSessionToken) {
                fnResetIdleTimer();
              }
            },
            { passive: true },
          );
        });

        /**
         * Mapping of business statuses to the visual pill classes we support.
         * Keeping the relationship centralized avoids subtle mismatches between
         * copy/paste blocks later in the file.
         */
        const STATUS_PILL_CLASS_MAP = {
          "On Time": "ok",
          Overdue: "overdue",
          Returned: "returned",
          "Awaiting Parts": "repair",
          Diagnosing: "diagnosing",
          "Ready for Pickup": "ready",
          Completed: "completed",
          Cancelled: "cancelled",
        };

        const LOAN_STATUSES = ["On Time", "Overdue", "Returned"];
        const TICKET_STATUSES = [
          "Diagnosing",
          "Awaiting Parts",
          "Ready for Pickup",
          "Completed",
          "Cancelled",
        ];

        /**
         * Table rows use a slightly different set of classes to tint the entire
         * line. That mapping lives here so styling logic can lean on a single
         * source of truth.
         */
        const STATUS_ROW_CLASS_MAP = {
          Overdue: "is-overdue",
          "Awaiting Parts": "is-awaiting",
          Diagnosing: "is-diagnosing",
          "Ready for Pickup": "is-ready",
        };
        const DETAIL_STATUS_OPTIONS = {
          loan: ["On Time", "Overdue", "Returned"],
          ticket: [
            "Diagnosing",
            "Awaiting Parts",
            "Ready for Pickup",
            "Completed",
            "Cancelled",
          ],
        };
        const ROW_STATUS_CLASSNAMES = Object.values(STATUS_ROW_CLASS_MAP);

        const AUDIT_ACTION_TITLES = {
          BORROWER_CREATE: "Borrower Created",
          ITEM_CREATE: "Item Added",
          CHECKOUT: "Checkout",
          CHECKIN: "Check-in",
          TICKET_CREATE: "Service Ticket Created",
          TICKET_STATUS: "Service Status Update",
          NOTE_ADD: "Note Added",
        };

        const AUDIT_DATETIME_FORMAT = new Intl.DateTimeFormat([], {
          dateStyle: "medium",
          timeStyle: "short",
        });
        const AUDIT_DATE_FORMAT = new Intl.DateTimeFormat([], {
          dateStyle: "medium",
        });
        const TABLE_DATETIME_FORMAT = new Intl.DateTimeFormat([], {
          dateStyle: "medium",
          timeStyle: "short",
        });

        const USER_ROLE_LABELS = new Map([
          ["admin", "Admin"],
          ["co-op", "Co-Op"],
        ]);
        const USER_ROLE_ALIASES = new Map([
          ["admin", "admin"],
          ["administrator", "admin"],
          ["labtech", "admin"],
          ["lab tech", "admin"],
          ["lab_tech", "admin"],
          ["lab-tech", "admin"],
          ["labtechnician", "admin"],
          ["lab technician", "admin"],
          ["co-op", "co-op"],
          ["coop", "co-op"],
          ["co op", "co-op"],
          ["co_op", "co-op"],
        ]);

        function fnCreateStatusPill(strStatus) {
          const elPill = document.createElement("span");
          elPill.className = "pill";
          if (strStatus) {
            const strClass = STATUS_PILL_CLASS_MAP[strStatus];
            if (strClass) elPill.classList.add(strClass);
            elPill.textContent = strStatus;
          } else {
            elPill.textContent = "";
          }
          return elPill;
        }

        function fnShowTableMessage(strTbodyId, strMessage, strTone = "muted") {
          const elTableBody = document.getElementById(strTbodyId);
          if (!elTableBody) return;
          elTableBody.textContent = "";
          const elRow = document.createElement("tr");
          const elCell = document.createElement("td");
          const elTable = elTableBody.closest("table");
          elCell.colSpan = elTable
            ? elTable.querySelectorAll("thead th").length
            : 1;
          elCell.textContent = strMessage;
          elCell.style.textAlign = "center";
          elCell.style.padding = "18px 12px";
          elCell.style.color =
            strTone === "error" ? "var(--overdue-fg)" : "var(--muted)";
          elRow.appendChild(elCell);
          elTableBody.appendChild(elRow);
        }

        function fnAppendTableCell(elRow, mixContent) {
          const elCell = document.createElement("td");
          if (mixContent instanceof Node) {
            elCell.appendChild(mixContent);
          } else if (
            mixContent === null ||
            mixContent === undefined ||
            mixContent === ""
          ) {
            elCell.textContent = "—";
          } else {
            elCell.textContent = mixContent;
          }
          elRow.appendChild(elCell);
          return elCell;
        }

        function fnFormatLocalDateTime(value) {
          if (!value) return "—";
          const dt = new Date(value);
          if (Number.isNaN(dt.getTime())) return "—";
          return TABLE_DATETIME_FORMAT.format(dt);
        }

        function fnFormatDueIn(loan) {
          if (!loan) return "—";
          if (loan.status === "Returned" || loan.checkinUtc) return "—";
          if (!loan.dueUtc) return "—";
          const due = new Date(loan.dueUtc);
          if (Number.isNaN(due.getTime())) return "—";
          const diffMs = due.getTime() - Date.now();
          const diffHours = diffMs / 3600000;
          const isNegative = diffHours < 0;
          const absHours = Math.abs(diffHours);
          let value;
          if (absHours >= 48) {
            value = Math.round(absHours / 24) + "d";
          } else {
            value = Math.round(absHours) + "h";
          }
          return (isNegative ? "-" : "") + value;
        }

        /**
         * Utility helper to close a dialog by id. Prevents repeated DOM lookups
         * and makes intent clear at the call site.
         */
        function fnCloseDialogById(strDialogId) {
          const elDialog = document.getElementById(strDialogId);
          if (elDialog) elDialog.close();
        }

        // Dialog openers
        fnSelectAllElements("[data-open]").forEach((elTrigger) => {
          elTrigger.addEventListener("click", () => {
            const strDialogId = elTrigger.getAttribute("data-open");
            const elDialog = document.getElementById(strDialogId);
            if (!elDialog) return;
            const strAction = elTrigger.dataset.action;
            if (strDialogId === "dlg-new-customer") {
              const elForm = elDialog.querySelector("form");
              elForm?.reset();
              fnSetNewCustomerDialogMode(elDialog, strAction);
              const preview = elDialog.querySelector("#nc-due-preview");
              if (preview) {
                const message =
                  preview.dataset.defaultMessage ||
                  "Due date will be assigned automatically from the item's policy.";
                preview.textContent = message;
              }
              requestAnimationFrame(() => {
                const focusTarget = elDialog.querySelector("#nc-first");
                focusTarget?.focus();
              });
            }
            if (strDialogId === "dlg-returning-borrow") {
              const elForm = document.getElementById("form-returning-borrow");
              elForm?.reset();
              const elPreview = document.getElementById("rb-due-preview");
              if (elPreview) {
                const strDefaultMessage =
                  elPreview.dataset.defaultMessage ||
                  "Due date will be assigned automatically from the item's policy.";
                elPreview.textContent = strDefaultMessage;
              }
              const elNameInput = document.getElementById("rb-name");
              if (elNameInput) {
                elNameInput.dataset.borrowerId = "";
              }
              requestAnimationFrame(() => {
                const elFocusTarget = document.getElementById("rb-id");
                if (elFocusTarget) {
                  elFocusTarget.focus();
                  elFocusTarget.select?.();
                }
              });
            } else if (strDialogId === "dlg-returning-service") {
              const elForm = document.getElementById("form-returning-service");
              elForm?.reset();
              const elNameInput = document.getElementById("rs-name");
              if (elNameInput) {
                elNameInput.dataset.borrowerId = "";
              }
              requestAnimationFrame(() => {
                const elFocusTarget = document.getElementById("rs-id");
                if (elFocusTarget) {
                  elFocusTarget.focus();
                  elFocusTarget.select?.();
                }
              });
            } else if (strDialogId === "dlg-create-user") {
              const elForm = document.getElementById("form-create-user");
              elForm?.reset();
              requestAnimationFrame(() => {
                const focusTarget = document.getElementById("cu-username");
                focusTarget?.focus();
              });
            } else if (strDialogId === "dlg-create-item") {
              const elForm = document.getElementById("form-create-item");
              elForm?.reset();
              fnUpdateItemDuePolicyVisibility();
            }
            elDialog.showModal();
          });
        });

        // ====== BUTTON FEEDBACK ======
        // add brief "pressed" visual handled via :active (already) + busy spinner while "saving"
        function fnWithAsyncBusy(btn, fn) {
          return async (e) => {
            e.preventDefault();
            fnSetBusyState(btn, true);
            try {
              await fn();
            } catch (err) {
              // Surface validation/network errors to the user right away.
              console.error(err);
              alert(err?.message || err);
            } finally {
              fnSetBusyState(btn, false);
            }
          };
        }

        /**
         * Update both the pill and its parent row so that status changes are
         * reflected consistently in every table. This is used when saving details
         * from the modal.
         */
        function fnUpdateRowVisualState(row, status) {
          const pill = row.querySelector(".pill");
          if (!pill) return;
          pill.textContent = status;
          pill.className = "pill"; // reset base classes first
          const pillClass = STATUS_PILL_CLASS_MAP[status];
          if (pillClass) pill.classList.add(pillClass);

          row.classList.remove(...ROW_STATUS_CLASSNAMES);
          const rowClass = STATUS_ROW_CLASS_MAP[status];
          if (rowClass) row.classList.add(rowClass);
        }

        // ====== STATUS → ROW COLOR (global) ======
        function fnApplyRowStatusStyles() {
          fnSelectAllElements("tbody tr").forEach((tr) => {
            tr.classList.remove(...ROW_STATUS_CLASSNAMES);
            const pill = tr.querySelector(".pill");
            if (!pill) return;
            const text = pill.textContent.trim();
            const cls = STATUS_ROW_CLASS_MAP[text];
            if (cls) tr.classList.add(cls);
          });
        }
        fnApplyRowStatusStyles();

        // ====== NEW CUSTOMER action-type toggle ======
        fnSetNewCustomerDialogMode(null, "borrow");

        // ====== NOTE HISTORY SUPPORT ======
        const m_mapDetailNoteCache = new Map();
        let m_arrCustomerProfiles = [];
        let m_boolCustomerProfilesLoaded = false;
        let m_boolCustomerProfilesLoading = false;
        let m_arrInventoryItems = [];
        let m_arrAdminUsers = [];
        let m_arrAuditLogEntries = [];
        let m_strAuditLogSearchTerm = "";
        let m_strInventorySearchTerm = "";
        let m_strAdminUserSearchTerm = "";
        let m_strActiveDetailNoteKey = null;
        let m_objActiveCustomerProfile = null;
        let m_objActiveInventoryItem = null;
        let m_objActiveUser = null;
        let m_intProfileSearchToken = 0;
        let m_strLastProfileSearchTerm = "";

        function fnNormalizeNoteId(kind, id) {
          if (kind === "loan") {
            const num = Number.parseInt(id, 10);
            return Number.isFinite(num) ? String(num) : null;
          }
          if (kind === "ticket") {
            const str = `${id}`.trim();
            return str ? str : null;
          }
          return null;
        }

        function fnCreateNoteCacheKey(kind, id) {
          const normalized = fnNormalizeNoteId(kind, id);
          if (!normalized) return null;
          return `${kind}:${normalized}`;
        }

        function fnRenderNoteHistory(entries, state = "ready") {
          const log = fnSelectElement("#det-note-log");
          if (!log) return;
          log.textContent = "";

          if (state === "loading") {
            const p = document.createElement("p");
            p.className = "note-empty";
            p.textContent = "Loading notes…";
            log.appendChild(p);
            return;
          }

          if (state === "error") {
            const p = document.createElement("p");
            p.className = "note-empty";
            p.textContent = "Unable to load notes.";
            log.appendChild(p);
            return;
          }

          const list = Array.isArray(entries) ? entries : [];
          if (list.length === 0) {
            const p = document.createElement("p");
            p.className = "note-empty";
            p.textContent = "No notes yet.";
            log.appendChild(p);
            return;
          }

          list.forEach((entry) => {
            const wrapper = document.createElement("div");
            wrapper.className = "note-entry";

            const meta = document.createElement("div");
            meta.className = "note-meta";

            const author = document.createElement("span");
            author.textContent = entry.author || "User";

            const time = document.createElement("time");
            if (entry.timestamp) {
              time.dateTime = entry.timestamp;
              time.textContent = fnFormatLocalDateTime(entry.timestamp);
            } else {
              time.textContent = "—";
            }

            meta.appendChild(author);
            meta.appendChild(time);

            const text = document.createElement("p");
            text.className = "note-text";
            text.textContent = entry.note || "";

            wrapper.appendChild(meta);
            wrapper.appendChild(text);
            log.appendChild(wrapper);
          });
        }

        async function fnFetchDetailNotes(kind, id, { force = false } = {}) {
          const key = fnCreateNoteCacheKey(kind, id);
          if (!key) throw new Error("Invalid record id for notes.");
          if (!force && m_mapDetailNoteCache.has(key)) {
            return m_mapDetailNoteCache.get(key);
          }

          let path;
          if (kind === "loan") {
            const normalized = fnNormalizeNoteId(kind, id);
            if (!normalized) throw new Error("Invalid loan id.");
            path = `/loans/${encodeURIComponent(normalized)}/notes`;
          } else if (kind === "ticket") {
            const normalized = fnNormalizeNoteId(kind, id);
            if (!normalized) throw new Error("Invalid ticket id.");
            path = `/service-tickets/${encodeURIComponent(normalized)}/notes`;
          } else {
            return [];
          }

          const res = await fnApi(path, { method: "GET" });
          const payload = await res.json();
          const entries = Array.isArray(payload?.entries)
            ? payload.entries
            : Array.isArray(payload)
              ? payload
              : [];
          m_mapDetailNoteCache.set(key, entries);
          return entries;
        }

        async function fnLoadDetailNotes(kind, id) {
          const key = fnCreateNoteCacheKey(kind, id);
          if (!key) {
            m_strActiveDetailNoteKey = null;
            fnRenderNoteHistory([], "error");
            return;
          }

          m_strActiveDetailNoteKey = key;
          const cached = m_mapDetailNoteCache.get(key);
          if (cached) {
            fnRenderNoteHistory(cached);
          } else {
            fnRenderNoteHistory(null, "loading");
          }

          try {
            const entries = await fnFetchDetailNotes(kind, id, { force: true });
            if (m_strActiveDetailNoteKey === key) {
              fnRenderNoteHistory(entries);
            }
          } catch (err) {
            console.error("Failed to load notes", err);
            if (m_strActiveDetailNoteKey === key) {
              fnRenderNoteHistory(null, "error");
            }
          }
        }

        function fnMapTypeToKind(type) {
          if (type === "Loan") return "loan";
          if (type === "Service Ticket") return "ticket";
          return null;
        }

        // ====== TABLE ROW → DETAILS ======
        function fnConfigureDetailStatusSelect(selectEl, kind, currentStatus) {
          const options = DETAIL_STATUS_OPTIONS[kind] || [];
          selectEl.innerHTML = "";
          options.forEach((text) => {
            const option = document.createElement("option");
            option.value = text;
            option.textContent = text;
            selectEl.appendChild(option);
          });
          if (currentStatus && !options.includes(currentStatus)) {
            const fallback = document.createElement("option");
            fallback.value = currentStatus;
            fallback.textContent = currentStatus;
            selectEl.appendChild(fallback);
          }
          if (currentStatus) {
            selectEl.value = currentStatus;
          } else if (options.length) {
            selectEl.value = options[0];
          } else {
            selectEl.value = "";
          }
        }

        const openDetail = (kind, id, primary, status) => {
          const dlg = document.getElementById("dlg-detail");
          fnSelectElement("#det-title").textContent =
            kind === "loan" ? "Borrow Log Details" : "Service Ticket Details";
          fnSelectElement("#det-type").value =
            kind === "loan" ? "Loan" : "Service Ticket";
          fnSelectElement("#det-id").value = id;
          fnSelectElement("#det-primary").value = primary || "";
          const sel = fnSelectElement("#det-status");
          const allowedStatuses =
            kind === "loan" ? LOAN_STATUSES : TICKET_STATUSES;
          let matchFound = false;
          Array.from(sel.options).forEach((option) => {
            const isAllowed = allowedStatuses.includes(option.value);
            option.hidden = !isAllowed;
            option.disabled = !isAllowed;
            if (isAllowed && option.value === status) {
              matchFound = true;
            }
          });
          if (matchFound) {
            sel.value = status;
          } else if (allowedStatuses.length > 0) {
            sel.value = allowedStatuses[0];
          } else {
            sel.value = "";
          }
          fnSelectElement("#det-note").value = "";
          fnLoadDetailNotes(kind, id);
          dlg.showModal();
        };

        function fnAttachRowClicks(scopeId) {
          const tbody = document.getElementById(scopeId);
          if (!tbody) return;
          tbody.addEventListener("click", (e) => {
            const tr = e.target.closest("tr.clickable");
            if (!tr) return;
            const kind = tr.dataset.kind;
            const id = tr.dataset.id;
            const cells = Array.from(tr.querySelectorAll("td")).map((td) =>
              td.textContent.trim(),
            );
            const primary =
              kind === "loan"
                ? `${cells[1]} — ${cells[0]}`
                : `${cells[1]} — ${cells[0]}`;
            const pill = tr.querySelector(".pill");
            const status = pill
              ? pill.textContent.trim()
              : kind === "loan"
              ? "On Time"
              : "";
            openDetail(kind, id, primary, status);
          });
        }
        [
          "tbl-home-out",
          "tbl-home-repairs",
          "tbl-borrow",
          "tbl-service",
        ].forEach(fnAttachRowClicks);

        // ====== FILTERS + SEARCH (client-side) ======
        /**
         * Wire up the filter chips + optional search box to a table body. Each
         * call creates an isolated controller so the Borrowing and Service tables
         * can share the exact same behavior without duplicating the logic.
         */
        function fnHookFilters(chipsContainerId, tableBodyId, searchInputId) {
          const chips = fnSelectAllElements("#" + chipsContainerId + " .chip");
          const tbody = fnSelectElement("#" + tableBodyId);
          const searchInput = searchInputId
            ? fnSelectElement("#" + searchInputId)
            : null;
          let active = "all";
          const setActive = (val) => {
            active = val;
            chips.forEach((c) =>
              c.classList.toggle("active", c.dataset.filter === val),
            );
            chips.forEach((c) => {
              if (c.dataset.filter === "all")
                c.classList.toggle("active", val === "all");
            });
            fnApplyFilters();
          };
          chips.forEach((c) =>
            c.addEventListener("click", () => setActive(c.dataset.filter)),
          );
          if (searchInput) {
            searchInput.addEventListener("input", fnApplyFilters);
          }
          function fnApplyFilters() {
            const q = (searchInput?.value || "").toLowerCase();
            Array.from(tbody.rows).forEach((tr) => {
              const pill = tr.querySelector(".pill");
              const status = pill ? pill.textContent.trim() : "";
              const matchesStatus = active === "all" || status === active;
              const text = tr.textContent.toLowerCase();
              const matchesSearch = !q || text.includes(q);
              tr.style.display = matchesStatus && matchesSearch ? "" : "none";
            });
          }
          return { fnApplyFilters, setActive };
        }
        const borrowFilterController = fnHookFilters(
          "filters-borrow",
          "tbl-borrow",
          "search-borrow",
        );
        const serviceFilterController = fnHookFilters(
          "filters-service",
          "tbl-service",
          "search-service",
        );

        function fnSortBorrowRowsForOverdue() {
          const tbody = document.getElementById("tbl-borrow");
          if (!tbody) return;
          const rows = Array.from(tbody.querySelectorAll("tr"));
          rows.sort((a, b) => {
            const statusA = a.querySelector(".pill")?.textContent?.trim() || "";
            const statusB = b.querySelector(".pill")?.textContent?.trim() || "";
            const overdueA = statusA === "Overdue" ? 0 : 1;
            const overdueB = statusB === "Overdue" ? 0 : 1;
            if (overdueA !== overdueB) return overdueA - overdueB;

            const dueA =
              a.querySelector("td:nth-child(6)")?.dataset.utc || "9999-12-31T23:59:59Z";
            const dueB =
              b.querySelector("td:nth-child(6)")?.dataset.utc || "9999-12-31T23:59:59Z";
            return dueA.localeCompare(dueB);
          });
          rows.forEach((row) => tbody.appendChild(row));
        }

        const overdueButton = document.getElementById("btn-view-overdue");
        if (overdueButton) {
          overdueButton.addEventListener("click", async () => {
            await fnLoadBorrowingData();
            borrowFilterController?.setActive?.("Overdue");
            fnSortBorrowRowsForOverdue();
          });
        }

        // ====== DATA FETCH + RENDERING ======
        async function fnFetchDashboardStats() {
          const res = await fnApi(`/dashboard-stats`, { method: "GET" });
          return res.json();
        }

        async function fnFetchLoans(params = {}) {
          const searchParams = new URLSearchParams();
          if (params.top != null) searchParams.set("top", params.top);
          if (params.status) searchParams.set("status", params.status);
          if (params.search) searchParams.set("search", params.search);
          const qs = searchParams.toString();
          const res = await fnApi(`/loans${qs ? `?${qs}` : ""}`, {
            method: "GET",
          });
          const payload = await res.json();
          if (Array.isArray(payload)) return payload;
          if (Array.isArray(payload?.entries)) return payload.entries;
          if (Array.isArray(payload?.data)) return payload.data;
          return [];
        }

        async function fnFetchServiceTickets(params = {}) {
          const searchParams = new URLSearchParams();
          if (params.top != null) searchParams.set("top", params.top);
          if (params.status) searchParams.set("status", params.status);
          if (params.search) searchParams.set("search", params.search);
          const qs = searchParams.toString();
          const res = await fnApi(`/service-tickets${qs ? `?${qs}` : ""}`, {
            method: "GET",
          });
          const payload = await res.json();
          if (Array.isArray(payload)) return payload;
          if (Array.isArray(payload?.entries)) return payload.entries;
          if (Array.isArray(payload?.data)) return payload.data;
          return [];
        }

        function fnSetStatsLoading() {
          fnSelectAllElements("[data-stat]").forEach(
            (el) => (el.textContent = "…"),
          );
        }

        function fnSetStatsError() {
          fnSelectAllElements("[data-stat]").forEach(
            (el) => (el.textContent = "—"),
          );
        }

        function fnRenderStats(stats) {
          if (!stats) {
            fnSetStatsError();
            return;
          }
          const map = {
            outNow: stats.outNow ?? stats.checkedOut ?? 0,
            dueToday: stats.dueToday ?? 0,
            repairs: stats.repairs ?? stats.inRepairs ?? 0,
            overdue: stats.overdue ?? 0,
          };
          Object.entries(map).forEach(([key, val]) => {
            const el = document.querySelector(`[data-stat="${key}"]`);
            if (el) el.textContent = val;
          });
        }

        function fnRenderLoanRows(tbodyId, loans, mode) {
          const tbody = document.getElementById(tbodyId);
          if (!tbody) return;
          tbody.textContent = "";
          if (!Array.isArray(loans) || loans.length === 0) {
            const message =
              mode === "home"
                ? "No items currently checked out."
                : "No loans found.";
            fnShowTableMessage(tbodyId, message);
            return;
          }
          loans.forEach((loan) => {
            const tr = document.createElement("tr");
            tr.classList.add("clickable");
            tr.dataset.kind = "loan";
            tr.dataset.id = loan.id ?? loan.traceNumber ?? "";
            if (mode === "home") {
              fnAppendTableCell(tr, loan.itemName || "—");
              fnAppendTableCell(tr, loan.borrowerName || "—");
              fnAppendTableCell(tr, loan.borrowerSchoolId || "—");
              fnAppendTableCell(tr, loan.room || "—");
              const dueCell = fnAppendTableCell(
                tr,
                fnFormatLocalDateTime(loan.dueUtc),
              );
              if (loan.dueUtc) dueCell.dataset.utc = loan.dueUtc;
              fnAppendTableCell(tr, fnFormatDueIn(loan));
            } else {
              fnAppendTableCell(tr, loan.traceNumber || loan.id || "—");
              fnAppendTableCell(tr, loan.itemName || "—");
              fnAppendTableCell(tr, loan.borrowerName || "—");
              fnAppendTableCell(tr, loan.borrowerSchoolId || "—");
              fnAppendTableCell(tr, fnFormatLocalDateTime(loan.checkoutUtc));
              const dueCell = fnAppendTableCell(
                tr,
                fnFormatLocalDateTime(loan.dueUtc),
              );
              if (loan.dueUtc) dueCell.dataset.utc = loan.dueUtc;
              fnAppendTableCell(tr, fnFormatDueIn(loan));
            }
            fnAppendTableCell(tr, fnCreateStatusPill(loan.status || ""));
            tbody.appendChild(tr);
          });
          fnApplyRowStatusStyles();
        }

        function fnRenderTicketRows(tbodyId, tickets, mode) {
          const tbody = document.getElementById(tbodyId);
          if (!tbody) return;
          tbody.textContent = "";
          if (!Array.isArray(tickets) || tickets.length === 0) {
            const message =
              mode === "home"
                ? "No active service tickets."
                : "No service tickets found.";
            fnShowTableMessage(tbodyId, message);
            return;
          }
          tickets.forEach((ticket) => {
            const tr = document.createElement("tr");
            tr.classList.add("clickable");
            tr.dataset.kind = "ticket";
            tr.dataset.id = ticket.publicId || ticket.id || "";
            if (mode === "home") {
              fnAppendTableCell(tr, ticket.itemName || "—");
              fnAppendTableCell(tr, ticket.issue || "—");
              fnAppendTableCell(
                tr,
                ticket.loggedByName || ticket.assignedName || "—",
              );
              fnAppendTableCell(tr, fnFormatLocalDateTime(ticket.loggedUtc));
            } else {
              fnAppendTableCell(tr, ticket.publicId || "—");
              fnAppendTableCell(tr, ticket.itemName || "—");
              fnAppendTableCell(tr, ticket.issue || "—");
              fnAppendTableCell(tr, fnFormatLocalDateTime(ticket.loggedUtc));
              fnAppendTableCell(tr, ticket.assignedName || "—");
            }
            fnAppendTableCell(tr, fnCreateStatusPill(ticket.status || ""));
            tbody.appendChild(tr);
          });
          fnApplyRowStatusStyles();
        }

        function fnRenderCustomerProfiles(entries) {
          const tbodyId = "tbl-customer-profiles";
          const tbody = document.getElementById(tbodyId);
          if (!tbody) return;
          tbody.textContent = "";
          if (!Array.isArray(entries) || entries.length === 0) {
            fnShowTableMessage(tbodyId, "No profiles found.");
            return;
          }
          entries.forEach((profile) => {
            const tr = document.createElement("tr");
            fnAppendTableCell(tr, profile.name || "—");
            fnAppendTableCell(tr, profile.schoolId || "—");
            const aliases =
              Array.isArray(profile.aliases) && profile.aliases.length
                ? profile.aliases.map((a) => a.alias).join(", ")
                : "—";
            fnAppendTableCell(tr, aliases);
            const actionCell = document.createElement("td");
            const wrap = document.createElement("div");
            wrap.style.display = "flex";
            wrap.style.gap = "6px";
            wrap.style.flexWrap = "wrap";
            const editBtn = document.createElement("button");
            editBtn.type = "button";
            editBtn.className = "btn";
            editBtn.dataset.editProfile = profile.id ?? "";
            editBtn.textContent = "Edit";
            editBtn.setAttribute(
              "aria-label",
              `Edit profile for ${profile.name || "customer"}`,
            );
            const deleteBtn = document.createElement("button");
            deleteBtn.type = "button";
            deleteBtn.className = "btn danger";
            deleteBtn.dataset.deleteProfile = profile.id ?? "";
            deleteBtn.textContent = "Delete";
            deleteBtn.setAttribute(
              "aria-label",
              `Delete profile for ${profile.name || "customer"}`,
            );
            wrap.append(editBtn, deleteBtn);
            actionCell.appendChild(wrap);
            tr.appendChild(actionCell);
            tbody.appendChild(tr);
          });
        }

        async function fnLoadHomeData() {
          try {
            const [stats, loans, tickets] = await Promise.all([
              fnFetchDashboardStats(),
              fnFetchLoans({ top: 10 }),
              fnFetchServiceTickets({ top: 10 }),
            ]);
            fnRenderStats(stats);
            const activeLoans = loans
              .filter((loan) => loan.status !== "Returned")
              .slice(0, 5);
            fnRenderLoanRows("tbl-home-out", activeLoans, "home");
            const activeTickets = tickets
              .filter(
                (ticket) => !["Completed", "Cancelled"].includes(ticket.status),
              )
              .slice(0, 5);
            fnRenderTicketRows("tbl-home-repairs", activeTickets, "home");
          } catch (err) {
            console.error("Failed to load dashboard data", err);
            fnSetStatsError();
            fnShowTableMessage(
              "tbl-home-out",
              "Unable to load current checkouts.",
              "error",
            );
            fnShowTableMessage(
              "tbl-home-repairs",
              "Unable to load service tickets.",
              "error",
            );
          }
        }

        async function fnLoadBorrowingData() {
          try {
            const loans = await fnFetchLoans({ top: 50 });
            fnRenderLoanRows("tbl-borrow", loans, "borrow");
            borrowFilterController?.fnApplyFilters();
          } catch (err) {
            console.error("Failed to load loan records", err);
            fnShowTableMessage("tbl-borrow", "Unable to load loans.", "error");
          }
        }

        async function fnLoadServiceData() {
          try {
            const tickets = await fnFetchServiceTickets({ top: 50 });
            fnRenderTicketRows("tbl-service", tickets, "service");
            serviceFilterController?.fnApplyFilters();
          } catch (err) {
            console.error("Failed to load service tickets", err);
            fnShowTableMessage(
              "tbl-service",
              "Unable to load service tickets.",
              "error",
            );
          }
        }

        async function fnRefreshOperationalData({ includeService = true } = {}) {
          const refreshTasks = [fnLoadHomeData(), fnLoadBorrowingData()];
          if (includeService) refreshTasks.push(fnLoadServiceData());
          await Promise.allSettled(refreshTasks);
        }

        function fnRenderInventoryTable(entries) {
          const tbodyId = "tbl-admin-inventory";
          const tbody = document.getElementById(tbodyId);
          if (!tbody) return;
          tbody.textContent = "";
          if (!USE_BACKEND) {
            fnShowTableMessage(
              tbodyId,
              "Enable backend to manage inventory items.",
            );
            return;
          }
          if (!Array.isArray(entries) || entries.length === 0) {
            const message = m_arrInventoryItems.length
              ? "No inventory items match your search."
              : "No inventory items found.";
            fnShowTableMessage(tbodyId, message);
            return;
          }
          entries.forEach((item) => {
            const tr = document.createElement("tr");
            tr.classList.add("clickable");
            tr.dataset.itemId = item.id != null ? item.id : "";
            fnAppendTableCell(tr, item.name || "—");
            fnAppendTableCell(tr, item.department || "—");
            fnAppendTableCell(tr, fnFormatItemDuePolicy(item));
            tbody.appendChild(tr);
          });
        }

        function fnFilterInventoryEntries(entries, term) {
          if (!Array.isArray(entries)) return [];
          const normalized = (term || "").trim().toLowerCase();
          if (!normalized) return entries.slice();
          return entries.filter((item) => {
            const parts = [
              item.name,
              item.department,
              item.duePolicy,
              item.duePolicyDescription,
              fnFormatItemDuePolicy(item),
            ];
            return parts.some((part) =>
              (part || "").toString().toLowerCase().includes(normalized),
            );
          });
        }

        function fnUpdateInventorySearch(term) {
          m_strInventorySearchTerm = (term || "").trim();
          const filtered = fnFilterInventoryEntries(
            m_arrInventoryItems,
            m_strInventorySearchTerm,
          );
          fnRenderInventoryTable(filtered);
        }

        async function fnLoadInventoryData({ showStatus = true } = {}) {
          if (!USE_BACKEND) {
            m_arrInventoryItems = [];
            ["nc-item", "rb-item", "ns-item", "rs-item"].forEach((id) => {
              const select = document.getElementById(id);
              if (select) fnPopulateItemSelect(select, []);
            });
            fnRenderInventoryTable([]);
            return;
          }
          if (showStatus) {
            fnShowTableMessage("tbl-admin-inventory", "Loading inventory…");
          }
          try {
            const items = await fnFetchItems();
            const sorted = Array.isArray(items)
              ? items
                  .slice()
                  .sort((a, b) =>
                    (a.name || "").localeCompare(b.name || "", undefined, {
                      sensitivity: "base",
                    }),
                  )
              : [];
            m_arrInventoryItems = sorted;
            const optionList = sorted
              .filter((item) => item && item.name)
              .map((item) => ({
                id: item.id ?? null,
                name: item.name || "",
              }));
            ["nc-item", "rb-item", "ns-item", "rs-item"].forEach((id) => {
              const select = document.getElementById(id);
              if (select) fnPopulateItemSelect(select, optionList);
            });
            fnUpdateInventorySearch(m_strInventorySearchTerm);
          } catch (err) {
            console.error("Failed to load inventory items", err);
            fnShowTableMessage(
              "tbl-admin-inventory",
              "Unable to load inventory items.",
              "error",
            );
          }
        }

        function fnRenderAdminUsersTable(entries) {
          const tbodyId = "tbl-admin-users";
          const tbody = document.getElementById(tbodyId);
          if (!tbody) return;
          tbody.textContent = "";
          if (!USE_BACKEND) {
            fnShowTableMessage(
              tbodyId,
              "Enable backend to load user profiles.",
            );
            return;
          }
          if (!Array.isArray(entries) || entries.length === 0) {
            const message = m_arrAdminUsers.length
              ? "No user profiles match your search."
              : "No user profiles found.";
            fnShowTableMessage(tbodyId, message);
            return;
          }
          entries.forEach((user) => {
            const tr = document.createElement("tr");
            tr.classList.add("clickable");
            tr.dataset.username = user.username || "";
            fnAppendTableCell(tr, user.username || "—");
            fnAppendTableCell(tr, user.displayName || "—");
            fnAppendTableCell(tr, fnFormatUserRole(user.role));
            fnAppendTableCell(
              tr,
              user.createdUtc ? fnFormatLocalDateTime(user.createdUtc) : "—",
            );
            tbody.appendChild(tr);
          });
        }

        function fnFilterAdminUsers(entries, term) {
          if (!Array.isArray(entries)) return [];
          const normalized = (term || "").trim().toLowerCase();
          if (!normalized) return entries.slice();
          return entries.filter((user) => {
            const fields = [
              user.username,
              user.displayName,
              user.role,
              fnFormatUserRole(user.role),
            ];
            return fields.some((field) =>
              (field || "").toString().toLowerCase().includes(normalized),
            );
          });
        }

        function fnUpdateAdminUserSearch(term) {
          m_strAdminUserSearchTerm = (term || "").trim();
          const filtered = fnFilterAdminUsers(
            m_arrAdminUsers,
            m_strAdminUserSearchTerm,
          );
          fnRenderAdminUsersTable(filtered);
        }

        async function fnLoadAdminUsers({ showStatus = true } = {}) {
          if (!USE_BACKEND) {
            m_arrAdminUsers = [];
            fnRenderAdminUsersTable([]);
            return;
          }
          if (showStatus) {
            fnShowTableMessage("tbl-admin-users", "Loading user profiles…");
          }
          try {
            const users = await fnFetchUsers();
            const sorted = Array.isArray(users)
              ? users
                  .slice()
                  .sort((a, b) =>
                    (a.username || "").localeCompare(
                      b.username || "",
                      undefined,
                      { sensitivity: "base" },
                    ),
                  )
              : [];
            m_arrAdminUsers = sorted;
            fnUpdateAdminUserSearch(m_strAdminUserSearchTerm);
          } catch (err) {
            console.error("Failed to load user profiles", err);
            fnShowTableMessage(
              "tbl-admin-users",
              "Unable to load user profiles.",
              "error",
            );
          }
        }

        function fnRenderInventoryTable(entries) {
          const tbodyId = "tbl-admin-inventory";
          const tbody = document.getElementById(tbodyId);
          if (!tbody) return;
          tbody.textContent = "";
          if (!USE_BACKEND) {
            fnShowTableMessage(
              tbodyId,
              "Enable backend to manage inventory items.",
            );
            return;
          }
          if (!Array.isArray(entries) || entries.length === 0) {
            const message = m_arrInventoryItems.length
              ? "No inventory items match your search."
              : "No inventory items found.";
            fnShowTableMessage(tbodyId, message);
            return;
          }
          entries.forEach((item) => {
            const tr = document.createElement("tr");
            fnAppendTableCell(tr, item.name || "—");
            fnAppendTableCell(tr, item.department || "—");
            fnAppendTableCell(tr, fnFormatItemDuePolicy(item));
            const actionCell = document.createElement("td");
            const wrap = document.createElement("div");
            wrap.style.display = "flex";
            wrap.style.gap = "6px";
            wrap.style.flexWrap = "wrap";
            const editBtn = document.createElement("button");
            editBtn.type = "button";
            editBtn.className = "btn";
            editBtn.dataset.editItem = item.id != null ? item.id : "";
            editBtn.textContent = "Edit";
            const deleteBtn = document.createElement("button");
            deleteBtn.type = "button";
            deleteBtn.className = "btn danger";
            deleteBtn.dataset.deleteItem = item.id != null ? item.id : "";
            deleteBtn.textContent = "Delete";
            wrap.append(editBtn, deleteBtn);
            actionCell.appendChild(wrap);
            tr.appendChild(actionCell);
            tbody.appendChild(tr);
          });
        }

        function fnFilterInventoryEntries(entries, term) {
          if (!Array.isArray(entries)) return [];
          const normalized = (term || "").trim().toLowerCase();
          if (!normalized) return entries.slice();
          return entries.filter((item) => {
            const parts = [
              item.name,
              item.department,
              item.duePolicy,
              item.duePolicyDescription,
              fnFormatItemDuePolicy(item),
            ];
            return parts.some((part) =>
              (part || "").toString().toLowerCase().includes(normalized),
            );
          });
        }

        function fnUpdateInventorySearch(term) {
          m_strInventorySearchTerm = (term || "").trim();
          const filtered = fnFilterInventoryEntries(
            m_arrInventoryItems,
            m_strInventorySearchTerm,
          );
          fnRenderInventoryTable(filtered);
        }

        async function fnLoadInventoryData({ showStatus = true } = {}) {
          if (!USE_BACKEND) {
            m_arrInventoryItems = [];
            ["nc-item", "rb-item", "ns-item", "rs-item"].forEach((id) => {
              const select = document.getElementById(id);
              if (select) fnPopulateItemSelect(select, []);
            });
            fnRenderInventoryTable([]);
            return;
          }
          if (showStatus) {
            fnShowTableMessage("tbl-admin-inventory", "Loading inventory…");
          }
          try {
            const items = await fnFetchItems();
            const sorted = Array.isArray(items)
              ? items
                  .slice()
                  .sort((a, b) =>
                    (a.name || "").localeCompare(b.name || "", undefined, {
                      sensitivity: "base",
                    }),
                  )
              : [];
            m_arrInventoryItems = sorted;
            const optionList = sorted
              .filter((item) => item && item.name)
              .map((item) => ({
                id: item.id ?? null,
                name: item.name || "",
              }));
            ["nc-item", "rb-item", "ns-item", "rs-item"].forEach((id) => {
              const select = document.getElementById(id);
              if (select) fnPopulateItemSelect(select, optionList);
            });
            fnUpdateInventorySearch(m_strInventorySearchTerm);
          } catch (err) {
            console.error("Failed to load inventory items", err);
            fnShowTableMessage(
              "tbl-admin-inventory",
              "Unable to load inventory items.",
              "error",
            );
          }
        }

        async function fnDeleteInventoryItem(button, id) {
          if (!USE_BACKEND) {
            alert("Enable backend to manage inventory items.");
            return;
          }
          if (!id) return;
          if (
            !window.confirm(
              "Delete this item? This action cannot be undone.",
            )
          ) {
            return;
          }
          try {
            if (button) fnSetBusyState(button, true);
            await fnApi(`/items/${encodeURIComponent(id)}`, {
              method: "DELETE",
            });
            if (
              m_objActiveInventoryItem &&
              String(m_objActiveInventoryItem.id || "") === String(id)
            ) {
              m_objActiveInventoryItem = null;
              fnCloseDialogById("dlg-manage-item");
            }
            alert("Item deleted.");
            await fnLoadInventoryData({ showStatus: false });
          } catch (err) {
            console.error("Failed to delete item", err);
            alert(err?.message || "Unable to delete item.");
          } finally {
            if (button) fnSetBusyState(button, false);
          }
        }

        function fnRenderAdminUsersTable(entries) {
          const tbodyId = "tbl-admin-users";
          const tbody = document.getElementById(tbodyId);
          if (!tbody) return;
          tbody.textContent = "";
          if (!USE_BACKEND) {
            fnShowTableMessage(
              tbodyId,
              "Enable backend to load user profiles.",
            );
            return;
          }
          if (!Array.isArray(entries) || entries.length === 0) {
            const message = m_arrAdminUsers.length
              ? "No user profiles match your search."
              : "No user profiles found.";
            fnShowTableMessage(tbodyId, message);
            return;
          }
          entries.forEach((user) => {
            const tr = document.createElement("tr");
            fnAppendTableCell(tr, user.username || "—");
            fnAppendTableCell(tr, user.displayName || "—");
            fnAppendTableCell(
              tr,
              fnFormatUserRole(user.roleLabel || user.role),
            );
            fnAppendTableCell(
              tr,
              user.createdUtc ? fnFormatLocalDateTime(user.createdUtc) : "—",
            );
            const actionCell = document.createElement("td");
            const wrap = document.createElement("div");
            wrap.style.display = "flex";
            wrap.style.gap = "6px";
            wrap.style.flexWrap = "wrap";
            const editBtn = document.createElement("button");
            editBtn.type = "button";
            editBtn.className = "btn";
            editBtn.dataset.editUser = user.username || "";
            editBtn.textContent = "Edit";
            const deleteBtn = document.createElement("button");
            deleteBtn.type = "button";
            deleteBtn.className = "btn danger";
            deleteBtn.dataset.deleteUser = user.username || "";
            deleteBtn.textContent = "Delete";
            wrap.append(editBtn, deleteBtn);
            actionCell.appendChild(wrap);
            tr.appendChild(actionCell);
            tbody.appendChild(tr);
          });
        }

        function fnFilterAdminUsers(entries, term) {
          if (!Array.isArray(entries)) return [];
          const normalized = (term || "").trim().toLowerCase();
          if (!normalized) return entries.slice();
          return entries.filter((user) => {
            const fields = [
              user.username,
              user.displayName,
              user.role,
              fnFormatUserRole(user.role),
            ];
            return fields.some((field) =>
              (field || "").toString().toLowerCase().includes(normalized),
            );
          });
        }

        function fnUpdateAdminUserSearch(term) {
          m_strAdminUserSearchTerm = (term || "").trim();
          const filtered = fnFilterAdminUsers(
            m_arrAdminUsers,
            m_strAdminUserSearchTerm,
          );
          fnRenderAdminUsersTable(filtered);
        }

        async function fnLoadAdminUsers({ showStatus = true } = {}) {
          if (!USE_BACKEND) {
            m_arrAdminUsers = [];
            fnRenderAdminUsersTable([]);
            return;
          }
          if (showStatus) {
            fnShowTableMessage("tbl-admin-users", "Loading user profiles…");
          }
          try {
            const users = await fnFetchUsers();
            const sorted = Array.isArray(users)
              ? users
                  .slice()
                  .sort((a, b) =>
                    (a.username || "").localeCompare(
                      b.username || "",
                      undefined,
                      { sensitivity: "base" },
                    ),
                  )
              : [];
            m_arrAdminUsers = sorted;
            fnUpdateAdminUserSearch(m_strAdminUserSearchTerm);
          } catch (err) {
            console.error("Failed to load user profiles", err);
            fnShowTableMessage(
              "tbl-admin-users",
              "Unable to load user profiles.",
              "error",
            );
          }
        }

        async function fnDeleteUser(button, username) {
          if (!USE_BACKEND) {
            alert("Enable backend to manage user profiles.");
            return;
          }
          if (!username) return;
          if (
            !window.confirm(
              "Delete this user account? Only allowed when no historical activity exists.",
            )
          )
            return;
          try {
            if (button) fnSetBusyState(button, true);
            await fnApi(`/users/${encodeURIComponent(username)}`, {
              method: "DELETE",
            });
            if (
              m_objActiveUser &&
              (m_objActiveUser.username || "").toLowerCase() ===
                username.toLowerCase()
            ) {
              m_objActiveUser = null;
              fnCloseDialogById("dlg-edit-user");
            }
            alert("User deleted.");
            await fnLoadAdminUsers({ showStatus: false });
          } catch (err) {
            console.error("Failed to delete user", err);
            alert(err?.message || "Unable to delete user.");
          } finally {
            if (button) fnSetBusyState(button, false);
          }
        }

        // ====== VALIDATION HELPERS ======
        // Tiny validation helpers shared by multiple forms.
        function fnMust(cond, msg) {
          if (!cond) throw new Error(msg);
        }
        function fnRequireOne(valA, valB, msg) {
          fnMust((valA && valA.trim()) || (valB && valB.trim()), msg);
        }

        function fnDebounce(fn, wait = 200) {
          let timeout;
          return function (...args) {
            if (timeout) clearTimeout(timeout);
            timeout = setTimeout(() => fn.apply(this, args), wait);
          };
        }

        function fnNormalizeDueText(value) {
          if (!value) return null;
          const formatted = fnFormatLocalDateTime(value);
          return formatted && formatted !== "—" ? formatted : null;
        }

        function fnFormatDateTimeLocalInput(value) {
          const dt = fnSafeDate(value);
          if (!dt) return "";
          const pad = (num) => String(num).padStart(2, "0");
          const year = dt.getFullYear();
          const month = pad(dt.getMonth() + 1);
          const day = pad(dt.getDate());
          const hours = pad(dt.getHours());
          const minutes = pad(dt.getMinutes());
          return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function fnFormatTimeForInput(value) {
          if (!value) return "";
          if (typeof value === "string") {
            const trimmed = value.trim();
            if (!trimmed) return "";
            return trimmed.substring(0, 5);
          }
          const dt = fnSafeDate(`1970-01-01T${value}`);
          if (!dt) return "";
          const pad = (num) => String(num).padStart(2, "0");
          return `${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
        }

        function fnNormalizeUserRole(value) {
          if (value == null) return null;
          const text = value.toString().trim().toLowerCase();
          if (!text) return null;
          if (USER_ROLE_ALIASES.has(text)) return USER_ROLE_ALIASES.get(text);
          const collapsedSpaces = text.replace(/[\s_]+/g, " ");
          if (USER_ROLE_ALIASES.has(collapsedSpaces))
            return USER_ROLE_ALIASES.get(collapsedSpaces);
          const collapsed = text.replace(/[\s_-]+/g, "");
          if (USER_ROLE_ALIASES.has(collapsed))
            return USER_ROLE_ALIASES.get(collapsed);
          return null;
        }

        function fnFormatUserRole(role) {
          const canonical = fnNormalizeUserRole(role);
          if (canonical && USER_ROLE_LABELS.has(canonical)) {
            return USER_ROLE_LABELS.get(canonical);
          }
          if (!role) return "—";
          return role
            .toString()
            .split(/[_\s]+/)
            .filter(Boolean)
            .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
            .join(" ");
        }

        function fnFormatItemDuePolicy(item) {
          if (!item) return "—";
          if (item.duePolicyDescription) return item.duePolicyDescription;
          const policy = (item.duePolicy || "").toUpperCase();
          if (!policy) return "—";
          if (policy === "NEXT_DAY_6PM") return "Next day at 6:00 PM";
          if (policy === "OFFSET") {
            const days = Number.isFinite(item.dueDaysOffset)
              ? item.dueDaysOffset
              : null;
            const hours = Number.isFinite(item.dueHoursOffset)
              ? item.dueHoursOffset
              : null;
            const time = fnFormatTimeForInput(item.dueTime) || "";
            const parts = [];
            if (days != null) {
              parts.push(
                `${days} day${days === 1 ? "" : "s"}`,
              );
            }
            if (hours != null && hours !== 0) {
              parts.push(
                `${hours} hour${hours === 1 ? "" : "s"}`,
              );
            }
            if (time) {
              parts.push(`at ${time}`);
            }
            return parts.length
              ? `Offset ${parts.join(" ")}`
              : "Custom offset";
          }
          if (policy === "SEMESTER" || policy === "FIXED") {
            const fixed = fnNormalizeDueText(item.fixedDueLocal);
            return fixed ? `Due ${fixed}` : "Semester due date not set";
          }
          return policy.replace(/_/g, " ");
        }

        function fnFormatDateTimeLocalInput(value) {
          const dt = fnSafeDate(value);
          if (!dt) return "";
          const pad = (num) => String(num).padStart(2, "0");
          const year = dt.getFullYear();
          const month = pad(dt.getMonth() + 1);
          const day = pad(dt.getDate());
          const hours = pad(dt.getHours());
          const minutes = pad(dt.getMinutes());
          return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function fnFormatTimeForInput(value) {
          if (!value) return "";
          if (typeof value === "string") {
            const trimmed = value.trim();
            if (!trimmed) return "";
            return trimmed.substring(0, 5);
          }
          const dt = fnSafeDate(`1970-01-01T${value}`);
          if (!dt) return "";
          const pad = (num) => String(num).padStart(2, "0");
          return `${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
        }

        function fnFormatUserRole(role) {
          if (!role) return "—";
          return role
            .toString()
            .split(/[_\s]+/)
            .filter(Boolean)
            .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
            .join(" ");
        }

        function fnFormatItemDuePolicy(item) {
          if (!item) return "—";
          if (item.duePolicyDescription) return item.duePolicyDescription;
          const policy = (item.duePolicy || "").toUpperCase();
          if (!policy) return "—";
          if (policy === "NEXT_DAY_6PM") return "Next day at 6:00 PM";
          if (policy === "OFFSET") {
            const days = Number.isFinite(item.dueDaysOffset)
              ? item.dueDaysOffset
              : null;
            const hours = Number.isFinite(item.dueHoursOffset)
              ? item.dueHoursOffset
              : null;
            const time = fnFormatTimeForInput(item.dueTime) || "";
            const parts = [];
            if (days != null) {
              parts.push(
                `${days} day${days === 1 ? "" : "s"}`,
              );
            }
            if (hours != null && hours !== 0) {
              parts.push(
                `${hours} hour${hours === 1 ? "" : "s"}`,
              );
            }
            if (time) {
              parts.push(`at ${time}`);
            }
            return parts.length
              ? `Offset ${parts.join(" ")}`
              : "Custom offset";
          }
          if (policy === "SEMESTER" || policy === "FIXED") {
            const fixed = fnNormalizeDueText(item.fixedDueLocal);
            return fixed ? `Due ${fixed}` : "Semester due date not set";
          }
          return policy.replace(/_/g, " ");
        }

        function fnFormatCheckoutConfirmation(payload) {
          if (!payload) return "Checkout complete.";
          const dueText = fnNormalizeDueText(payload.dueUtc || payload.dueUTC);
          const description =
            payload.dueDescription ||
            payload.policyDescription ||
            payload.policyLabel ||
            payload.policy ||
            "";
          if (dueText && description) {
            return `Checkout complete. Due ${dueText} (${description}).`;
          }
          if (dueText) {
            return `Checkout complete. Due ${dueText}.`;
          }
          if (description) {
            return `Checkout complete. ${description}`;
          }
          return "Checkout complete.";
        }

        function fnBuildBorrowReminder(payload) {
          const dueUtc = payload?.dueUtc ?? payload?.dueUTC ?? null;
          const dueText = fnNormalizeDueText(dueUtc);
          const description =
            payload?.dueDescription ||
            payload?.policyDescription ||
            payload?.policyLabel ||
            payload?.policy ||
            "";
          let dueLine = "This item is due back by the stated due date.";
          if (dueText && description) {
            dueLine = `This item is due back by ${dueText} (${description}).`;
          } else if (dueText) {
            dueLine = `This item is due back by ${dueText}.`;
          } else if (description) {
            const normalizedDescription = description.trim();
            if (normalizedDescription) {
              const needsByPrefix = !/^due\b/i.test(normalizedDescription);
              const hasEndingPunctuation = /[.?!]$/.test(normalizedDescription);
              dueLine = `This item is due back ${
                needsByPrefix ? "by " : ""
              }${normalizedDescription}${hasEndingPunctuation ? "" : "."}`;
            }
          }
          return [
            "Borrowed Equipment",
            dueLine,
            "By checking out this equipment, you agree to return it by the stated due date and to maintain it in good condition. Any item that is lost or damaged beyond normal wear and tear is the borrower’s responsibility to replace.",
            "",
            "Certain items may not be removed from campus and must be returned by the end of the day. If the Lab Center is closed, please leave the trainer in your classroom and ensure the door is securely closed before leaving.",
          ].join("\n");
        }

        function fnBuildServiceReminder() {
          return [
            "Repair & Service Disclaimer",
            "By submitting your item for repair, you acknowledge that all service is performed at your own risk. While Lab Center staff will exercise reasonable care, Cincinnati State, the Lab Center, and its employees are not responsible for any additional damage, malfunction, or failure that may occur during repair attempts or for issues that cannot be resolved.",
            "",
            "If replacement parts are required to complete a repair, you will be notified and provided with the details. You may:",
            "",
            "Purchase the parts yourself,",
            "",
            "Authorize Lab Center to order them on your behalf at your expense, or",
            "",
            "Decline and retrieve your item unrepaired.",
            "",
            "Because Lab Center services and labor are provided free of charge, we do not supply or cover the cost of parts.",
          ].join("\n");
        }

        function fnAlertBorrowCompletion(payload, fallbackMessage) {
          const message =
            (payload ? fnFormatCheckoutConfirmation(payload) : null) ||
            fallbackMessage ||
            "Checkout complete.";
          const reminder = fnBuildBorrowReminder(payload || null);
          alert(`${message}\n\n${reminder}`);
        }

        function fnAlertServiceSubmission(fallbackMessage) {
          const message = fallbackMessage || "Service ticket created.";
          const reminder = fnBuildServiceReminder();
          alert(`${message}\n\n${reminder}`);
        }

        function fnFormatDuePreview(payload) {
          if (!payload) return "Unable to determine due date for that item.";
          if (payload.message) return payload.message;
          const dueText = fnNormalizeDueText(payload.dueUtc || payload.dueUTC);
          const description =
            payload.policyDescription ||
            payload.policyLabel ||
            payload.policy ||
            "";
          if (dueText && description) {
            return `Expected due ${dueText} (${description}).`;
          }
          if (dueText) {
            return `Expected due ${dueText}.`;
          }
          if (description) {
            return description;
          }
          return "Unable to determine due date for that item.";
        }

        function fnSetupDuePreview(inputId, previewId) {
          const input = document.getElementById(inputId);
          const preview = document.getElementById(previewId);
          if (!input || !preview) return;
          const defaultText =
            (
              preview.dataset.defaultMessage ||
              preview.textContent ||
              ""
            ).trim() ||
            "Due date will be assigned automatically from the item's policy.";
          preview.dataset.defaultMessage = defaultText;
          let token = 0;

          const runLookup = async () => {
            const query = (input.value || "").trim();
            const currentToken = ++token;
            if (!query) {
              preview.textContent = defaultText;
              return;
            }
            try {
              const res = await fnApi(
                `/items/due-preview?item=${encodeURIComponent(query)}`,
                { method: "GET" },
              );
              const payload = await res.json();
              if (currentToken !== token) return;
              preview.textContent = fnFormatDuePreview(payload);
            } catch (err) {
              if (currentToken !== token) return;
              console.warn("Due preview lookup failed", err);
              preview.textContent =
                "Unable to determine due date for that item.";
            }
          };

          const isSelect = input.tagName === "SELECT";
          const update = isSelect ? runLookup : fnDebounce(runLookup, 250);

          if (isSelect) {
            input.addEventListener("change", () => {
              if (!input.value) {
                preview.textContent = defaultText;
                token++;
                return;
              }
              update();
            });
          } else {
            input.addEventListener("input", () => {
              if (!input.value.trim()) {
                preview.textContent = defaultText;
              }
              update();
            });
            input.addEventListener("blur", () => {
              setTimeout(update, 0);
            });
          }
        }

        function fnSetNewCustomerDialogMode(dialog, mode) {
          const dlg = dialog || document.getElementById("dlg-new-customer");
          if (!dlg) return;
          const action = mode === "service" ? "service" : "borrow";
          dlg.dataset.action = action;
          dlg
            .querySelectorAll('[data-bind="borrow"]')
            .forEach((el) => (el.style.display = action === "borrow" ? "" : "none"));
          dlg
            .querySelectorAll('[data-bind="service"]')
            .forEach((el) => (el.style.display = action === "service" ? "" : "none"));
        }

        function fnPopulateItemSelect(select, items) {
          if (!select) return;
          const existingPlaceholder = Array.from(select.querySelectorAll("option"))
            .find((opt) => opt.value === "")?.textContent;
          const placeholderText = (existingPlaceholder || "Select an item…").trim();
          const previousValue = select.value;
          select.textContent = "";
          const placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.textContent = placeholderText;
          select.appendChild(placeholder);
          items
            .filter((item) => item && item.name)
            .forEach((item) => {
              const option = document.createElement("option");
              option.value = item.name;
              option.textContent = item.name;
              if (item.id != null) option.dataset.itemId = item.id;
              select.appendChild(option);
            });
          if (
            previousValue &&
            Array.from(select.options).some((opt) => opt.value === previousValue)
          ) {
            select.value = previousValue;
            select.dispatchEvent(new Event("change"));
          } else {
            select.value = "";
          }
        }

        function fnSetupBorrowerLookup({
          inputId,
          menuId,
          hiddenId,
          idFieldId,
        }) {
          const input = document.getElementById(inputId);
          const menu = document.getElementById(menuId);
          const hidden = hiddenId ? document.getElementById(hiddenId) : null;
          const idField = idFieldId ? document.getElementById(idFieldId) : null;
          if (!input || !menu) return;

          let results = [];
          let activeIndex = -1;
          let queryToken = 0;

          const hideMenu = () => {
            menu.classList.remove("show");
            input.setAttribute("aria-expanded", "false");
            activeIndex = -1;
            input.setAttribute("aria-activedescendant", "");
          };

          const showMenu = () => {
            if (menu.children.length) {
              menu.classList.add("show");
              input.setAttribute("aria-expanded", "true");
            }
          };

          const resetSelection = () => {
            if (hidden) hidden.value = "";
            input.dataset.borrowerId = "";
            input.setAttribute("aria-activedescendant", "");
          };

          const render = (items, emptyMessage) => {
            menu.textContent = "";
            results = Array.isArray(items) ? items : [];
            activeIndex = -1;
            if (!results.length) {
              if (emptyMessage) {
                const li = document.createElement("li");
                li.className = "lookup-empty";
                li.textContent = emptyMessage;
                menu.appendChild(li);
                showMenu();
              } else {
                hideMenu();
              }
              return;
            }
            results.forEach((item, idx) => {
              const li = document.createElement("li");
              li.className = "lookup-item";
              li.id = `${menuId}-opt-${idx}`;
              li.setAttribute("role", "option");
              li.dataset.index = String(idx);
              const name =
                item.name ||
                [item.firstName, item.lastName]
                  .filter(Boolean)
                  .join(" ")
                  .trim() ||
                "Unknown";
              const schoolId = item.schoolId || "";
              li.innerHTML = `<strong>${name}</strong>${schoolId ? `<span class="sub">ID: ${schoolId}</span>` : ""}`;
              li.addEventListener("mousedown", (e) => {
                e.preventDefault();
                select(idx);
              });
              menu.appendChild(li);
            });
            showMenu();
          };

          const select = (idx) => {
            const item = results[idx];
            if (!item) return;
            const name =
              item.name ||
              [item.firstName, item.lastName].filter(Boolean).join(" ").trim();
            input.value = name;
            input.dataset.borrowerId = item.id ?? "";
            if (hidden) hidden.value = item.id ?? "";
            if (idField && item.schoolId) {
              idField.value = item.schoolId;
            }
            hideMenu();
          };

          const setActiveIndex = (idx) => {
            const items = menu.querySelectorAll(".lookup-item");
            if (!items.length) return;
            activeIndex = ((idx % items.length) + items.length) % items.length;
            items.forEach((el, index) => {
              if (index === activeIndex) {
                el.classList.add("active");
                input.setAttribute("aria-activedescendant", el.id);
                el.scrollIntoView({ block: "nearest" });
              } else {
                el.classList.remove("active");
              }
            });
          };

          const runSearch = async () => {
            const term = input.value.trim();
            resetSelection();
            if (term.length < 2) {
              hideMenu();
              menu.textContent = "";
              return;
            }
            if (!USE_BACKEND) {
              render([], "Enable backend to search names.");
              return;
            }
            const token = ++queryToken;
            render([], "Searching…");
            try {
              const res = await fnApi(
                `/borrowers/search?query=${encodeURIComponent(term)}`,
                { method: "GET" },
              );
              const payload = await res.json();
              if (token !== queryToken) return;
              const entries = Array.isArray(payload?.entries)
                ? payload.entries
                : Array.isArray(payload)
                  ? payload
                  : [];
              const normalized = entries.map((item) => ({
                id: item.id ?? item.intBorrowerID ?? item.borrowerId ?? null,
                name:
                  item.name ||
                  [
                    item.firstName || item.strFirstName,
                    item.lastName || item.strLastName,
                  ]
                    .filter(Boolean)
                    .join(" ")
                    .trim(),
                schoolId: item.schoolId || item.strSchoolIDNumber || null,
              }));
              render(
                normalized,
                normalized.length ? null : "No matches found.",
              );
            } catch (err) {
              if (token !== queryToken) return;
              console.error("Borrower lookup failed", err);
              render([], "Lookup failed.");
            }
          };

          const debouncedSearch = fnDebounce(runSearch, 200);

          input.addEventListener("input", () => {
            if (hidden) hidden.value = "";
            input.dataset.borrowerId = "";
            debouncedSearch();
          });

          input.addEventListener("focus", () => {
            if (menu.children.length) showMenu();
          });

          input.addEventListener("blur", () => {
            setTimeout(hideMenu, 120);
          });

          input.addEventListener("keydown", (event) => {
            if (!menu.classList.contains("show")) return;
            if (event.key === "ArrowDown" || event.key === "Down") {
              event.preventDefault();
              setActiveIndex(activeIndex + 1);
            } else if (event.key === "ArrowUp" || event.key === "Up") {
              event.preventDefault();
              setActiveIndex(activeIndex - 1);
            } else if (event.key === "Enter") {
              if (activeIndex >= 0) {
                event.preventDefault();
                select(activeIndex);
              }
            } else if (event.key === "Escape") {
              hideMenu();
            }
          });

          if (idField) {
            idField.addEventListener("input", () => {
              if (!idField.value) {
                resetSelection();
              }
            });
          }
        }

        function fnUpdateItemDuePolicyVisibility(
          selectId = "ci-due-policy",
          formId = "form-create-item",
        ) {
          const select = document.getElementById(selectId);
          const form = formId
            ? document.getElementById(formId)
            : select?.closest("form");
          if (!select || !form) return;
          const policy = select.value;
          fnSelectAllElements(".due-config", form).forEach((el) => {
            if (el.dataset.policy === policy) {
              el.classList.add("active");
            } else {
              el.classList.remove("active");
            }
          });
        }

        // ====== DATA LAYER ======
        /**
         * Lightweight data access wrapper that optionally stubs network calls when
         * USE_BACKEND is false. When a backend is provided this funnels through
         * fetch() and raises if the response is not ok.
         */
        async function fnApi(path, opts = {}) {
          if (!USE_BACKEND) {
            throw new Error(
              "Backend integration is disabled. Enable USE_BACKEND to load live data.",
            );
          }
          const headers = {
            "Content-Type": "application/json",
            ...(opts.headers || {}),
          };
          if (m_strSessionToken && !headers.Authorization) {
            headers.Authorization = `Bearer ${m_strSessionToken}`;
          }
          const [basePath, querySuffix] = path.split("?");
          const queryString = querySuffix ? `?${querySuffix}` : "";
          const res = await fnRawRequest(API_BASE + basePath, {
            ...opts,
            headers,
            queryString,
          });
          if (res.status === 401) {
            await fnHandleUnauthorized();
            throw new Error("Authentication required.");
          }
          if (!res.ok) {
            let detail;
            try {
              detail = await res.text();
            } catch {
              detail = null;
            }
            throw new Error(detail || `HTTP ${res.status}`);
          }
          fnResetIdleTimer();
          return res;
        }

        async function fnFetchAuditLog() {
          const res = await fnApi(`/audit-log?top=50`, { method: "GET" });
          const payload = await res.json();
          if (Array.isArray(payload)) return payload;
          if (Array.isArray(payload?.entries)) return payload.entries;
          if (Array.isArray(payload?.data)) return payload.data;
          return [];
        }

        async function fnFetchCustomerProfiles(params = {}) {
          const searchParams = new URLSearchParams();
          if (params.top != null) searchParams.set("top", params.top);
          if (params.search) searchParams.set("search", params.search);
          const qs = searchParams.toString();
          const res = await fnApi(`/customers${qs ? `?${qs}` : ""}`, {
            method: "GET",
          });
          const payload = await res.json();
          if (Array.isArray(payload)) return payload;
          if (Array.isArray(payload?.entries)) return payload.entries;
          if (Array.isArray(payload?.data)) return payload.data;
          return [];
        }

        async function fnFetchCustomerProfileDetail(id) {
          const res = await fnApi(`/customers/${encodeURIComponent(id)}`, {
            method: "GET",
          });
          return res.json();
        }

        async function fnFetchItems() {
          const res = await fnApi(`/items`, { method: "GET" });
          const payload = await res.json();
          if (Array.isArray(payload)) return payload;
          if (Array.isArray(payload?.entries)) return payload.entries;
          if (Array.isArray(payload?.data)) return payload.data;
          return [];
        }

        async function fnFetchUsers(params = {}) {
          const searchParams = new URLSearchParams();
          if (params.search) searchParams.set("search", params.search);
          const qs = searchParams.toString();
          const res = await fnApi(`/users${qs ? `?${qs}` : ""}`, {
            method: "GET",
          });
          const payload = await res.json();
          if (Array.isArray(payload)) return payload;
          if (Array.isArray(payload?.entries)) return payload.entries;
          if (Array.isArray(payload?.data)) return payload.data;
          return [];
        }

        async function fnFetchAdminTableNames() {
          const res = await fnApi(`/admin/db/tables`, { method: "GET" });
          const payload = await res.json();
          return Array.isArray(payload?.entries) ? payload.entries : [];
        }

        async function fnFetchAdminTableRows(tableName) {
          const res = await fnApi(
            `/admin/db/tables/${encodeURIComponent(tableName)}`,
            { method: "GET" },
          );
          return res.json();
        }

        async function fnCreateCustomerAlias(id, alias) {
          const res = await fnApi(
            `/customers/${encodeURIComponent(id)}/aliases`,
            {
              method: "POST",
              body: JSON.stringify({ alias }),
            },
          );
          return res.json();
        }

        async function fnDeleteCustomerAlias(id, aliasId) {
          await fnApi(
            `/customers/${encodeURIComponent(id)}/aliases/${encodeURIComponent(aliasId)}`,
            { method: "DELETE" },
          );
        }

        function fnRenderAdminTableRows(payload) {
          const head = document.getElementById("admin-db-head");
          const body = document.getElementById("admin-db-body");
          if (!head || !body) return;
          const columns = Array.isArray(payload?.schema) ? payload.schema : [];
          const rows = Array.isArray(payload?.entries) ? payload.entries : [];
          head.innerHTML = "";
          body.innerHTML = "";

          const hr = document.createElement("tr");
          ["Actions", ...columns.map((c) => c.name)].forEach((name) => {
            const th = document.createElement("th");
            th.scope = "col";
            th.textContent = name;
            hr.appendChild(th);
          });
          head.appendChild(hr);

          if (!rows.length) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = Math.max(1, columns.length + 1);
            td.style.textAlign = "center";
            td.style.color = "var(--muted)";
            td.style.padding = "18px 12px";
            td.textContent = "No rows found.";
            tr.appendChild(td);
            body.appendChild(tr);
            return;
          }

          rows.forEach((entry) => {
            const tr = document.createElement("tr");
            const actionTd = document.createElement("td");
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn";
            btn.textContent = "Edit";
            btn.addEventListener("click", () => fnOpenAdminRowEditor(entry));
            actionTd.appendChild(btn);
            tr.appendChild(actionTd);

            columns.forEach((column) => {
              const td = document.createElement("td");
              const value = entry?.values?.[column.name];
              td.textContent = value == null ? "" : String(value);
              tr.appendChild(td);
            });
            body.appendChild(tr);
          });
        }

        async function fnLoadAdminTableRows(tableName) {
          if (!tableName || !fnIsAdminUser()) return;
          const body = document.getElementById("admin-db-body");
          if (body) {
            body.innerHTML = '<tr><td style="text-align: center; color: var(--muted); padding: 18px 12px;">Loading table rows…</td></tr>';
          }
          const payload = await fnFetchAdminTableRows(tableName);
          m_objAdminActiveTablePayload = payload;
          fnRenderAdminTableRows(payload);
        }

        async function fnLoadAdminTableList() {
          if (!fnIsAdminUser()) return;
          const select = document.getElementById("admin-db-table-select");
          if (!select) return;
          m_arrAdminTables = await fnFetchAdminTableNames();
          select.innerHTML = "";
          m_arrAdminTables.forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
          });
          if (m_arrAdminTables.length) {
            await fnLoadAdminTableRows(select.value || m_arrAdminTables[0]);
          }
        }

        function fnOpenAdminRowEditor(entry) {
          if (!fnIsAdminUser()) return;
          const payload = m_objAdminActiveTablePayload;
          const fields = document.getElementById("admin-db-edit-fields");
          const locator = document.getElementById("admin-db-edit-locator");
          const table = document.getElementById("admin-db-edit-table");
          if (!fields || !locator || !table) return;
          const tableName = document.getElementById("admin-db-table-select")?.value;
          table.value = tableName || "";
          locator.value = JSON.stringify(entry?.locator || {});
          fields.innerHTML = "";

          (payload?.schema || []).forEach((column) => {
            const wrap = document.createElement("div");
            const label = document.createElement("label");
            label.textContent = `${column.name}${column.primaryKeyOrdinal ? " (PK)" : ""}`;
            const input = document.createElement("input");
            input.type = "text";
            input.dataset.column = column.name;
            const value = entry?.values?.[column.name];
            input.value = value == null ? "" : String(value);
            input.disabled = column.primaryKeyOrdinal > 0;
            wrap.appendChild(label);
            wrap.appendChild(input);
            fields.appendChild(wrap);
          });

          fnOpenDialogById("dlg-admin-db-row");
        }

        async function fnSaveAdminRowEdit() {
          const tableName = document.getElementById("admin-db-edit-table")?.value;
          const locatorRaw = document.getElementById("admin-db-edit-locator")?.value;
          const fields = Array.from(document.querySelectorAll("#admin-db-edit-fields input[data-column]"));
          const changes = {};
          fields.forEach((input) => {
            if (input.disabled) return;
            changes[input.dataset.column] = input.value === "" ? null : input.value;
          });
          const locator = locatorRaw ? JSON.parse(locatorRaw) : {};
          await fnApi(`/admin/db/tables/${encodeURIComponent(tableName)}/rows`, {
            method: "PUT",
            body: JSON.stringify({ locator, changes }),
          });
          fnCloseDialogById("dlg-admin-db-row");
          await fnLoadAdminTableRows(tableName);
          alert("Row updated.");
        }

        function fnFormatAuditUser(entry) {
          const user =
            entry.username || entry.user || entry.userName || entry.strUsername;
          if (user) return user;
          const first = entry.strFirstName || entry.firstName;
          const last = entry.strLastName || entry.lastName;
          if (first || last)
            return [first, last].filter(Boolean).join(" ").trim();
          return entry.intLabTechID ? `Tech #${entry.intLabTechID}` : "System";
        }

        function fnFormatAuditTrace(entry) {
          const raw = entry.trace || entry.traceId || entry.intTraceID;
          if (raw == null) return "—";
          const num = Number(raw);
          if (Number.isFinite(num)) return num.toString().padStart(6, "0");
          const str = String(raw);
          return str.padStart(Math.max(6, str.length), "0");
        }

        function fnTitleCase(str) {
          return str.toLowerCase().replace(/\b\w/g, (c) => c.toUpperCase());
        }

        function fnFormatAuditAction(entry) {
          const code = (entry.action || entry.strAction || "")
            .toString()
            .trim();
          if (!code) return "—";
          return (
            AUDIT_ACTION_TITLES[code] || fnTitleCase(code.replace(/_/g, " "))
          );
        }

        function fnSafeDate(value) {
          const d = new Date(value);
          return Number.isNaN(d.getTime()) ? null : d;
        }

        function fnFormatAuditDateTime(entry) {
          const raw =
            entry.dtmEventLocal ||
            entry.dtmEventUTC ||
            entry.timestamp ||
            entry.dateTime ||
            entry.date;
          if (!raw) return "—";
          const dt = fnSafeDate(raw);
          return dt ? AUDIT_DATETIME_FORMAT.format(dt) : raw;
        }

        function fnFormatDetailDate(raw) {
          if (!raw) return null;
          const dt = fnSafeDate(raw);
          return dt ? AUDIT_DATE_FORMAT.format(dt) : null;
        }

        function fnHumanizeKey(key) {
          return key
            .replace(/([A-Z])/g, " $1")
            .replace(/_/g, " ")
            .replace(/\s+/g, " ")
            .trim()
            .replace(/\b\w/g, (c) => c.toUpperCase());
        }

        function fnSummarizeDetail(obj) {
          if (!obj || typeof obj !== "object") return "";
          if (Array.isArray(obj)) {
            return obj.map(fnSummarizeDetail).filter(Boolean).join("; ");
          }
          const item = obj.item || obj.itemName;
          const borrower = obj.borrower || obj.customer || obj.customerName;
          if (item) {
            const parts = [item];
            if (borrower) {
              let borrowerTxt = borrower;
              if (obj.schoolId || obj.schoolID || obj.schoolIdNumber) {
                borrowerTxt += ` (${obj.schoolId || obj.schoolID || obj.schoolIdNumber})`;
              }
              parts.push(`→ ${borrowerTxt}`);
            }
            const due = fnFormatDetailDate(obj.dueLocal || obj.dueUTC);
            if (due) parts.push(`Due ${due}`);
            if (obj.checkoutUTC) {
              const checkout = fnFormatDetailDate(obj.checkoutUTC);
              if (checkout) parts.push(`Checked Out ${checkout}`);
            }
            if (obj.checkinUTC) {
              const checkin = fnFormatDetailDate(obj.checkinUTC);
              if (checkin) parts.push(`Checked In ${checkin}`);
            }
            return parts.join(" · ");
          }
          if (obj.publicId || obj.publicTicketID) {
            const ticket = obj.publicId || obj.publicTicketID;
            return obj.status ? `${ticket} — ${obj.status}` : ticket;
          }
          if (Object.prototype.hasOwnProperty.call(obj, "note")) {
            return String(obj.note);
          }
          return Object.entries(obj)
            .map(([k, v]) => `${fnHumanizeKey(k)}: ${v}`)
            .join("; ");
        }

        function fnFormatAuditDetails(entry) {
          const raw =
            entry.details ?? entry.strDetails ?? entry.detail ?? entry.message;
          if (raw == null) return "";
          if (typeof raw === "object") {
            return fnSummarizeDetail(raw);
          }
          const text = raw.toString().trim();
          if (!text) return "";
          try {
            const parsed = JSON.parse(text);
            return fnSummarizeDetail(parsed) || text;
          } catch {
            return text;
          }
        }

        function fnRenderAuditLogTable(entries) {
          const tbody = document.getElementById("tbl-admin-log");
          if (!tbody) return;
          tbody.textContent = "";
          if (!entries.length) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 5;
            td.style.textAlign = "center";
            td.style.color = "var(--muted)";
            td.style.padding = "18px 12px";
            td.textContent = "No recent activity.";
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
          }
          entries.forEach((entry) => {
            const tr = document.createElement("tr");
            const cells = [
              fnFormatAuditUser(entry),
              fnFormatAuditTrace(entry),
              fnFormatAuditAction(entry),
              fnFormatAuditDateTime(entry),
              fnFormatAuditDetails(entry),
            ];
            cells.forEach((val) => {
              const td = document.createElement("td");
              td.textContent = val || "";
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });
        }

        function fnFilterAuditLogEntries(entries, term) {
          if (!Array.isArray(entries)) return [];
          const normalized = term.trim().toLowerCase();
          if (!normalized) return entries.slice();
          const tokens = normalized.split(/\s+/).filter(Boolean);
          if (!tokens.length) return entries.slice();
          return entries.filter((entry) => {
            const parts = [
              fnFormatAuditUser(entry),
              fnFormatAuditTrace(entry),
              fnFormatAuditAction(entry),
              fnFormatAuditDateTime(entry),
              fnFormatAuditDetails(entry),
            ]
              .map((val) => (val || "").toString().toLowerCase())
              .join(" ");
            return tokens.every((token) => parts.includes(token));
          });
        }

        function fnRenderAuditLog(entries) {
          m_arrAuditLogEntries = Array.isArray(entries) ? entries.slice() : [];
          const filtered = fnFilterAuditLogEntries(
            m_arrAuditLogEntries,
            m_strAuditLogSearchTerm,
          );
          fnRenderAuditLogTable(filtered);
        }

        function fnUpdateAuditLogSearch(term) {
          m_strAuditLogSearchTerm = (term || "").trim();
          const filtered = fnFilterAuditLogEntries(
            m_arrAuditLogEntries,
            m_strAuditLogSearchTerm,
          );
          fnRenderAuditLogTable(filtered);
        }

        async function fnLoadAuditLog() {
          const tbody = document.getElementById("tbl-admin-log");
          if (!tbody) return;
          try {
            const entries = await fnFetchAuditLog();
            fnRenderAuditLog(entries);
          } catch (err) {
            console.error("Failed to load audit log", err);
            tbody.textContent = "";
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 5;
            td.style.textAlign = "center";
            td.style.color = "var(--overdue-fg)";
            td.style.padding = "18px 12px";
            td.textContent = "Unable to load audit log.";
            tr.appendChild(td);
            tbody.appendChild(tr);
          }
        }

        function fnResetCustomerProfileModal() {
          m_objActiveCustomerProfile = null;
          const ids = [
            "cust-name",
            "cust-school",
            "cust-phone",
            "cust-room",
            "cust-instructor",
            "cust-department",
            "cust-created",
          ];
          ids.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.textContent = "—";
          });
          const hidden = document.getElementById("cust-profile-id");
          if (hidden) hidden.value = "";
          const aliasList = document.getElementById("cust-alias-list");
          if (aliasList) {
            aliasList.textContent = "";
            const p = document.createElement("p");
            p.className = "alias-empty";
            p.textContent = "No aliases yet.";
            aliasList.appendChild(p);
          }
          const aliasInput = document.getElementById("cust-alias-input");
          if (aliasInput) aliasInput.value = "";
        }

        function fnRenderCustomerAliasList(list) {
          const aliasList = document.getElementById("cust-alias-list");
          if (!aliasList) return;
          aliasList.textContent = "";
          if (!Array.isArray(list) || !list.length) {
            const empty = document.createElement("p");
            empty.className = "alias-empty";
            empty.textContent = "No aliases yet.";
            aliasList.appendChild(empty);
            return;
          }
          list.forEach((alias) => {
            const chip = document.createElement("span");
            chip.className = "alias-chip";
            chip.setAttribute("role", "listitem");
            const label = document.createElement("span");
            label.textContent = alias.alias;
            chip.appendChild(label);
            const remove = document.createElement("button");
            remove.type = "button";
            remove.dataset.aliasId = alias.id ?? "";
            remove.dataset.aliasName = alias.alias || "";
            remove.setAttribute("aria-label", `Remove alias ${alias.alias}`);
            remove.innerHTML = "&times;";
            chip.appendChild(remove);
            aliasList.appendChild(chip);
          });
        }

        function fnRenderCustomerProfileDetail(profile) {
          if (!profile) return;
          const hidden = document.getElementById("cust-profile-id");
          if (hidden) hidden.value = profile.id ?? "";
          const name = document.getElementById("cust-name");
          if (name) name.textContent = profile.name || "—";
          const school = document.getElementById("cust-school");
          if (school) school.textContent = profile.schoolId || "—";
          const phone = document.getElementById("cust-phone");
          if (phone) phone.textContent = profile.phone || "—";
          const room = document.getElementById("cust-room");
          if (room) room.textContent = profile.room || "—";
          const instructor = document.getElementById("cust-instructor");
          if (instructor) instructor.textContent = profile.instructor || "—";
          const department = document.getElementById("cust-department");
          if (department) department.textContent = profile.department || "—";
          const created = document.getElementById("cust-created");
          if (created)
            created.textContent = profile.createdUtc
              ? fnFormatLocalDateTime(profile.createdUtc)
              : "—";
          fnRenderCustomerAliasList(profile.aliases || []);
        }

        function fnPopulateManageItemForm(item) {
          const idInput = document.getElementById("mi-id");
          if (idInput) idInput.value = item?.id ?? "";
          const nameInput = document.getElementById("mi-name");
          if (nameInput) nameInput.value = item?.name || "";
          const deptInput = document.getElementById("mi-dept");
          if (deptInput) deptInput.value = item?.department || "";
          const ownedSelect = document.getElementById("mi-owned");
          if (ownedSelect)
            ownedSelect.value = item?.schoolOwned === false ? "external" : "school";
          const descriptionInput = document.getElementById("mi-description");
          if (descriptionInput) descriptionInput.value = item?.description || "";
          const policySelect = document.getElementById("mi-due-policy");
          if (policySelect)
            policySelect.value = (item?.duePolicy || "NEXT_DAY_6PM").toUpperCase();
          const offsetDays = document.getElementById("mi-offset-days");
          if (offsetDays)
            offsetDays.value = Number.isFinite(item?.dueDaysOffset)
              ? item.dueDaysOffset
              : 0;
          const offsetHours = document.getElementById("mi-offset-hours");
          if (offsetHours)
            offsetHours.value = Number.isFinite(item?.dueHoursOffset)
              ? item.dueHoursOffset
              : 0;
          const offsetTime = document.getElementById("mi-offset-time");
          if (offsetTime)
            offsetTime.value = fnFormatTimeForInput(item?.dueTime) || "18:00";
          const fixedDue = document.getElementById("mi-fixed-due");
          if (fixedDue) fixedDue.value = fnFormatDateTimeLocalInput(item?.fixedDueLocal);
          fnUpdateItemDuePolicyVisibility("mi-due-policy", "form-manage-item");
        }

        async function fnOpenInventoryItemDialog(itemId) {
          if (!USE_BACKEND) {
            alert("Enable backend to manage inventory items.");
            return;
          }
          const dlg = document.getElementById("dlg-manage-item");
          if (!dlg) return;
          try {
            const res = await fnApi(`/items/${encodeURIComponent(itemId)}`, {
              method: "GET",
            });
            const detail = await res.json();
            m_objActiveInventoryItem = detail;
            fnPopulateManageItemForm(detail);
            dlg.showModal();
          } catch (err) {
            console.error("Failed to load inventory item", err);
            alert(err?.message || "Unable to load inventory item.");
          }
        }

        function fnOpenUserEditDialog(username) {
          if (!USE_BACKEND) {
            alert("Enable backend to manage user profiles.");
            return;
          }
          const dlg = document.getElementById("dlg-edit-user");
          if (!dlg) return;
          const user = m_arrAdminUsers.find(
            (entry) => entry.username === username,
          );
          if (!user) {
            alert("User not found.");
            return;
          }
          m_objActiveUser = user;
          const hidden = document.getElementById("eu-username-hidden");
          if (hidden) hidden.value = user.username || "";
          const usernameInput = document.getElementById("eu-username");
          if (usernameInput) usernameInput.value = user.username || "";
          const displayInput = document.getElementById("eu-display");
          if (displayInput) displayInput.value = user.displayName || "";
          const roleSelect = document.getElementById("eu-role");
          if (roleSelect) {
            const canonicalRole = fnNormalizeUserRole(
              user.role || user.roleLabel || "",
            );
            roleSelect.value = canonicalRole || "";
          }
          const passwordInput = document.getElementById("eu-password");
          if (passwordInput) {
            passwordInput.value = "";
          }
          dlg.showModal();
        }

        async function fnOpenCustomerProfileModal(borrowerId) {
          if (!USE_BACKEND) {
            alert("Enable backend to manage customer profiles.");
            return;
          }
          const dlg = document.getElementById("dlg-manage-customer");
          if (!dlg) return;
          fnResetCustomerProfileModal();
          const aliasList = document.getElementById("cust-alias-list");
          if (aliasList) {
            aliasList.textContent = "";
            const loading = document.createElement("p");
            loading.className = "alias-empty";
            loading.textContent = "Loading profile…";
            aliasList.appendChild(loading);
          }
          dlg.showModal();
          try {
            const detail = await fnFetchCustomerProfileDetail(borrowerId);
            m_objActiveCustomerProfile = {
              ...detail,
              aliases: Array.isArray(detail?.aliases)
                ? detail.aliases.slice()
                : [],
            };
            fnRenderCustomerProfileDetail(m_objActiveCustomerProfile);
          } catch (err) {
            console.error("Failed to load customer profile", err);
            if (aliasList) {
              aliasList.textContent = "";
              const error = document.createElement("p");
              error.className = "alias-empty";
              error.style.color = "var(--overdue-fg)";
              error.textContent = "Unable to load aliases.";
              aliasList.appendChild(error);
            }
            alert(err?.message || "Unable to load profile.");
          }
        }

        async function fnRunCustomerProfileSearch(
          term,
          { showStatus = true } = {},
        ) {
          const tbodyId = "tbl-customer-profiles";
          const tbody = document.getElementById(tbodyId);
          if (!tbody) return;
          m_strLastProfileSearchTerm = (term || "").trim();
          if (!USE_BACKEND) {
            m_arrCustomerProfiles = [];
            m_boolCustomerProfilesLoaded = false;
            m_boolCustomerProfilesLoading = false;
            fnShowTableMessage(
              tbodyId,
              "Enable backend to manage customer profiles.",
            );
            return;
          }
          const token = ++m_intProfileSearchToken;
          m_boolCustomerProfilesLoading = true;
          if (showStatus) {
            fnShowTableMessage(tbodyId, "Loading customer profiles…");
          }
          try {
            const payload = { top: 25 };
            if (m_strLastProfileSearchTerm) {
              payload.search = m_strLastProfileSearchTerm;
            }
            const entries = await fnFetchCustomerProfiles(payload);
            if (token !== m_intProfileSearchToken) return;
            m_arrCustomerProfiles = Array.isArray(entries)
              ? entries.slice()
              : [];
            m_boolCustomerProfilesLoaded = true;
            fnRenderCustomerProfiles(m_arrCustomerProfiles);
          } catch (err) {
            if (token !== m_intProfileSearchToken) return;
            console.error("Failed to load customer profiles", err);
            m_arrCustomerProfiles = [];
            m_boolCustomerProfilesLoaded = false;
            fnShowTableMessage(
              tbodyId,
              "Unable to load customer profiles.",
              "error",
            );
          } finally {
            if (token === m_intProfileSearchToken) {
              m_boolCustomerProfilesLoading = false;
            }
          }
        }

        function fnEnsureCustomerProfilesLoaded() {
          if (!USE_BACKEND) return;
          if (m_boolCustomerProfilesLoaded || m_boolCustomerProfilesLoading) {
            return;
          }
          fnRunCustomerProfileSearch("", { showStatus: true });
        }

        async function fnDeleteCustomerProfile(button, id) {
          if (!USE_BACKEND) {
            alert("Enable backend to manage customer profiles.");
            return;
          }
          if (!id) return;
          if (
            !window.confirm(
              "Delete this customer profile? This removes all associated records and is only allowed when no loans or tickets exist.",
            )
          ) {
            return;
          }
          try {
            if (button) fnSetBusyState(button, true);
            await fnApi(`/customers/${encodeURIComponent(id)}`, {
              method: "DELETE",
            });
            if (
              m_objActiveCustomerProfile &&
              String(m_objActiveCustomerProfile.id || "") === String(id)
            ) {
              m_objActiveCustomerProfile = null;
              fnCloseDialogById("dlg-manage-customer");
            }
            alert("Customer deleted.");
            await fnRunCustomerProfileSearch(m_strLastProfileSearchTerm, {
              showStatus: false,
            });
          } catch (err) {
            console.error("Failed to delete customer", err);
            alert(err?.message || "Unable to delete customer profile.");
          } finally {
            if (button) fnSetBusyState(button, false);
          }
        }

        async function fnClearAuditLog(button) {
          if (!USE_BACKEND) {
            alert("Enable backend to manage the action log.");
            return;
          }
          if (!window.confirm("Clear all action log entries?")) return;
          try {
            if (button) fnSetBusyState(button, true);
            await fnApi(`/admin/audit-log`, { method: "DELETE" });
            alert("Action log cleared.");
            await fnLoadAuditLog();
          } catch (err) {
            console.error("Failed to clear action log", err);
            alert(err?.message || "Unable to clear action log.");
          } finally {
            if (button) fnSetBusyState(button, false);
          }
        }

        async function fnClearDatabase(button) {
          if (!USE_BACKEND) {
            alert("Enable backend to manage the database.");
            return;
          }
          if (
            !window.confirm(
              "Clear the entire database? This removes all customers, inventory, users, loans, tickets, and log entries.",
            )
          ) {
            return;
          }
          try {
            if (button) fnSetBusyState(button, true);
            await fnApi(`/admin/clear-database`, { method: "POST" });
            m_objActiveCustomerProfile = null;
            m_objActiveInventoryItem = null;
            m_objActiveUser = null;
            m_arrCustomerProfiles = [];
            m_boolCustomerProfilesLoaded = false;
            m_boolCustomerProfilesLoading = false;
            fnCloseDialogById("dlg-manage-customer");
            fnCloseDialogById("dlg-manage-item");
            fnCloseDialogById("dlg-edit-user");
            alert("Database cleared.");
            await fnLoadHomeData();
            await fnLoadBorrowingData();
            await fnLoadServiceData();
            await fnLoadAuditLog();
            await fnLoadInventoryData({ showStatus: true });
            await fnLoadAdminUsers({ showStatus: true });
            await fnRunCustomerProfileSearch("", { showStatus: true });
          } catch (err) {
            console.error("Failed to clear database", err);
            alert(err?.message || "Unable to clear database.");
          } finally {
            if (button) fnSetBusyState(button, false);
          }
        }

        // ====== SAVE HANDLERS ======
        // New Customer (borrow/service)
        fnSelectElement("#nc-save").addEventListener(
          "click",
          fnWithAsyncBusy(fnSelectElement("#nc-save"), async () => {
            const first = fnSelectElement("#nc-first").value.trim();
            const last = fnSelectElement("#nc-last").value.trim();
            const dlg = document.getElementById("dlg-new-customer");
            const action = dlg?.dataset.action === "service" ? "service" : "borrow";
            fnMust(first && last, "First/Last required.");
            if (action === "borrow") {
              fnMust(
                fnSelectElement("#nc-item").value.trim(),
                "Item required.",
              );
            } else {
              fnMust(
                fnSelectElement("#ns-item").value.trim(),
                "Service item required.",
              );
              fnMust(
                fnSelectElement("#ns-issue").value.trim(),
                "Issue required.",
              );
            }
            // optional patterns
            const id = fnSelectElement("#nc-schoolid").value;
            if (id && !/^\d{5,8}$/.test(id))
              throw new Error("ID must be 5–8 digits.");
            const phone = fnSelectElement("#nc-phone").value;
            if (phone && !/^\d{10}$/.test(phone))
              throw new Error("Phone must be 10 digits.");

            await fnApi("/customers", {
              method: "POST",
              body: JSON.stringify({
                first,
                last,
                schoolId: id || null,
                phone: phone || null,
                room: fnSelectElement("#nc-room").value || null,
                instructor: fnSelectElement("#nc-instructor").value || null,
              }),
            });

            if (action === "borrow") {
              const checkoutRes = await fnApi("/loans/checkout", {
                method: "POST",
                body: JSON.stringify({
                  customerName: `${first} ${last}`,
                  item: fnSelectElement("#nc-item").value.trim(),
                  notes: fnSelectElement("#nc-notes").value || null,
                }),
              });
              const payload = await checkoutRes.json().catch(() => ({}));
              fnCloseDialogById("dlg-new-customer");
              await fnRefreshOperationalData();
              fnAlertBorrowCompletion(payload, "Saved.");
              return;
            } else {
              await fnApi("/tickets", {
                method: "POST",
                body: JSON.stringify({
                  customerName: `${first} ${last}`,
                  item: fnSelectElement("#ns-item").value.trim(),
                  issue: fnSelectElement("#ns-issue").value.trim(),
                }),
              });
              fnCloseDialogById("dlg-new-customer");
              await fnRefreshOperationalData();
              fnAlertServiceSubmission("Service ticket created.");
              return;
            }
          }),
        );

        // Returning Borrow
        fnSelectElement("#rb-save").addEventListener(
          "click",
          fnWithAsyncBusy(fnSelectElement("#rb-save"), async () => {
            const borrowerId = fnSelectElement("#rb-borrower-id").value.trim();
            const id = fnSelectElement("#rb-id").value.trim();
            const name = fnSelectElement("#rb-name").value.trim();
            if (!borrowerId) {
              fnRequireOne(
                id,
                name,
                "Provide either School/Faculty ID or Name.",
              );
            }
            fnMust(fnSelectElement("#rb-item").value.trim(), "Item required.");

            const checkoutRes = await fnApi("/loans/checkout", {
              method: "POST",
              body: JSON.stringify({
                borrowerId: borrowerId || null,
                schoolId: id || null,
                name: name || null,
                item: fnSelectElement("#rb-item").value.trim(),
                notes: fnSelectElement("#rb-notes").value || null,
              }),
            });
            const payload = await checkoutRes.json().catch(() => ({}));
            fnCloseDialogById("dlg-returning-borrow");
            await fnRefreshOperationalData();
            fnAlertBorrowCompletion(payload);
          }),
        );

        // Returning Service
        fnSelectElement("#rs-save").addEventListener(
          "click",
          fnWithAsyncBusy(fnSelectElement("#rs-save"), async () => {
            const borrowerId = fnSelectElement("#rs-borrower-id").value.trim();
            const id = fnSelectElement("#rs-id").value.trim();
            const name = fnSelectElement("#rs-name").value.trim();
            if (!borrowerId) {
              fnRequireOne(
                id,
                name,
                "Provide either School/Faculty ID or Name.",
              );
            }
            fnMust(fnSelectElement("#rs-item").value.trim(), "Item required.");
            fnMust(
              fnSelectElement("#rs-issue").value.trim(),
              "Issue required.",
            );

            await fnApi("/tickets", {
              method: "POST",
              body: JSON.stringify({
                borrowerId: borrowerId || null,
                schoolId: id || null,
                name: name || null,
                item: fnSelectElement("#rs-item").value.trim(),
                issue: fnSelectElement("#rs-issue").value.trim(),
              }),
            });
            fnCloseDialogById("dlg-returning-service");
            await fnRefreshOperationalData();
            fnAlertServiceSubmission("Service ticket created.");
          }),
        );

        // Admin: Create Item
        fnSelectElement("#ci-save").addEventListener(
          "click",
          fnWithAsyncBusy(fnSelectElement("#ci-save"), async () => {
            const form = document.getElementById("form-create-item");
            const name = fnSelectElement("#ci-name").value.trim();
            fnMust(name, "Item name required.");
            const dept = fnSelectElement("#ci-dept").value.trim();
            const owned = fnSelectElement("#ci-owned").value !== "external";
            const description = fnSelectElement("#ci-description").value.trim();
            const policy = fnSelectElement("#ci-due-policy").value;
            fnMust(policy, "Due policy required.");

            const payload = {
              name,
              department: dept || null,
              schoolOwned: owned,
              description: description || null,
              duePolicy: policy,
            };

            if (policy === "OFFSET") {
              const daysVal = fnSelectElement("#ci-offset-days").value;
              const hoursVal = fnSelectElement("#ci-offset-hours").value;
              const timeVal = fnSelectElement("#ci-offset-time").value;
              const days = Number.parseInt(daysVal, 10);
              const hours = hoursVal === "" ? 0 : Number.parseInt(hoursVal, 10);
              fnMust(
                Number.isInteger(days) && days >= 0,
                "Offset days must be zero or greater.",
              );
              fnMust(
                Number.isInteger(hours) && hours >= 0,
                "Offset hours must be zero or greater.",
              );
              fnMust(timeVal, "Due time required.");
              payload.offsetDays = days;
              payload.offsetHours = hours;
              payload.dueTime = timeVal;
            } else if (policy === "SEMESTER") {
              const fixed = fnSelectElement("#ci-fixed-due").value;
              fnMust(fixed, "Fixed due date/time required.");
              payload.fixedDue = fixed;
            }

            const res = await fnApi("/items", {
              method: "POST",
              body: JSON.stringify(payload),
            });
            const data = await res.json().catch(() => ({}));
            form?.reset();
            fnCloseDialogById("dlg-create-item");
            fnUpdateItemDuePolicyVisibility(
              "ci-due-policy",
              "form-create-item",
            );
            alert(
              data?.message ||
                (data?.itemId
                  ? `Item saved (ID ${data.itemId}).`
                  : "Item saved."),
            );
            await fnLoadInventoryData({ showStatus: false });
          }),
        );

        // Detail Save (status + note)
        fnSelectElement("#det-save").addEventListener(
          "click",
          fnWithAsyncBusy(fnSelectElement("#det-save"), async () => {
            const id = fnSelectElement("#det-id").value;
            const type = fnSelectElement("#det-type").value; // Loan / Service Ticket
            const status = fnSelectElement("#det-status").value;
            const note = fnSelectElement("#det-note").value.trim() || null;

            await fnApi("/status", {
              method: "POST",
              body: JSON.stringify({ id, type, status, note }),
            });

            fnCloseDialogById("dlg-detail");

            const refreshTasks = [fnLoadHomeData()];
            const kindForRefresh = fnMapTypeToKind(type);
            if (kindForRefresh === "loan") {
              refreshTasks.push(fnLoadBorrowingData());
            } else if (kindForRefresh === "ticket") {
              refreshTasks.push(fnLoadServiceData());
            }
            await Promise.allSettled(refreshTasks);

            // Update row status visually if present in current lists
            const row = document.querySelector(`[data-id="${CSS.escape(id)}"]`);
            if (row) {
              fnUpdateRowVisualState(row, status);
            }

            const kind = fnMapTypeToKind(type);
            const cacheKey = fnCreateNoteCacheKey(kind, id);
            if (cacheKey) {
              m_mapDetailNoteCache.delete(cacheKey);
            }

            alert("Saved status & note.");
          }),
        );

        // Admin: Create User
        fnSelectElement("#cu-save").addEventListener(
          "click",
          fnWithAsyncBusy(fnSelectElement("#cu-save"), async () => {
            const u = fnSelectElement("#cu-username").value.trim();
            const d = fnSelectElement("#cu-display").value.trim();
            const r = fnSelectElement("#cu-role").value;
            const p = fnSelectElement("#cu-password").value.trim();
            fnMust(u && d && r && p, "All fields required.");
            fnMust(p.length >= 8, "Password must be at least 8 characters.");
            await fnApi("/users", {
              method: "POST",
              body: JSON.stringify({ username: u, display: d, role: r, password: p }),
            });
            const form = document.getElementById("form-create-user");
            form?.reset();
            fnCloseDialogById("dlg-create-user");
            alert("User created.");
            await fnLoadAdminUsers({ showStatus: false });
          }),
        );

        const auditSearchInput = document.getElementById("search-action-log");
        if (auditSearchInput) {
          const debouncedAuditSearch = fnDebounce(() => {
            fnUpdateAuditLogSearch(auditSearchInput.value || "");
          }, 200);
          auditSearchInput.addEventListener("input", () => {
            debouncedAuditSearch();
          });
        }

        // Admin: Customer Profiles
        const profileSearchInput = document.getElementById("search-profiles");
        if (profileSearchInput) {
          const debouncedProfileSearch = fnDebounce(
            () =>
              fnRunCustomerProfileSearch(profileSearchInput.value, {
                showStatus: true,
              }),
            250,
          );
          profileSearchInput.addEventListener("input", () => {
            debouncedProfileSearch();
          });
        }

        const userSearchInput = document.getElementById("search-admin-users");
        if (userSearchInput) {
          const debouncedUserSearch = fnDebounce(() => {
            fnUpdateAdminUserSearch(userSearchInput.value);
          }, 200);
          userSearchInput.addEventListener("input", () => {
            debouncedUserSearch();
          });
        }

        const inventorySearchInput = document.getElementById(
          "search-admin-inventory",
        );
        if (inventorySearchInput) {
          const debouncedInventorySearch = fnDebounce(() => {
            fnUpdateInventorySearch(inventorySearchInput.value);
          }, 200);
          inventorySearchInput.addEventListener("input", () => {
            debouncedInventorySearch();
          });
        }

        const profileTable = document.getElementById("tbl-customer-profiles");
        if (profileTable) {
          profileTable.addEventListener("click", (event) => {
            const editBtn = event.target.closest("[data-edit-profile]");
            if (editBtn) {
              const id = editBtn.dataset.editProfile;
              if (id) {
                fnOpenCustomerProfileModal(id);
              }
              return;
            }
            const deleteBtn = event.target.closest("[data-delete-profile]");
            if (deleteBtn) {
              const id = deleteBtn.dataset.deleteProfile;
              if (id) {
                fnDeleteCustomerProfile(deleteBtn, id);
              }
            }
          });
        }

        const userTable = document.getElementById("tbl-admin-users");
        if (userTable) {
          userTable.addEventListener("click", (event) => {
            const editBtn = event.target.closest("[data-edit-user]");
            if (editBtn) {
              const username = editBtn.dataset.editUser;
              if (username) {
                fnOpenUserEditDialog(username);
              }
              return;
            }
            const deleteBtn = event.target.closest("[data-delete-user]");
            if (deleteBtn) {
              const username = deleteBtn.dataset.deleteUser;
              if (username) {
                fnDeleteUser(deleteBtn, username);
              }
            }
          });
        }

        const inventoryTable = document.getElementById("tbl-admin-inventory");
        if (inventoryTable) {
          inventoryTable.addEventListener("click", (event) => {
            const editBtn = event.target.closest("[data-edit-item]");
            if (editBtn) {
              const id = editBtn.dataset.editItem;
              if (id) {
                fnOpenInventoryItemDialog(id);
              }
              return;
            }
            const deleteBtn = event.target.closest("[data-delete-item]");
            if (deleteBtn) {
              const id = deleteBtn.dataset.deleteItem;
              if (id) {
                fnDeleteInventoryItem(deleteBtn, id);
              }
            }
          });
        }

        const clearLogButton = document.getElementById("btn-clear-log");
        if (clearLogButton) {
          clearLogButton.addEventListener("click", () => {
            fnClearAuditLog(clearLogButton);
          });
        }

        const clearDatabaseButton = document.getElementById(
          "btn-clear-database",
        );
        if (clearDatabaseButton) {
          clearDatabaseButton.addEventListener("click", () => {
            fnClearDatabase(clearDatabaseButton);
          });
        }

        const aliasAddButton = document.getElementById("cust-alias-add");
        if (aliasAddButton) {
          aliasAddButton.addEventListener(
            "click",
            fnWithAsyncBusy(aliasAddButton, async () => {
              const hidden = document.getElementById("cust-profile-id");
              const parsedId =
                m_objActiveCustomerProfile?.id ??
                Number.parseInt(hidden?.value || "", 10);
              fnMust(
                Number.isFinite(parsedId),
                "Open a profile before adding aliases.",
              );
              const input = document.getElementById("cust-alias-input");
              const value = input?.value.trim() || "";
              fnMust(value, "Alias is required.");
              const alias = await fnCreateCustomerAlias(parsedId, value);
              if (input) input.value = "";
              if (
                !m_objActiveCustomerProfile ||
                m_objActiveCustomerProfile.id !== parsedId
              ) {
                m_objActiveCustomerProfile = m_objActiveCustomerProfile || {
                  id: parsedId,
                  aliases: [],
                };
              }
              const aliases = Array.isArray(m_objActiveCustomerProfile.aliases)
                ? m_objActiveCustomerProfile.aliases.slice()
                : [];
              aliases.push(alias);
              aliases.sort((a, b) =>
                (a.alias || "").localeCompare(b.alias || "", undefined, {
                  sensitivity: "base",
                }),
              );
              m_objActiveCustomerProfile.aliases = aliases;
              fnRenderCustomerProfileDetail(m_objActiveCustomerProfile);
              fnRunCustomerProfileSearch(m_strLastProfileSearchTerm, {
                showStatus: false,
              });
            }),
          );
        }

        const aliasList = document.getElementById("cust-alias-list");
        if (aliasList) {
          aliasList.addEventListener("click", async (event) => {
            const btn = event.target.closest("button[data-alias-id]");
            if (!btn) return;
            event.preventDefault();
            const hidden = document.getElementById("cust-profile-id");
            const currentId =
              m_objActiveCustomerProfile?.id ??
              Number.parseInt(hidden?.value || "", 10);
            if (!Number.isFinite(currentId)) {
              alert("Open a profile before removing aliases.");
              return;
            }
            const aliasId = btn.dataset.aliasId;
            if (!aliasId) return;
            try {
              fnSetBusyState(btn, true);
              await fnDeleteCustomerAlias(currentId, aliasId);
              if (
                m_objActiveCustomerProfile &&
                m_objActiveCustomerProfile.id === currentId
              ) {
                m_objActiveCustomerProfile.aliases = (
                  m_objActiveCustomerProfile.aliases || []
                ).filter((a) => String(a.id) !== String(aliasId));
              }
              fnRenderCustomerProfileDetail(
                m_objActiveCustomerProfile || { id: currentId, aliases: [] },
              );
              fnRunCustomerProfileSearch(m_strLastProfileSearchTerm, {
                showStatus: false,
              });
            } catch (err) {
              console.error("Failed to delete alias", err);
              alert(err?.message || "Unable to remove alias.");
            } finally {
              fnSetBusyState(btn, false);
            }
          });
        }

        const manageItemSave = document.getElementById("mi-save");
        if (manageItemSave) {
          manageItemSave.addEventListener(
            "click",
            fnWithAsyncBusy(manageItemSave, async () => {
              const id = fnSelectElement("#mi-id").value.trim();
              fnMust(id, "Item identifier missing.");
              const name = fnSelectElement("#mi-name").value.trim();
              fnMust(name, "Item name required.");
              const dept = fnSelectElement("#mi-dept").value.trim();
              const owned = fnSelectElement("#mi-owned").value !== "external";
              const description = fnSelectElement("#mi-description").value.trim();
              const policy = fnSelectElement("#mi-due-policy").value;
              fnMust(policy, "Due policy required.");

              const payload = {
                name,
                department: dept || null,
                schoolOwned: owned,
                description: description || null,
                duePolicy: policy,
              };

              if (policy === "OFFSET") {
                const daysVal = fnSelectElement("#mi-offset-days").value;
                const hoursVal = fnSelectElement("#mi-offset-hours").value;
                const timeVal = fnSelectElement("#mi-offset-time").value;
                const days = Number.parseInt(daysVal, 10);
                const hours =
                  hoursVal === "" ? 0 : Number.parseInt(hoursVal, 10);
                fnMust(
                  Number.isInteger(days) && days >= 0,
                  "Offset days must be zero or greater.",
                );
                fnMust(
                  Number.isInteger(hours) && hours >= 0,
                  "Offset hours must be zero or greater.",
                );
                fnMust(timeVal, "Due time required.");
                payload.offsetDays = days;
                payload.offsetHours = hours;
                payload.dueTime = timeVal;
              } else if (policy === "SEMESTER") {
                const fixed = fnSelectElement("#mi-fixed-due").value;
                fnMust(fixed, "Fixed due date/time required.");
                payload.fixedDue = fixed;
              }

              await fnApi(`/items/${encodeURIComponent(id)}`, {
                method: "PUT",
                body: JSON.stringify(payload),
              });
              fnCloseDialogById("dlg-manage-item");
              alert("Item updated.");
              await fnLoadInventoryData({ showStatus: false });
            }),
          );
        }

        const manageItemDelete = document.getElementById("mi-delete");
        if (manageItemDelete) {
          manageItemDelete.addEventListener(
            "click",
            fnWithAsyncBusy(manageItemDelete, async () => {
              const id = fnSelectElement("#mi-id").value.trim();
              fnMust(id, "Item identifier missing.");
              if (
                !window.confirm(
                  "Delete this item? This action cannot be undone.",
                )
              ) {
                return;
              }
              await fnApi(`/items/${encodeURIComponent(id)}`, {
                method: "DELETE",
              });
              fnCloseDialogById("dlg-manage-item");
              alert("Item deleted.");
              await fnLoadInventoryData({ showStatus: false });
            }),
          );
        }

        const editUserSave = document.getElementById("eu-save");
        if (editUserSave) {
          editUserSave.addEventListener(
            "click",
            fnWithAsyncBusy(editUserSave, async () => {
              const username =
                fnSelectElement("#eu-username-hidden").value.trim() ||
                fnSelectElement("#eu-username").value.trim();
              const display = fnSelectElement("#eu-display").value.trim();
              const role = fnSelectElement("#eu-role").value;
              const passwordField = fnSelectElement("#eu-password");
              const password = passwordField
                ? passwordField.value.trim()
                : "";
              fnMust(username && display && role, "All fields required.");
              const payload = { display, role };
              if (password) {
                fnMust(password.length >= 8, "Password must be at least 8 characters.");
                payload.password = password;
              }
              await fnApi(`/users/${encodeURIComponent(username)}`, {
                method: "PUT",
                body: JSON.stringify(payload),
              });
              fnCloseDialogById("dlg-edit-user");
              if (passwordField) {
                passwordField.value = "";
              }
              alert("User updated.");
              await fnLoadAdminUsers({ showStatus: false });
            }),
          );
        }


        fnSetupDuePreview("nc-item", "nc-due-preview");
        fnSetupDuePreview("rb-item", "rb-due-preview");
        fnSetupBorrowerLookup({
          inputId: "rb-name",
          menuId: "rb-name-menu",
          hiddenId: "rb-borrower-id",
          idFieldId: "rb-id",
        });
        fnSetupBorrowerLookup({
          inputId: "rs-name",
          menuId: "rs-name-menu",
          hiddenId: "rs-borrower-id",
          idFieldId: "rs-id",
        });

        const duePolicySelect = document.getElementById("ci-due-policy");
        if (duePolicySelect) {
          duePolicySelect.addEventListener("change", () =>
            fnUpdateItemDuePolicyVisibility("ci-due-policy", "form-create-item"),
          );
          fnUpdateItemDuePolicyVisibility("ci-due-policy", "form-create-item");
        }

        const manageDuePolicySelect = document.getElementById("mi-due-policy");
        if (manageDuePolicySelect) {
          manageDuePolicySelect.addEventListener("change", () =>
            fnUpdateItemDuePolicyVisibility("mi-due-policy", "form-manage-item"),
          );
        }

        async function fnAfterAuthenticated({ initial = false } = {}) {
          document.body.classList.add("authenticated");
          fnUpdateUserDisplay();
          fnResetIdleTimer();

          if (!m_boolHasBootstrapped) {
            fnSetStatsLoading();
            fnShowTableMessage("tbl-home-out", "Loading current checkouts…");
            fnShowTableMessage(
              "tbl-home-repairs",
              "Loading service tickets…",
            );
            fnShowTableMessage("tbl-borrow", "Loading recent loans…");
            fnShowTableMessage("tbl-service", "Loading service tickets…");
            fnShowTableMessage("tbl-admin-log", "Loading activity…");
            if (USE_BACKEND) {
              fnShowTableMessage(
                "tbl-customer-profiles",
                "Loading customer profiles…",
              );
              fnShowTableMessage(
                "tbl-admin-users",
                "Loading user profiles…",
              );
              fnShowTableMessage(
                "tbl-admin-inventory",
                "Loading inventory…",
              );
            } else {
              fnShowTableMessage(
                "tbl-customer-profiles",
                "Enable backend to manage customer profiles.",
              );
              fnShowTableMessage(
                "tbl-admin-users",
                "Enable backend to load user profiles.",
              );
              fnShowTableMessage(
                "tbl-admin-inventory",
                "Enable backend to manage inventory items.",
              );
            }
            m_boolHasBootstrapped = true;
          }

          if (!USE_BACKEND) {
            return;
          }

          fnLoadHomeData();
          fnLoadBorrowingData();
          fnLoadServiceData();
          fnLoadAuditLog();
          fnLoadInventoryData({ showStatus: fnIsAdminUser() });
          if (fnIsAdminUser()) {
            fnLoadAdminUsers();
            fnEnsureCustomerProfilesLoaded();
          }
        }

        if (!USE_BACKEND) {
          await fnAfterAuthenticated({ initial: true });
        } else {
          const restored = await fnRestoreSession();
          if (restored) {
            await fnAfterAuthenticated({ initial: true });
          } else {
            fnShowLogin();
          }
        }

        window.addEventListener("hashchange", () => {
          fnApplyAdminUiAccess();
          if (window.location.hash === "#admin-customers" && fnIsAdminUser()) {
            fnEnsureCustomerProfilesLoaded();
          }
        });

        // keep row colors consistent if DOM changes later
        // Watch for table updates (e.g., new rows inserted) so the status tinting
        // stays in sync even when other scripts mutate the DOM in the future.
        const mo = new MutationObserver(fnApplyRowStatusStyles);
        mo.observe(document.body, { subtree: true, childList: true });
      });
    </script>
  </body>
</html>
