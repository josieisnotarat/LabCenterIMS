<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1280, initial-scale=1.0" />
  <title>Lab Center IMS — Desktop UI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#ffffff; --surface:#f7f8f8; --ink:#0b0f0e; --muted:#6b7280; --line:#e5e7eb;

      /* Brand accents (updated) */
      --brand:#448C37;                  /* accent green */
      --brand-weak:#e6f3e3;             /* soft bg for brand states */

      /* Status palette (consistent everywhere) */
      --ok-bg:var(--brand-weak);
      --ok-fg:var(--brand);
      --overdue-bg:#fee2e2;  --overdue-fg:#b91c1c;
      --repair-bg:#fef3c7;   --repair-fg:#92400e;
      --diagnosing-bg:#fff6e6; --diagnosing-fg:#b45309;
      --returned-bg:#eef2ff; --returned-fg:#3730a3;
      --ready-bg:#ecfdf5;    --ready-fg:#065f46;

      --radius:12px; --shadow:0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.06);

      /* Modal vars */
      --modal-backdrop: rgba(0,0,0,.36);
      --focus:#2563eb;
    }
    *{box-sizing:border-box}
    html, body { height:100%; min-width:1200px; }
    body{
      margin:0; background:var(--surface); color:var(--ink);
      font-family:Inter,system-ui,Arial,sans-serif;
      display:grid; grid-template-rows:auto 1fr;
      overflow:hidden;
    }

    /* Header (fixed) */
    header{
      display:flex; justify-content:space-between; align-items:center; gap:16px;
      padding:14px 18px; background:var(--bg); border-bottom:1px solid var(--line);
      position:sticky; top:0; z-index:100;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .title{font-weight:700}
    .hdr-right{display:flex; align-items:center; gap:12px}
    .logo{height:24px; width:auto; display:block}

    /* App shell */
    .shell{
      display:grid;
      grid-template-columns:260px minmax(0,1fr);
      height:100%; min-height:0; width:100%;
      overflow:hidden;
    }
    aside{
      background:var(--bg); border-right:1px solid var(--line); padding:14px;
      display:flex; flex-direction:column; gap:8px;
      height:100%; overflow:hidden; position:sticky; top:56px; align-self:start;
    }
    main{
      min-width:0; padding:18px;
      height:100%; overflow:auto;
    }

    /* Sidebar */
    .nav-title{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em; margin:10px 0 6px}
    nav{display:grid; gap:8px}
    .nav-link{
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      border-radius:10px; color:#111827; text-decoration:none; border:1px solid transparent;
      user-select:none; transition:background .15s ease,border-color .15s ease,transform .02s ease;
    }
    .nav-link:hover{background:var(--surface); border-color:var(--line)}
    .nav-link:focus-visible{outline:2px solid var(--focus); outline-offset:2px}
    .nav-link:active{transform:translateY(1px)}
    .nav-sep{height:1px; background:var(--line); margin:10px 0}
    .push-bottom{margin-top:auto}

    /* Active link */
    body:has(#home.screen:target)      .nav-link[href="#home"],
    body:not(:has(.screen:target))     .nav-link[href="#home"]{ background:var(--surface); border-color:var(--line); }
    body:has(#borrowing.screen:target) .nav-link[href="#borrowing"]{ background:var(--surface); border-color:var(--line); }
    body:has(#service.screen:target)   .nav-link[href="#service"]{ background:var(--surface); border-color:var(--line); }
    body:has(#admin.screen:target)     .nav-link[href="#admin"]{ background:var(--surface); border-color:var(--line); }

    /* Screens (router) */
    .screen{display:none}
    .screen:target{display:block}
    #home.screen{display:block}
    body:has(.screen:target:not(#home)) #home{display:none}

    .wrapper{max-width:1200px; margin:0 auto}

    /* Cards / grid */
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .card{background:var(--bg); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .card h2{font-size:16px; margin:0; padding:12px 14px; border-bottom:1px solid var(--line)}
    .card .body{padding:14px}

    /* stat chips */
    .stats{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
    .stat{background:var(--bg); border:1px solid var(--line); border-radius:10px; padding:12px}
    .stat .label{font-size:12px; color:var(--muted)}
    .stat .value{font-weight:700; font-size:20px}

    /* universal pills */
    .pill{
      display:inline-block; padding:4px 10px; border-radius:999px;
      font-size:12px; font-weight:700; border:1px solid transparent; white-space:nowrap;
      user-select:none;
    }
    .pill.ok{        background:var(--ok-bg);       color:var(--ok-fg);       border-color:rgba(68,140,55,.25);}
    .pill.overdue{   background:var(--overdue-bg);  color:var(--overdue-fg);  border-color:#fecaca;}
    .pill.repair{    background:var(--repair-bg);   color:var(--repair-fg);   border-color:#fde68a;}
    .pill.diagnosing{background:var(--diagnosing-bg); color:var(--diagnosing-fg); border-color:#fcd9a9;}
    .pill.returned{  background:var(--returned-bg); color:var(--returned-fg); border-color:#e0e7ff;}
    .pill.ready{     background:var(--ready-bg);    color:var(--ready-fg);    border-color:#a7f3d0;}
    .pill.quarantine{background:#fde2ff;            color:#86198f;            border-color:#f5d0fe;}

    /* table */
    .table{overflow:hidden; border-radius:var(--radius); border:1px solid var(--line); background:var(--bg)}
    table{width:100%; border-collapse:separate; border-spacing:0; font-size:14px}
    thead th{background:var(--surface); text-align:left; padding:10px 12px; color:var(--muted); border-bottom:1px solid var(--line)}
    tbody td{padding:12px; border-bottom:1px solid var(--line); vertical-align:top}
    tr.clickable{cursor:pointer}

    /* consistent row emphasis */
    tr.is-overdue{background:#fff7f7}
    tr.is-awaiting{background:#fffbeb}
    tr.is-diagnosing{background:#fffbeb}
    tr.is-ready{background:#f0fdf4}

    /* form bits */
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:12px}
    .search{display:flex; align-items:center; gap:10px; background:var(--bg); border:1px solid var(--line); padding:8px 10px; border-radius:10px; flex:1 1 320px}
    .search input{border:0; outline:0; background:transparent; width:100%}
    .btn{
      border:1px solid var(--line); background:var(--bg); padding:8px 10px;
      border-radius:10px; font-weight:600; text-decoration:none; color:var(--ink);
      display:inline-flex; align-items:center; gap:8px; user-select:none;
      transition:transform .02s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      cursor:pointer;
    }
    .btn:hover{background:var(--surface)}
    .btn:focus-visible{outline:2px solid var(--focus); outline-offset:2px}
    .btn:active{transform:translateY(1px)}
    .btn[aria-busy="true"]{opacity:.7; pointer-events:none}
    .btn.primary{background:var(--brand); color:#fff; border-color:transparent}
    .btn.primary:hover{filter:brightness(0.96)}
    .spinner{width:14px;height:14px;border-radius:999px;border:2px solid #fff;border-top-color:transparent;display:none}
    .btn[aria-busy="true"] .spinner{display:inline-block; animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .filters{display:flex; gap:8px; flex-wrap:wrap}
    .chip{border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:12px; background:var(--bg); cursor:pointer; user-select:none}
    .chip.active{background:var(--brand-weak); border-color:rgba(68,140,55,.35); font-weight:700}

    /* ====== Modals ====== */
    dialog{
      width:720px; max-width:90vw; border:1px solid var(--line);
      border-radius:14px; padding:0; box-shadow:var(--shadow); background:var(--bg);
    }
    dialog::backdrop{background:var(--modal-backdrop)}
    .modal-hd{display:flex; align-items:center; justify-content:space-between; padding:14px; border-bottom:1px solid var(--line)}
    .modal-bd{padding:14px}
    .modal-ft{display:flex; gap:8px; justify-content:flex-end; padding:14px; border-top:1px solid var(--line)}
    .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .form-grid .full{grid-column:1/-1}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#fff; font:inherit
    }
    input:invalid, select:invalid, textarea:invalid{border-color:#fca5a5}
    textarea{min-height:96px; resize:vertical}
    .hint{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img class="logo" src="action_mark_green.avif" alt="Lab Center Logo">
      <div class="title">Cincinnati State Lab Center — IMS</div>
    </div>
    <div class="hdr-right">
      <button class="btn" data-open="dlg-help"><span>Quick Help</span></button>
    </div>
  </header>

  <div class="shell">
    <!-- Sidebar -->
    <aside>
      <div class="nav-title">Main</div>
      <nav>
        <a class="nav-link" href="#home">Home</a>
        <a class="nav-link" href="#borrowing">Borrowing</a>
        <a class="nav-link" href="#service">Service Log</a>
      </nav>
      <div class="nav-sep" aria-hidden="true"></div>
      <div class="push-bottom">
        <div class="nav-title">Admin</div>
        <nav>
          <a class="nav-link" href="#admin">Admin Options</a>
        </nav>
      </div>
    </aside>

    <!-- Content -->
    <main>
      <div class="wrapper">

        <!-- HOME -->
        <section id="home" class="screen" aria-labelledby="home-title">
          <div class="card" style="margin-bottom:14px">
            <h2 id="home-title">Quick Stats <span class="pill ok" style="margin-left:6px">Live</span></h2>
            <div class="body">
              <div class="stats" aria-live="polite">
                <div class="stat"><div class="label">Checked Out Now</div><div class="value" data-stat="outNow">27</div></div>
                <div class="stat"><div class="label">Due Today</div><div class="value" data-stat="dueToday">6</div></div>
                <div class="stat"><div class="label">In Repairs</div><div class="value" data-stat="repairs">4</div></div>
                <div class="stat"><div class="label">Overdue</div><div class="value" data-stat="overdue">2</div></div>
              </div>
              <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
                <a class="btn" href="#borrowing">View Overdue</a>
                <a class="btn" href="#service">Log New Repair</a>
              </div>
            </div>
          </div>

          <div class="grid">
            <section class="card" aria-labelledby="out-title">
              <h2 id="out-title">Currently Checked Out</h2>
              <div class="body table">
                <table>
                  <thead>
                    <tr>
                      <th scope="col">Item</th>
                      <th scope="col">Customer</th>
                      <th scope="col">ID</th>
                      <th scope="col">Room</th>
                      <th scope="col">Due</th>
                      <th scope="col">Due in</th>
                      <th scope="col">Status</th>
                    </tr>
                  </thead>
                  <tbody id="tbl-home-out"></tbody>
                </table>
              </div>
            </section>

            <section class="card" aria-labelledby="repair-title">
              <h2 id="repair-title">Items Checked In for Repair</h2>
              <div class="body table">
                <table>
                  <thead>
                    <tr>
                      <th scope="col">Item</th>
                      <th scope="col">Issue</th>
                      <th scope="col">Logged By</th>
                      <th scope="col">Date</th>
                      <th scope="col">Status</th>
                    </tr>
                  </thead>
                  <tbody id="tbl-home-repairs"></tbody>
                </table>
              </div>
            </section>
          </div>
        </section>

        <!-- BORROWING -->
        <section id="borrowing" class="screen" aria-labelledby="borrow-title">
          <div class="card" style="margin-bottom:14px">
            <h2 id="borrow-title">Borrowing</h2>
            <div class="body">
              <div class="toolbar">
                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <button class="btn primary" data-open="dlg-new-customer"><span>New Customer</span><span class="spinner" aria-hidden="true"></span></button>
                  <button class="btn" data-open="dlg-returning-borrow"><span>Returning Customer</span><span class="spinner" aria-hidden="true"></span></button>
                </div>
                <div class="search" role="search">
                  <input id="search-borrow" type="text" placeholder="Search Customer, item, ID…" aria-label="Search">
                </div>
              </div>
              <div class="filters" id="filters-borrow">
                <span class="chip active" data-filter="all">Status: All</span>
                <span class="chip" data-filter="Overdue">Overdue</span>
                <span class="chip" data-filter="On Time">On Time</span>
                <span class="chip" data-filter="Returned">Returned</span>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 style="border-bottom:1px solid var(--line); padding:12px 14px; margin:0">Recent Borrowed Items</h2>
            <div class="body table">
              <table>
                <thead>
                  <tr>
                    <th scope="col">Trace #</th>
                    <th scope="col">Item</th>
                    <th scope="col">Customer</th>
                    <th scope="col">ID</th>
                    <th scope="col">Out</th>
                    <th scope="col">Due</th>
                    <th scope="col">Due in</th>
                    <th scope="col">Status</th>
                  </tr>
                </thead>
                <tbody id="tbl-borrow"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- SERVICE LOG -->
        <section id="service" class="screen" aria-labelledby="service-title">
          <div class="card" style="margin-bottom:14px">
            <h2 id="service-title">Service Log</h2>
            <div class="body">
              <div class="toolbar">
                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <button class="btn primary" data-open="dlg-new-service"><span>New Customer</span><span class="spinner" aria-hidden="true"></span></button>
                  <button class="btn" data-open="dlg-returning-service"><span>Returning Customer</span><span class="spinner" aria-hidden="true"></span></button>
                </div>
                <div class="search" role="search"><input id="search-service" type="text" placeholder="Search item, ticket, customer…" aria-label="Search"></div>
              </div>
              <div class="filters" id="filters-service">
                <span class="chip active" data-filter="all">Status: All</span>
                <span class="chip" data-filter="Diagnosing">Diagnosing</span>
                <span class="chip" data-filter="Awaiting Parts">Awaiting Parts</span>
                <span class="chip" data-filter="Ready for Pickup">Ready for Pickup</span>
                <span class="chip" data-filter="Quarantined">Quarantined</span>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 style="border-bottom:1px solid var(--line); padding:12px 14px; margin:0">Recent Service Tickets</h2>
            <div class="body table">
              <table>
                <thead>
                  <tr>
                    <th scope="col">Ticket</th>
                    <th scope="col">Item</th>
                    <th scope="col">Issue</th>
                    <th scope="col">Logged</th>
                    <th scope="col">Assigned</th>
                    <th scope="col">Status</th>
                  </tr>
                </thead>
                <tbody id="tbl-service"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ADMIN -->
        <section id="admin" class="screen" aria-labelledby="admin-title">
          <div class="card" style="margin-bottom:14px">
            <h2 id="admin-title">Admin Options</h2>
            <div class="body">
              <div class="toolbar" style="justify-content:space-between">
                <div style="display:flex; gap:8px; flex-wrap:wrap">
                  <button class="btn" data-open="dlg-create-user"><span>Create User</span></button>
                  <button class="btn" data-open="dlg-delete-user"><span>Delete User</span></button>
                </div>
                <div class="search" role="search"><input id="search-admin" type="text" placeholder="Search user or action…" aria-label="Search"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 style="border-bottom:1px solid var(--line); padding:12px 14px; margin:0">User Action Log</h2>
            <div class="body table">
              <table>
                <thead>
                  <tr>
                    <th scope="col">User</th>
                    <th scope="col">Trace #</th>
                    <th scope="col">Action</th>
                    <th scope="col">Date/Time</th>
                    <th scope="col">Details</th>
                  </tr>
                </thead>
                <tbody id="tbl-admin-log">
                  <tr>
                    <td colspan="5" style="text-align:center; color:var(--muted); padding:18px 12px">Loading recent activity…</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- =============== MODALS =============== -->

  <!-- Quick Help -->
  <dialog id="dlg-help">
    <form method="dialog">
      <div class="modal-hd">
        <strong>Quick Help</strong>
        <button class="btn" value="close">Close</button>
      </div>
      <div class="modal-bd">
        <p class="hint">Use the sidebar to navigate. Rows open details. Filters restrict visible rows. All saves are stubbed unless backend is enabled.</p>
        <ul class="hint">
          <li>Borrowing: New vs Returning handles different required fields.</li>
          <li>Service: Diagnose → Awaiting Parts → Ready for Pickup.</li>
          <li>Admin: Create/Delete Users with role: <em>inventory</em>, <em>order</em>, <em>runner</em>.</li>
        </ul>
      </div>
      <div class="modal-ft">
        <button class="btn primary" value="close">Got it</button>
      </div>
    </form>
  </dialog>

  <!-- New Customer (Borrow or Service) -->
  <dialog id="dlg-new-customer">
    <form method="dialog" id="form-new-customer" novalidate>
      <div class="modal-hd">
        <strong>New Customer</strong>
        <button class="btn" value="close">Close</button>
      </div>
      <div class="modal-bd">
        <div class="form-grid">
          <div>
            <label>First Name</label>
            <input id="nc-first" required>
          </div>
          <div>
            <label>Last Name</label>
            <input id="nc-last" required>
          </div>
          <div>
            <label>School/Faculty ID (optional)</label>
            <input id="nc-schoolid" pattern="\\d{5,10}" placeholder="e.g., 1234567">
            <div class="hint">5–10 digits</div>
          </div>
          <div>
            <label>Phone</label>
            <input id="nc-phone" placeholder="(555) 555-5555" pattern="^\\(\\d{3}\\) \\d{3}-\\d{4}$">
            <div class="hint">Format: (###) ###-####</div>
          </div>
          <div>
            <label>Room</label>
            <input id="nc-room" placeholder="ATLC 102">
          </div>
          <div>
            <label>Instructor</label>
            <input id="nc-instructor" placeholder="e.g., Prof. Smith">
          </div>
          <div class="full">
            <label>Department</label>
            <select id="nc-dept">
              <option value="">(optional)</option>
              <option value="EET">Electrical Engineering Tech</option>
              <option value="ITS">IT / Software</option>
              <option value="MED">Media</option>
            </select>
          </div>

          <div class="full">
            <label>Action Type</label>
            <select id="nc-action">
              <option value="borrow">Borrow Item</option>
              <option value="service">Service Check-in</option>
            </select>
          </div>

          <!-- Borrow specifics -->
          <div class="full" data-bind="borrow">
            <label>Item (name or number)</label>
            <input id="nc-item" placeholder="e.g., Oscilloscope #S7">
          </div>
          <div data-bind="borrow">
            <label>Checkout Notes</label>
            <input id="nc-notes" placeholder="Condition notes / instructions">
          </div>
          <div data-bind="borrow">
            <label>Due (local)</label>
            <input id="nc-due" type="datetime-local">
            <div class="hint">Must be in the future</div>
          </div>

          <!-- Service specifics -->
          <div class="full" data-bind="service" style="display:none">
            <label>Item Being Serviced</label>
            <input id="ns-item" placeholder="e.g., Lab Laptop 15">
          </div>
          <div class="full" data-bind="service" style="display:none">
            <label>Issue Description</label>
            <textarea id="ns-issue" placeholder="Describe the problem…"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-ft">
        <button class="btn" value="close">Cancel</button>
        <button class="btn primary" id="nc-save">
          <span>Save & Continue</span><span class="spinner" aria-hidden="true"></span>
        </button>
      </div>
    </form>
  </dialog>

  <!-- Returning Customer (Borrowing) -->
  <dialog id="dlg-returning-borrow">
    <form method="dialog" id="form-returning-borrow" novalidate>
      <div class="modal-hd">
        <strong>Returning Customer — Borrow</strong>
        <button class="btn" value="close">Close</button>
      </div>
      <div class="modal-bd">
        <div class="form-grid">
          <div>
            <label>School/Faculty ID</label>
            <input id="rb-id" placeholder="or leave blank & use name lookup" pattern="\\d{5,10}">
          </div>
          <div>
            <label>Name Lookup</label>
            <input id="rb-name" placeholder="Jane Doe">
          </div>
          <div class="full">
            <label>Item (name or number)</label>
            <input id="rb-item" required placeholder="e.g., Raspberry Pi 5 or #S7">
          </div>
          <div>
            <label>Due (local)</label>
            <input id="rb-due" type="datetime-local" required>
          </div>
          <div>
            <label>Checkout Notes</label>
            <input id="rb-notes" placeholder="optional">
          </div>
        </div>
        <div class="hint">Provide either ID or Name (one is required).</div>
      </div>
      <div class="modal-ft">
        <button class="btn" value="close">Cancel</button>
        <button class="btn primary" id="rb-save"><span>Checkout</span><span class="spinner" aria-hidden="true"></span></button>
      </div>
    </form>
  </dialog>

  <!-- Returning Customer (Service) -->
  <dialog id="dlg-returning-service">
    <form method="dialog" id="form-returning-service" novalidate>
      <div class="modal-hd">
        <strong>Returning Customer — Service</strong>
        <button class="btn" value="close">Close</button>
      </div>
      <div class="modal-bd">
        <div class="form-grid">
          <div>
            <label>School/Faculty ID</label>
            <input id="rs-id" placeholder="or name lookup" pattern="\\d{5,10}">
          </div>
          <div>
            <label>Name Lookup</label>
            <input id="rs-name" placeholder="Alex Smith">
          </div>
          <div class="full">
            <label>Item Being Serviced</label>
            <input id="rs-item" required placeholder="e.g., Multimeter #A12">
          </div>
          <div class="full">
            <label>Issue</label>
            <textarea id="rs-issue" required placeholder="Describe the problem…"></textarea>
          </div>
        </div>
        <div class="hint">Provide either ID or Name (one is required).</div>
      </div>
      <div class="modal-ft">
        <button class="btn" value="close">Cancel</button>
        <button class="btn primary" id="rs-save"><span>Create Ticket</span><span class="spinner" aria-hidden="true"></span></button>
      </div>
    </form>
  </dialog>

  <!-- Detail viewer (Loan or Ticket) -->
  <dialog id="dlg-detail">
    <form method="dialog" id="form-detail" novalidate>
      <div class="modal-hd">
        <strong id="det-title">Details</strong>
        <button class="btn" value="close">Close</button>
      </div>
      <div class="modal-bd">
        <div class="form-grid">
          <div><label>Type</label><input id="det-type" readonly></div>
          <div><label>ID</label><input id="det-id" readonly></div>
          <div class="full"><label>Primary</label><input id="det-primary" readonly></div>
          <div class="full">
            <label>Status</label>
            <select id="det-status">
              <option>On Time</option>
              <option>Overdue</option>
              <option>Returned</option>
              <option>Diagnosing</option>
              <option>Awaiting Parts</option>
              <option>Ready for Pickup</option>
              <option>Quarantined</option>
            </select>
          </div>
          <div class="full">
            <label>Add Note</label>
            <textarea id="det-note" placeholder="This appends to the log…"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-ft">
        <button class="btn" value="close">Cancel</button>
        <button class="btn primary" id="det-save"><span>Save Changes</span><span class="spinner" aria-hidden="true"></span></button>
      </div>
    </form>
  </dialog>

  <!-- Admin: Create User -->
  <dialog id="dlg-create-user">
    <form method="dialog" id="form-create-user" novalidate>
      <div class="modal-hd">
        <strong>Create User</strong>
        <button class="btn" value="close">Close</button>
      </div>
      <div class="modal-bd">
        <div class="form-grid">
          <div><label>Username</label><input id="cu-username" required></div>
          <div><label>Display Name</label><input id="cu-display" required></div>
          <div class="full">
            <label>Role</label>
            <select id="cu-role" required>
              <option value="">Select…</option>
              <option value="inventory">Inventory</option>
              <option value="order">Order Management</option>
              <option value="runner">Runner</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <div class="hint">Users of this program are “Users.” Borrowing = “Customer”.</div>
      </div>
      <div class="modal-ft">
        <button class="btn" value="close">Cancel</button>
        <button class="btn primary" id="cu-save"><span>Create</span><span class="spinner" aria-hidden="true"></span></button>
      </div>
    </form>
  </dialog>

  <!-- Admin: Delete User -->
  <dialog id="dlg-delete-user">
    <form method="dialog" id="form-delete-user" novalidate>
      <div class="modal-hd">
        <strong>Delete User</strong>
        <button class="btn" value="close">Close</button>
      </div>
      <div class="modal-bd">
        <label>Username</label>
        <input id="du-username" required placeholder="j.wooldridge">
        <p class="hint">This action writes to the audit log with a trace #.</p>
      </div>
      <div class="modal-ft">
        <button class="btn" value="close">Cancel</button>
        <button class="btn primary" id="du-delete"><span>Delete</span><span class="spinner" aria-hidden="true"></span></button>
      </div>
    </form>
  </dialog>

  <script>
    // ====== CONFIG ======
    const USE_BACKEND = true; // flip to true when your API is running
    const API_BASE = "/api";

    // ====== UTIL ======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const setBusy = (btn, busy=true) => btn.setAttribute('aria-busy', busy ? 'true' : 'false');

    /**
     * Mapping of business statuses to the visual pill classes we support.
     * Keeping the relationship centralized avoids subtle mismatches between
     * copy/paste blocks later in the file.
     */
    const STATUS_PILL_CLASS_MAP = {
      "On Time": "ok",
      "Overdue": "overdue",
      "Returned": "returned",
      "Awaiting Parts": "repair",
      "Diagnosing": "diagnosing",
      "Ready for Pickup": "ready",
      "Quarantined": "quarantine"
    };

    /**
     * Table rows use a slightly different set of classes to tint the entire
     * line. That mapping lives here so styling logic can lean on a single
     * source of truth.
     */
    const STATUS_ROW_CLASS_MAP = {
      "Overdue": "is-overdue",
      "Awaiting Parts": "is-awaiting",
      "Diagnosing": "is-diagnosing",
      "Ready for Pickup": "is-ready"
    };
    const ROW_STATUS_CLASSNAMES = Object.values(STATUS_ROW_CLASS_MAP);

    const AUDIT_ACTION_TITLES = {
      BORROWER_CREATE: "Borrower Created",
      ITEM_CREATE: "Item Added",
      CHECKOUT: "Checkout",
      CHECKIN: "Check-in",
      TICKET_CREATE: "Service Ticket Created",
      TICKET_STATUS: "Service Status Update",
      NOTE_ADD: "Note Added"
    };

    const AUDIT_DATETIME_FORMAT = new Intl.DateTimeFormat([], { dateStyle: "medium", timeStyle: "short" });
    const AUDIT_DATE_FORMAT = new Intl.DateTimeFormat([], { dateStyle: "medium" });
    const TABLE_DATETIME_FORMAT = new Intl.DateTimeFormat([], { dateStyle: "medium", timeStyle: "short" });

    function createStatusPill(status){
      const pill = document.createElement("span");
      pill.className = "pill";
      if(status){
        const cls = STATUS_PILL_CLASS_MAP[status];
        if(cls) pill.classList.add(cls);
        pill.textContent = status;
      }else{
        pill.textContent = "";
      }
      return pill;
    }

    function showTableMessage(tbodyId, message, tone="muted"){
      const tbody = document.getElementById(tbodyId);
      if(!tbody) return;
      tbody.textContent = "";
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      const table = tbody.closest("table");
      td.colSpan = table ? table.querySelectorAll("thead th").length : 1;
      td.textContent = message;
      td.style.textAlign = "center";
      td.style.padding = "18px 12px";
      td.style.color = tone === "error" ? "var(--overdue-fg)" : "var(--muted)";
      tr.appendChild(td);
      tbody.appendChild(tr);
    }

    function appendCell(tr, content){
      const td = document.createElement("td");
      if(content instanceof Node){
        td.appendChild(content);
      }else if(content === null || content === undefined || content === ""){
        td.textContent = "—";
      }else{
        td.textContent = content;
      }
      tr.appendChild(td);
      return td;
    }

    function formatLocalDateTime(value){
      if(!value) return "—";
      const dt = new Date(value);
      if(Number.isNaN(dt.getTime())) return "—";
      return TABLE_DATETIME_FORMAT.format(dt);
    }

    function formatDueIn(loan){
      if(!loan) return "—";
      if(loan.status === "Returned" || loan.checkinUtc) return "—";
      if(!loan.dueUtc) return "—";
      const due = new Date(loan.dueUtc);
      if(Number.isNaN(due.getTime())) return "—";
      const diffMs = due.getTime() - Date.now();
      const diffHours = diffMs / 3600000;
      const isNegative = diffHours < 0;
      const absHours = Math.abs(diffHours);
      let value;
      if(absHours >= 48){
        value = Math.round(absHours / 24) + "d";
      }else{
        value = Math.round(absHours) + "h";
      }
      return (isNegative ? "-" : "") + value;
    }

    /**
     * Utility helper to close a dialog by id. Prevents repeated DOM lookups
     * and makes intent clear at the call site.
     */
    function closeDialogById(id){
      const dlg = document.getElementById(id);
      if(dlg) dlg.close();
    }

    // Dialog openers
    $$( "[data-open]" ).forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-open");
        const dlg = document.getElementById(id);
        if (dlg) dlg.showModal();
      });
    });

    // ====== BUTTON FEEDBACK ======
    // add brief "pressed" visual handled via :active (already) + busy spinner while "saving"
    function withAsyncBusy(btn, fn){
      return async (e)=>{
        e.preventDefault();
        setBusy(btn,true);
        try {
          await fn();
        } catch(err){
          // Surface validation/network errors to the user right away.
          console.error(err);
          alert(err?.message || err);
        } finally {
          setBusy(btn,false);
        }
      }
    }

    /**
     * Update both the pill and its parent row so that status changes are
     * reflected consistently in every table. This is used when saving details
     * from the modal.
     */
    function updateRowVisualState(row, status){
      const pill = row.querySelector(".pill");
      if(!pill) return;
      pill.textContent = status;
      pill.className = "pill"; // reset base classes first
      const pillClass = STATUS_PILL_CLASS_MAP[status];
      if(pillClass) pill.classList.add(pillClass);

      row.classList.remove(...ROW_STATUS_CLASSNAMES);
      const rowClass = STATUS_ROW_CLASS_MAP[status];
      if(rowClass) row.classList.add(rowClass);
    }

    // ====== STATUS → ROW COLOR (global) ======
    function applyRowStatusStyles(){
      $$("tbody tr").forEach(tr=>{
        tr.classList.remove(...ROW_STATUS_CLASSNAMES);
        const pill = tr.querySelector(".pill");
        if(!pill) return;
        const text = pill.textContent.trim();
        const cls = STATUS_ROW_CLASS_MAP[text];
        if(cls) tr.classList.add(cls);
      });
    }
    applyRowStatusStyles();

    // ====== NEW CUSTOMER action-type toggle ======
    (function(){
      const dlg = document.getElementById("dlg-new-customer");
      const sel = dlg.querySelector("#nc-action");
      const toggle = () => {
        const isBorrow = sel.value === "borrow";
        dlg.querySelectorAll('[data-bind="borrow"]').forEach(el=> el.style.display = isBorrow ? "" : "none");
        dlg.querySelectorAll('[data-bind="service"]').forEach(el=> el.style.display = isBorrow ? "none" : "");
      };
      sel.addEventListener("change", toggle);
      toggle();
    })();

    // ====== TABLE ROW → DETAILS ======
    const openDetail = (kind, id, primary, status) => {
      const dlg = document.getElementById("dlg-detail");
      $("#det-title").textContent = kind === "loan" ? "Borrow Log Details" : "Service Ticket Details";
      $("#det-type").value = kind === "loan" ? "Loan" : "Service Ticket";
      $("#det-id").value = id;
      $("#det-primary").value = primary || "";
      const sel = $("#det-status");
      Array.from(sel.options).forEach(o => { if (o.text === status) sel.value = o.text; });
      $("#det-note").value = "";
      dlg.showModal();
    };

    function attachRowClicks(scopeId){
      const tbody = document.getElementById(scopeId);
      if (!tbody) return;
      tbody.addEventListener("click", (e)=>{
        const tr = e.target.closest("tr.clickable");
        if (!tr) return;
        const kind = tr.dataset.kind;
        const id   = tr.dataset.id;
        const cells = Array.from(tr.querySelectorAll("td")).map(td=>td.textContent.trim());
        const primary = (kind === "loan") ? `${cells[1]} — ${cells[0]}` : `${cells[1]} — ${cells[0]}`;
        const pill = tr.querySelector(".pill");
        const status = pill ? pill.textContent.trim() : "On Time";
        openDetail(kind, id, primary, status);
      });
    }
    ["tbl-home-out","tbl-home-repairs","tbl-borrow","tbl-service"].forEach(attachRowClicks);

    // ====== FILTERS + SEARCH (client-side) ======
    /**
     * Wire up the filter chips + optional search box to a table body. Each
     * call creates an isolated controller so the Borrowing and Service tables
     * can share the exact same behavior without duplicating the logic.
     */
    function hookFilters(chipsContainerId, tableBodyId, searchInputId){
      const chips = $$("#"+chipsContainerId+" .chip");
      const tbody = $("#"+tableBodyId);
      const searchInput = searchInputId ? $("#"+searchInputId) : null;
      let active = "all";
      const setActive = (val)=>{
        active = val;
        chips.forEach(c=>c.classList.toggle("active", c.dataset.filter===val));
        chips.forEach(c=>{ if(c.dataset.filter==="all") c.classList.toggle("active", val==="all") });
        apply();
      };
      chips.forEach(c=>c.addEventListener("click", ()=> setActive(c.dataset.filter)));
      if(searchInput){
        searchInput.addEventListener("input", apply);
      }
      function apply(){
        const q = (searchInput?.value || "").toLowerCase();
        Array.from(tbody.rows).forEach(tr=>{
          const pill = tr.querySelector(".pill");
          const status = pill ? pill.textContent.trim() : "";
          const matchesStatus = (active==="all") || status===active;
          const text = tr.textContent.toLowerCase();
          const matchesSearch = !q || text.includes(q);
          tr.style.display = (matchesStatus && matchesSearch) ? "" : "none";
        });
      }
      return { apply };
    }
    const borrowFilterController = hookFilters("filters-borrow","tbl-borrow","search-borrow");
    const serviceFilterController = hookFilters("filters-service","tbl-service","search-service");

    // ====== DATA FETCH + RENDERING ======
    async function fetchDashboardStats(){
      const res = await api(`/dashboard-stats`, { method:"GET" });
      return res.json();
    }

    async function fetchLoans(params={}){
      const searchParams = new URLSearchParams();
      if(params.top != null) searchParams.set("top", params.top);
      if(params.status) searchParams.set("status", params.status);
      if(params.search) searchParams.set("search", params.search);
      const qs = searchParams.toString();
      const res = await api(`/loans${qs ? `?${qs}` : ""}`, { method:"GET" });
      const payload = await res.json();
      if(Array.isArray(payload)) return payload;
      if(Array.isArray(payload?.entries)) return payload.entries;
      if(Array.isArray(payload?.data)) return payload.data;
      return [];
    }

    async function fetchServiceTickets(params={}){
      const searchParams = new URLSearchParams();
      if(params.top != null) searchParams.set("top", params.top);
      if(params.status) searchParams.set("status", params.status);
      if(params.search) searchParams.set("search", params.search);
      const qs = searchParams.toString();
      const res = await api(`/service-tickets${qs ? `?${qs}` : ""}`, { method:"GET" });
      const payload = await res.json();
      if(Array.isArray(payload)) return payload;
      if(Array.isArray(payload?.entries)) return payload.entries;
      if(Array.isArray(payload?.data)) return payload.data;
      return [];
    }

    function setStatsLoading(){
      $$('[data-stat]').forEach(el=> el.textContent = "…");
    }

    function setStatsError(){
      $$('[data-stat]').forEach(el=> el.textContent = "—");
    }

    function renderStats(stats){
      if(!stats){
        setStatsError();
        return;
      }
      const map = {
        outNow: stats.outNow ?? stats.checkedOut ?? 0,
        dueToday: stats.dueToday ?? 0,
        repairs: stats.repairs ?? stats.inRepairs ?? 0,
        overdue: stats.overdue ?? 0
      };
      Object.entries(map).forEach(([key,val])=>{
        const el = document.querySelector(`[data-stat="${key}"]`);
        if(el) el.textContent = val;
      });
    }

    function renderLoanRows(tbodyId, loans, mode){
      const tbody = document.getElementById(tbodyId);
      if(!tbody) return;
      tbody.textContent = "";
      if(!Array.isArray(loans) || loans.length === 0){
        const message = mode === "home" ? "No items currently checked out." : "No loans found.";
        showTableMessage(tbodyId, message);
        return;
      }
      loans.forEach(loan=>{
        const tr = document.createElement("tr");
        tr.classList.add("clickable");
        tr.dataset.kind = "loan";
        tr.dataset.id = loan.id ?? loan.traceNumber ?? "";
        if(mode === "home"){
          appendCell(tr, loan.itemName || "—");
          appendCell(tr, loan.borrowerName || "—");
          appendCell(tr, loan.borrowerSchoolId || "—");
          appendCell(tr, loan.room || "—");
          appendCell(tr, formatLocalDateTime(loan.dueUtc));
          appendCell(tr, formatDueIn(loan));
        }else{
          appendCell(tr, loan.traceNumber || loan.id || "—");
          appendCell(tr, loan.itemName || "—");
          appendCell(tr, loan.borrowerName || "—");
          appendCell(tr, loan.borrowerSchoolId || "—");
          appendCell(tr, formatLocalDateTime(loan.checkoutUtc));
          appendCell(tr, formatLocalDateTime(loan.dueUtc));
          appendCell(tr, formatDueIn(loan));
        }
        appendCell(tr, createStatusPill(loan.status || ""));
        tbody.appendChild(tr);
      });
      applyRowStatusStyles();
    }

    function renderTicketRows(tbodyId, tickets, mode){
      const tbody = document.getElementById(tbodyId);
      if(!tbody) return;
      tbody.textContent = "";
      if(!Array.isArray(tickets) || tickets.length === 0){
        const message = mode === "home" ? "No active service tickets." : "No service tickets found.";
        showTableMessage(tbodyId, message);
        return;
      }
      tickets.forEach(ticket=>{
        const tr = document.createElement("tr");
        tr.classList.add("clickable");
        tr.dataset.kind = "ticket";
        tr.dataset.id = ticket.publicId || ticket.id || "";
        if(mode === "home"){
          appendCell(tr, ticket.itemName || "—");
          appendCell(tr, ticket.issue || "—");
          appendCell(tr, ticket.loggedByName || ticket.assignedName || "—");
          appendCell(tr, formatLocalDateTime(ticket.loggedUtc));
        }else{
          appendCell(tr, ticket.publicId || "—");
          appendCell(tr, ticket.itemName || "—");
          appendCell(tr, ticket.issue || "—");
          appendCell(tr, formatLocalDateTime(ticket.loggedUtc));
          appendCell(tr, ticket.assignedName || "—");
        }
        appendCell(tr, createStatusPill(ticket.status || ""));
        tbody.appendChild(tr);
      });
      applyRowStatusStyles();
    }

    async function loadHomeData(){
      try{
        const [stats, loans, tickets] = await Promise.all([
          fetchDashboardStats(),
          fetchLoans({ top: 10 }),
          fetchServiceTickets({ top: 10 })
        ]);
        renderStats(stats);
        const activeLoans = loans.filter(loan=> loan.status !== "Returned").slice(0,5);
        renderLoanRows("tbl-home-out", activeLoans, "home");
        const activeTickets = tickets.filter(ticket=> !["Completed","Cancelled"].includes(ticket.status)).slice(0,5);
        renderTicketRows("tbl-home-repairs", activeTickets, "home");
      }catch(err){
        console.error("Failed to load dashboard data", err);
        setStatsError();
        showTableMessage("tbl-home-out", "Unable to load current checkouts.", "error");
        showTableMessage("tbl-home-repairs", "Unable to load service tickets.", "error");
      }
    }

    async function loadBorrowingData(){
      try{
        const loans = await fetchLoans({ top: 50 });
        renderLoanRows("tbl-borrow", loans, "borrow");
        borrowFilterController?.apply();
      }catch(err){
        console.error("Failed to load loan records", err);
        showTableMessage("tbl-borrow", "Unable to load loans.", "error");
      }
    }

    async function loadServiceData(){
      try{
        const tickets = await fetchServiceTickets({ top: 50 });
        renderTicketRows("tbl-service", tickets, "service");
        serviceFilterController?.apply();
      }catch(err){
        console.error("Failed to load service tickets", err);
        showTableMessage("tbl-service", "Unable to load service tickets.", "error");
      }
    }

    // ====== VALIDATION HELPERS ======
    // Tiny validation helpers shared by multiple forms.
    function must(cond, msg){ if(!cond) throw new Error(msg); }
    function requireOne(valA, valB, msg){ must((valA && valA.trim()) || (valB && valB.trim()), msg); }
    function future(dtStr){ const t = new Date(dtStr); return t > new Date(); }

    // ====== DATA LAYER ======
    /**
     * Lightweight data access wrapper that optionally stubs network calls when
     * USE_BACKEND is false. When a backend is provided this funnels through
     * fetch() and raises if the response is not ok.
     */
    async function api(path, opts={}){
      if(!USE_BACKEND){
        throw new Error("Backend integration is disabled. Enable USE_BACKEND to load live data.");
      }
      const res = await fetch(API_BASE+path, {
        ...opts,
        headers: {
          "Content-Type":"application/json",
          ...(opts.headers || {})
        }
      });
      if(!res.ok){
        let detail;
        try{ detail = await res.text(); }catch{ detail = null; }
        throw new Error(detail || `HTTP ${res.status}`);
      }
      return res;
    }

    async function fetchAuditLog(){
      const res = await api(`/audit-log?top=50`, { method:"GET" });
      const payload = await res.json();
      if(Array.isArray(payload)) return payload;
      if(Array.isArray(payload?.entries)) return payload.entries;
      if(Array.isArray(payload?.data)) return payload.data;
      return [];
    }

    function formatAuditUser(entry){
      const user = entry.username || entry.user || entry.userName || entry.strUsername;
      if(user) return user;
      const first = entry.strFirstName || entry.firstName;
      const last = entry.strLastName || entry.lastName;
      if(first || last) return [first, last].filter(Boolean).join(" ").trim();
      return entry.intLabTechID ? `Tech #${entry.intLabTechID}` : "System";
    }

    function formatAuditTrace(entry){
      const raw = entry.trace || entry.traceId || entry.intTraceID;
      if(raw == null) return "—";
      const num = Number(raw);
      if(Number.isFinite(num)) return num.toString().padStart(6, "0");
      const str = String(raw);
      return str.padStart(Math.max(6, str.length), "0");
    }

    function titleCase(str){
      return str.toLowerCase().replace(/\b\w/g, c=>c.toUpperCase());
    }

    function formatAuditAction(entry){
      const code = (entry.action || entry.strAction || "").toString().trim();
      if(!code) return "—";
      return AUDIT_ACTION_TITLES[code] || titleCase(code.replace(/_/g, " "));
    }

    function safeDate(value){
      const d = new Date(value);
      return Number.isNaN(d.getTime()) ? null : d;
    }

    function formatAuditDateTime(entry){
      const raw = entry.dtmEventLocal || entry.dtmEventUTC || entry.timestamp || entry.dateTime || entry.date;
      if(!raw) return "—";
      const dt = safeDate(raw);
      return dt ? AUDIT_DATETIME_FORMAT.format(dt) : raw;
    }

    function formatDetailDate(raw){
      if(!raw) return null;
      const dt = safeDate(raw);
      return dt ? AUDIT_DATE_FORMAT.format(dt) : null;
    }

    function humanizeKey(key){
      return key
        .replace(/([A-Z])/g, " $1")
        .replace(/_/g, " ")
        .replace(/\s+/g, " ")
        .trim()
        .replace(/\b\w/g, c=>c.toUpperCase());
    }

    function summarizeDetail(obj){
      if(!obj || typeof obj !== "object") return "";
      if(Array.isArray(obj)){
        return obj.map(summarizeDetail).filter(Boolean).join("; ");
      }
      const item = obj.item || obj.itemName;
      const borrower = obj.borrower || obj.customer || obj.customerName;
      if(item){
        const parts = [item];
        if(obj.itemNumber) parts[0] += ` (${obj.itemNumber})`;
        if(borrower){
          let borrowerTxt = borrower;
          if(obj.schoolId || obj.schoolID || obj.schoolIdNumber){
            borrowerTxt += ` (${obj.schoolId || obj.schoolID || obj.schoolIdNumber})`;
          }
          parts.push(`→ ${borrowerTxt}`);
        }
        const due = formatDetailDate(obj.dueLocal || obj.dueUTC);
        if(due) parts.push(`Due ${due}`);
        if(obj.checkoutUTC){
          const checkout = formatDetailDate(obj.checkoutUTC);
          if(checkout) parts.push(`Checked Out ${checkout}`);
        }
        if(obj.checkinUTC){
          const checkin = formatDetailDate(obj.checkinUTC);
          if(checkin) parts.push(`Checked In ${checkin}`);
        }
        return parts.join(" · ");
      }
      if(obj.publicId || obj.publicTicketID){
        const ticket = obj.publicId || obj.publicTicketID;
        return obj.status ? `${ticket} — ${obj.status}` : ticket;
      }
      if(Object.prototype.hasOwnProperty.call(obj, "note")){
        return String(obj.note);
      }
      return Object.entries(obj).map(([k,v])=>`${humanizeKey(k)}: ${v}`).join("; ");
    }

    function formatAuditDetails(entry){
      const raw = entry.details ?? entry.strDetails ?? entry.detail ?? entry.message;
      if(raw == null) return "";
      if(typeof raw === "object"){
        return summarizeDetail(raw);
      }
      const text = raw.toString().trim();
      if(!text) return "";
      try{
        const parsed = JSON.parse(text);
        return summarizeDetail(parsed) || text;
      }catch{
        return text;
      }
    }

    function renderAuditLog(entries){
      const tbody = document.getElementById("tbl-admin-log");
      if(!tbody) return;
      tbody.textContent = "";
      if(!entries.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.style.textAlign = "center";
        td.style.color = "var(--muted)";
        td.style.padding = "18px 12px";
        td.textContent = "No recent activity.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      entries.forEach(entry=>{
        const tr = document.createElement("tr");
        const cells = [
          formatAuditUser(entry),
          formatAuditTrace(entry),
          formatAuditAction(entry),
          formatAuditDateTime(entry),
          formatAuditDetails(entry)
        ];
        cells.forEach(val=>{
          const td = document.createElement("td");
          td.textContent = val || "";
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    async function loadAuditLog(){
      const tbody = document.getElementById("tbl-admin-log");
      if(!tbody) return;
      try{
        const entries = await fetchAuditLog();
        renderAuditLog(entries);
      }catch(err){
        console.error("Failed to load audit log", err);
        tbody.textContent = "";
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.style.textAlign = "center";
        td.style.color = "var(--overdue-fg)";
        td.style.padding = "18px 12px";
        td.textContent = "Unable to load audit log.";
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    // ====== SAVE HANDLERS ======
    // New Customer (borrow/service)
    $("#nc-save").addEventListener("click", withAsyncBusy($("#nc-save"), async ()=>{
      const f = $("#form-new-customer");
      const first = $("#nc-first").value.trim();
      const last  = $("#nc-last").value.trim();
      const action= $("#nc-action").value;
      must(first && last, "First/Last required.");
      if(action==="borrow"){
        must($("#nc-item").value.trim(), "Item required.");
        must($("#nc-due").value, "Due required.");
        must(future($("#nc-due").value), "Due must be in the future.");
      }else{
        must($("#ns-item").value.trim(), "Service item required.");
        must($("#ns-issue").value.trim(), "Issue required.");
      }
      // optional patterns
      const id = $("#nc-schoolid").value;
      if(id && !/^\d{5,10}$/.test(id)) throw new Error("ID must be 5–10 digits.");
      const phone = $("#nc-phone").value;
      if(phone && !/^\(\d{3}\) \d{3}-\d{4}$/.test(phone)) throw new Error("Phone format: (###) ###-####");

      // create customer then action
      await api("/customers", { method:"POST", body: JSON.stringify({
        first,last, schoolId:id||null, phone:phone||null,
        room:$("#nc-room").value||null, instructor:$("#nc-instructor").value||null,
        dept:$("#nc-dept").value||null
      })});
      if(action==="borrow"){
        await api("/loans/checkout", { method:"POST", body: JSON.stringify({
          customerName:`${first} ${last}`, item:$("#nc-item").value.trim(),
          dueLocal: $("#nc-due").value, notes: $("#nc-notes").value||null
        })});
      }else{
        await api("/tickets", { method:"POST", body: JSON.stringify({
          customerName:`${first} ${last}`, item:$("#ns-item").value.trim(),
          issue: $("#ns-issue").value.trim()
        })});
      }
      closeDialogById("dlg-new-customer");
      alert("Saved.");
    }));

    // Returning Borrow
    $("#rb-save").addEventListener("click", withAsyncBusy($("#rb-save"), async ()=>{
      const id = $("#rb-id").value.trim();
      const name = $("#rb-name").value.trim();
      requireOne(id,name,"Provide either School/Faculty ID or Name.");
      must($("#rb-item").value.trim(), "Item required.");
      must($("#rb-due").value, "Due required.");
      must(future($("#rb-due").value), "Due must be in the future.");

      await api("/loans/checkout", { method:"POST", body: JSON.stringify({
        schoolId:id||null, name:name||null, item:$("#rb-item").value.trim(),
        dueLocal: $("#rb-due").value, notes: $("#rb-notes").value||null
      })});
      closeDialogById("dlg-returning-borrow");
      alert("Checkout complete.");
    }));

    // Returning Service
    $("#rs-save").addEventListener("click", withAsyncBusy($("#rs-save"), async ()=>{
      const id = $("#rs-id").value.trim();
      const name = $("#rs-name").value.trim();
      requireOne(id,name,"Provide either School/Faculty ID or Name.");
      must($("#rs-item").value.trim(), "Item required.");
      must($("#rs-issue").value.trim(), "Issue required.");

      await api("/tickets", { method:"POST", body: JSON.stringify({
        schoolId:id||null, name:name||null,
        item: $("#rs-item").value.trim(), issue: $("#rs-issue").value.trim()
      })});
      closeDialogById("dlg-returning-service");
      alert("Service ticket created.");
    }));

    // Detail Save (status + note)
    $("#det-save").addEventListener("click", withAsyncBusy($("#det-save"), async ()=>{
      const id = $("#det-id").value;
      const type = $("#det-type").value; // Loan / Service Ticket
      const status = $("#det-status").value;
      const note = $("#det-note").value.trim() || null;

      await api("/status", { method:"POST", body: JSON.stringify({ id, type, status, note }) });

      // Update row status visually if present in current lists
      const row = document.querySelector(`[data-id="${CSS.escape(id)}"]`);
      if(row){
        updateRowVisualState(row, status);
      }

      closeDialogById("dlg-detail");
      alert("Saved status & note.");
    }));

    // Admin: Create User
    $("#cu-save").addEventListener("click", withAsyncBusy($("#cu-save"), async ()=>{
      const u = $("#cu-username").value.trim();
      const d = $("#cu-display").value.trim();
      const r = $("#cu-role").value;
      must(u && d && r, "All fields required.");
      await api("/users", { method:"POST", body: JSON.stringify({ username:u, display:d, role:r })});
      closeDialogById("dlg-create-user");
      alert("User created.");
    }));

    // Admin: Delete User
    $("#du-delete").addEventListener("click", withAsyncBusy($("#du-delete"), async ()=>{
      const u = $("#du-username").value.trim();
      must(u, "Username required.");
      await api(`/users/${encodeURIComponent(u)}`, { method:"DELETE" });
      closeDialogById("dlg-delete-user");
      alert("User deleted.");
    }));

    setStatsLoading();
    showTableMessage("tbl-home-out", "Loading current checkouts…");
    showTableMessage("tbl-home-repairs", "Loading service tickets…");
    showTableMessage("tbl-borrow", "Loading recent loans…");
    showTableMessage("tbl-service", "Loading service tickets…");
    showTableMessage("tbl-admin-log", "Loading activity…");

    loadHomeData();
    loadBorrowingData();
    loadServiceData();
    loadAuditLog();

    // keep row colors consistent if DOM changes later
    // Watch for table updates (e.g., new rows inserted) so the status tinting
    // stays in sync even when other scripts mutate the DOM in the future.
    const mo = new MutationObserver(applyRowStatusStyles);
    mo.observe(document.body, { subtree:true, childList:true });
  </script>
</body>
</html>